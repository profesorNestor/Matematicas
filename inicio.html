<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuantumCalc: Calculadora Simbólica</title>
    
    <!-- 📚 LIBRERÍAS EXTERNAS 📚 -->
    <!-- Se cargan las librerías necesarias para el cálculo simbólico, graficación y renderizado de fórmulas. -->
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/nerdamer.core.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/Calculus.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/Algebra.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/Solve.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/Extra.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>

    <!-- MathJax para renderizar fórmulas matemáticas (LaTeX) -->
    <script>
        MathJax = {
          tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']],
            displayMath: [['$$', '$$'], ['\\[', '\\]']]
          },
          svg: {
            fontCache: 'global'
          }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

    <!-- 💅 ESTILOS CSS DEL DISEÑO ORIGINAL 💅 -->
    <!-- Se mantienen intactos todos tus estilos originales para preservar el excelente diseño visual. -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap');

        :root {
            --bg-color: #2c3e50;
            --container-color: #34495e;
            --screen-bg: #1d2b38;
            --text-color: #ecf0f1;
            --accent-color-1: #3498db;
            --accent-color-2: #9b59b6;
            --op-key-color: #f39c12;
            --clear-key-color: #e74c3c;
            --eq-key-color: #1abc9c;
            --num-key-bg: #4a637c;
            --func-key-bg: #5f7b97;
            --adv-func-key-bg: #3e566d;
            --modal-bg: rgba(30, 41, 59, 0.8);
            --modal-content-bg: #2c3e50;
            --shadow-light: rgba(255, 255, 255, 0.1);
            --shadow-dark: rgba(0, 0, 0, 0.4);
            --error-color: #e74c3c;
            --special-func-bg: #27ae60;
        }
        
        body.theme-matrix { --bg-color: #0D0208; --container-color: #1a1a1a; --screen-bg: #000000; --text-color: #00FF41; --accent-color-1: #00FF41; --accent-color-2: #39FF14; --op-key-color: #00b32d; --clear-key-color: #c0392b; --eq-key-color: #008f39; --num-key-bg: #111; --func-key-bg: #222; --adv-func-key-bg: #000; --special-func-bg: #00FF41; }
        body.theme-solar { --bg-color: #f4f6f7; --container-color: #ffffff; --screen-bg: #e5e8e8; --text-color: #212f3c; --accent-color-1: #2980b9; --accent-color-2: #8e44ad; --op-key-color: #f39c12; --clear-key-color: #e74c3c; --eq-key-color: #16a085; --num-key-bg: #ecf0f1; --func-key-bg: #d5dbdb; --adv-func-key-bg: #bdc3c7; --shadow-light: rgba(255, 255, 255, 0.8); --shadow-dark: rgba(0, 0, 0, 0.1); --special-func-bg: #27ae60; }
        body.theme-ruby { --bg-color: #4A0404; --container-color: #780206; --screen-bg: #330101; --text-color: #f5b7b1; --accent-color-1: #E84A5F; --accent-color-2: #FF847C; --op-key-color: #c0392b; --clear-key-color: #922b21; --eq-key-color: #e74c3c; --num-key-bg: #641e16; --func-key-bg: #943126; --adv-func-key-bg: #512e2e; --special-func-bg: #e74c3c; }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-color); color: var(--text-color); display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; padding: 1rem; transition: background-color 0.3s, color 0.3s; }
        .calculator-body { width: 100%; max-width: 500px; background-color: var(--container-color); border-radius: 20px; padding: 1.5rem; box-shadow: 10px 10px 30px var(--shadow-dark), -10px -10px 30px var(--shadow-light); }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; position: relative; }
        header h1 { font-size: 1.6rem; font-weight: 600; background: linear-gradient(45deg, var(--accent-color-1), var(--accent-color-2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header-controls { display: flex; align-items: center; gap: 1rem; }
        .angle-selector { display: flex; background-color: var(--screen-bg); border-radius: 8px; overflow: hidden; }
        .angle-btn { background: none; border: none; color: var(--text-color); padding: 0.3rem 0.6rem; cursor: pointer; font-weight: 500; font-size: 0.8rem; transition: background-color 0.3s; }
        .angle-btn.active { background-color: var(--accent-color-1); }
        .screen { background-color: var(--screen-bg); border-radius: 10px; padding: 1rem; margin-bottom: 1.5rem; }
        .input-display { width: 100%; font-family: 'Poppins', monospace; font-size: 2rem; background: transparent; border: none; color: var(--text-color); text-align: right; outline: none; }
        .output-section { min-height: 70px; padding-top: 1rem; border-top: 1px solid var(--accent-color-1); display: flex; justify-content: center; align-items: center; }
        #output { font-size: 1.5rem; text-align: center; overflow-x: auto; word-wrap: break-word; }
        #error-message { color: var(--error-color); text-align: center; font-weight: 500; display: none; }
        .keypad-container { display: flex; flex-direction: column; gap: 1rem; }
        .function-pad, .number-pad { display: grid; gap: 0.75rem; }
        .function-pad { grid-template-columns: repeat(6, 1fr); }
        .number-pad { grid-template-columns: repeat(4, 1fr); }
        .keypad-button { padding: 0.8rem 0; font-size: 1rem; font-weight: 500; color: var(--text-color); border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; box-shadow: 3px 3px 6px var(--shadow-dark), -3px -3px 6px var(--shadow-light); display: flex; justify-content: center; align-items: center; background-color: var(--func-key-bg); }
        .keypad-button:active { transform: scale(0.95); box-shadow: inset 2px 2px 5px var(--shadow-dark); }
        .keypad-button sup { font-size: 0.7em; position: relative; top: -0.5em; }
        .num-key { background-color: var(--num-key-bg); }
        .op-key { background-color: var(--op-key-color); }
        .clear-key { background-color: var(--clear-key-color); }
        .equals-key { background: linear-gradient(145deg, var(--accent-color-1), var(--accent-color-2)); }
        .eq-key { background-color: var(--eq-key-color); }
        .special-func-key { background-color: var(--special-func-bg); font-weight: 600; }
        
        #adv-controls-toggle { cursor: pointer; text-align: center; padding: 0.5rem; background-color: var(--adv-func-key-bg); border-radius: 8px; margin-top: 1rem; transition: background-color 0.2s; }
        #adv-controls-toggle:hover { background-color: #4e6a85; }
        #advanced-controls-panel { display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--accent-color-1); }
        .adv-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 0.75rem; }
        .adv-button { background-color: var(--func-key-bg); padding: 0.6rem; font-size: 0.8rem; }
        
        #menu-toggle { cursor: pointer; z-index: 1001; width: 30px; height: 25px; display: flex; flex-direction: column; justify-content: space-between; }
        #menu-toggle .bar { width: 100%; height: 3px; background-color: var(--text-color); border-radius: 3px; transition: all 0.3s ease; }
        #main-menu { position: absolute; top: 40px; right: 0; background-color: var(--container-color); backdrop-filter: blur(5px); border-radius: 10px; list-style: none; padding: 0.5rem; box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: none; z-index: 1000; }
        #main-menu.active { display: block; }
        #main-menu li { padding: 0.5rem 1rem; }
        #main-menu a, #main-menu .theme-title { color: var(--text-color); text-decoration: none; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: color 0.2s ease; }
        .theme-selector { display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; padding-top: 0.5rem; }
        .theme-btn { width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--text-color); cursor: pointer; }

        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: var(--modal-bg); backdrop-filter: blur(5px); align-items: center; justify-content: center; padding: 1rem;}
        .modal-content { background-color: var(--modal-content-bg); margin: 5% auto; padding: 20px; border: 1px solid var(--accent-color-1); border-radius: 15px; width: 90%; max-width: 600px; animation: modal-appear 0.3s ease-out; }
        @keyframes modal-appear { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #4a637c; padding-bottom: 0.5rem; margin-bottom: 1rem; }
        .modal-title { font-size: 1.25rem; font-weight: 600; }
        .modal-close { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.2s; }
        .modal-close:hover { color: white; }
        .input-group { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem; }
        .input-group label { font-size: 0.9rem; color: #cbd5e1; }
        .input-styled { background-color: var(--screen-bg); border: 1px solid #4a637c; color: var(--text-color); border-radius: 5px; padding: 0.5rem; width: 100%; }
        .matrix-grid { display: grid; gap: 0.5rem; margin: 0 auto; }
        .matrix-grid input { text-align: center; }
        .modal-grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        .modal-grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
        .modal-result { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #4a637c; text-align: center; font-size: 1.1rem; min-height: 40px; overflow-x: auto;}
        .mini-keypad { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
        .mini-keypad button { flex-grow: 1; }
        .mb-4 { margin-bottom: 1rem; }
        .mt-4 { margin-top: 1rem; }
        .text-red-400 { color: var(--error-color); }
        .text-center { text-align: center; }
        
        input[type="checkbox"] { margin-right: 0.5rem; cursor: pointer; }
        .modal-result p { margin: 0.5rem 0; }

        /* Estilos para el nuevo pie de página */
        .ultramodern-footer {
            text-align: center;
            margin-top: 2rem;
            padding: 1rem;
            width: 100%;
            max-width: 500px;
            font-size: 0.85rem;
            color: var(--text-color);
            opacity: 0.7;
        }
        .ultramodern-footer .authors {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }
        .ultramodern-footer .separator {
            font-weight: 300;
        }
    </style>
</head>
<body>
    <div class="calculator-body">
        <header>
            <h1>QuantumCalc</h1>
            <div class="header-controls">
                <div id="angle-mode-selector" class="angle-selector">
                    <button class="angle-btn active" data-mode="deg">D</button>
                    <button class="angle-btn" data-mode="rad">R</button>
                    <button class="angle-btn" data-mode="grad">G</button>
                </div>
                 <div id="menu-toggle"><div class="bar"></div><div class="bar"></div><div class="bar"></div></div>
            </div>
             <nav><ul id="main-menu">
                <li><a id="help-btn">Ayuda</a></li>
                <li class="theme-title">Temas</li>
                <li class="theme-selector">
                    <button class="theme-btn" data-theme="default" style="background-color: #34495e;"></button>
                    <button class="theme-btn" data-theme="theme-matrix" style="background-color: #00FF41;"></button>
                    <button class="theme-btn" data-theme="theme-solar" style="background-color: #f1c40f;"></button>
                    <button class="theme-btn" data-theme="theme-ruby" style="background-color: #c0392b;"></button>
                </li>
            </ul></nav>
        </header>

        <main>
            <section class="screen">
                <input type="text" id="function-input" class="input-display" placeholder="0">
                <div class="output-section">
                    <div id="output"></div>
                    <p id="error-message"></p>
                </div>
            </section>
            
            <div class="keypad-container">
                 <div class="function-pad">
                    <button class="keypad-button func-key" data-value="sin(">sin</button>
                    <button class="keypad-button func-key" data-value="cos(">cos</button>
                    <button class="keypad-button func-key" data-value="tan(">tan</button>
                    <button class="keypad-button func-key" data-value="asin(">sin⁻¹</button>
                    <button class="keypad-button func-key" data-value="acos(">cos⁻¹</button>
                    <button class="keypad-button func-key" data-value="atan(">tan⁻¹</button>
                    <button class="keypad-button func-key" data-value="sinh(">sinh</button>
                    <button class="keypad-button func-key" data-value="cosh(">cosh</button>
                    <button class="keypad-button func-key" data-value="tanh(">tanh</button>
                    <button class="keypad-button func-key" data-value="asinh(">asinh</button>
                    <button class="keypad-button func-key" data-value="acosh(">acosh</button>
                    <button class="keypad-button func-key" data-value="atanh(">atanh</button>
                    <button class="keypad-button func-key" data-value="log10(">log₁₀</button>
                    <button class="keypad-button func-key" data-value="ln(">ln</button>
                    <button class="keypad-button func-key" data-value="^">x<sup>y</sup></button>
                    <button class="keypad-button func-key" data-value="sqrt(">√</button>
                    <button class="keypad-button func-key" data-value="pi">π</button>
                    <button class="keypad-button func-key" data-value="e">e</button>
                    <button class="keypad-button func-key" data-value="(">(</button>
                    <button class="keypad-button func-key" data-value=")">)</button>
                    <button class="keypad-button func-key" data-value="abs(">abs</button>
                    <button class="keypad-button special-func-key" data-modal-target="integral-modal">∫</button>
                    <button class="keypad-button special-func-key" data-modal-target="derivative-modal">∂</button>
                    <button class="keypad-button special-func-key" data-modal-target="limit-modal">lim</button>
                </div>
                <div class="number-pad">
                    <button class="keypad-button clear-key" data-action="AC">AC</button>
                    <button class="keypad-button clear-key" data-action="DEL">DEL</button>
                    <button class="keypad-button func-key" data-value="x">x</button>
                    <button class="keypad-button op-key" data-value="/">÷</button>
                    <button class="keypad-button num-key" data-value="7">7</button>
                    <button class="keypad-button num-key" data-value="8">8</button>
                    <button class="keypad-button num-key" data-value="9">9</button>
                    <button class="keypad-button op-key" data-value="*">×</button>
                    <button class="keypad-button num-key" data-value="4">4</button>
                    <button class="keypad-button num-key" data-value="5">5</button>
                    <button class="keypad-button num-key" data-value="6">6</button>
                    <button class="keypad-button op-key" data-value="-">−</button>
                    <button class="keypad-button num-key" data-value="1">1</button>
                    <button class="keypad-button num-key" data-value="2">2</button>
                    <button class="keypad-button num-key" data-value="3">3</button>
                    <button class="keypad-button op-key" data-value="+">+</button>
                    <button class="keypad-button num-key" data-value="0">0</button>
                    <button class="keypad-button num-key" data-value=".">.</button>
                    <button class="keypad-button func-key" data-action="S2D">S↔D</button>
                    <button class="keypad-button special-func-key" data-modal-target="sum-modal">Σ</button>
                    <button class="keypad-button equals-key" data-action="EVAL" style="grid-column: span 4;">=</button>
                </div>
            </div>

            <div id="adv-controls-toggle" class="adv-controls-toggle">▼ Funciones Avanzadas ▼</div>
            <section id="advanced-controls-panel">
                <div class="adv-grid">
                    <button class="adv-button keypad-button" data-modal-target="algebra-modal">Álgebra</button>
                    <button class="adv-button keypad-button" data-modal-target="combinatorics-modal">Combinatoria</button>
                    <button class="adv-button keypad-button" data-modal-target="equations-modal">Sist. Ecuaciones</button>
                    <button class="adv-button keypad-button" data-modal-target="matrix-modal">Matrices</button>
                    <button class="adv-button keypad-button" data-modal-target="edo-modal">EDO</button>
                    <button class="adv-button keypad-button" data-modal-target="laplace-modal">Laplace</button>
                    <button class="adv-button keypad-button" data-modal-target="convert-modal">Conversiones</button>
                    <button class="adv-button keypad-button" data-modal-target="graph-modal">Graficar</button>
                </div>
            </section>
        </main>
    </div>

    <footer class="ultramodern-footer">
        <div class="authors">
            <span>Autor: Msc. Néstor Fabio Montoya</span>
            <span class="separator">&</span>
            <span>Gemini AI</span>
        </div>
    </footer>

    <!-- 🏛️ INICIO DE LOS MODALES 🏛️ -->

    <!-- Modal de Ayuda -->
    <div id="help-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Ayuda y Consejos</h2>
                <span class="modal-close" data-modal-target="help-modal">&times;</span>
            </div>
            <div style="font-size: 0.9rem; line-height: 1.6;">
                <p><strong>Calculadora Científica Avanzada</strong></p>
                <p class="mt-4"><strong>✨ CARACTERÍSTICAS PRINCIPALES:</strong></p>
                <ul style="list-style-position: inside; padding-left: 1rem;">
                    <li>Operaciones básicas y trigonométricas</li>
                    <li>Cálculo simbólico con visualización LaTeX</li>
                    <li>Derivadas e integrales (botones <strong>∂</strong> y <strong>∫</strong>)</li>
                    <li>Límites y sumatorias (botones <strong>lim</strong> y <strong>Σ</strong>)</li>
                    <li>Álgebra: factorización, expansión, resolver ecuaciones</li>
                    <li>Matrices: determinante e inversa</li>
                    <li>Ecuaciones diferenciales ordinarias (EDO)</li>
                    <li>Graficador de funciones interactivo</li>
                    <li>Transformada de Laplace</li>
                </ul>
                <p class="mt-4"><strong>💡 CONSEJOS:</strong></p>
                <ul style="list-style-position: inside; padding-left: 1rem;">
                    <li>Use los botones verdes para acceso rápido a cálculo.</li>
                    <li>Presione <strong>Enter</strong> en el teclado para calcular.</li>
                    <li>Presione <strong>Escape</strong> para limpiar la pantalla.</li>
                    <li>Use el botón <strong>S↔D</strong> para cambiar entre formato simbólico y decimal.</li>
                    <li>Los ángulos se pueden cambiar entre grados (<strong>D</strong>), radianes (<strong>R</strong>) y gradianes (<strong>G</strong>).</li>
                    <li>Puede escribir funciones directamente, p. ej., <code>solve(x^2-4=0, x)</code>.</li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Modal de Álgebra -->
    <div id="algebra-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2 class="modal-title">Álgebra y Aritmética</h2><span class="modal-close" data-modal-target="algebra-modal">&times;</span></div>
            <select id="algebra-op" class="input-styled mb-4">
                <option value="factor">Factorizar</option>
                <option value="expand">Expandir</option>
                <option value="solve">Resolver Ecuación</option>
                <option value="divisors">Divisores</option>
                <option value="gcd">MCD</option>
                <option value="lcm">MCM</option>
            </select>
            <div class="input-group">
                <label for="algebra-input">Expresión (ej: x^2-1=0) o Números (ej: 12, 18)</label>
                <input id="algebra-input" type="text" class="input-styled" placeholder="e.g., x^2-4=0 or 12, 18">
            </div>
            <button id="algebra-calc-btn" class="keypad-button equals-key" style="width:100%">Calcular</button>
            <div id="algebra-result" class="modal-result"></div>
        </div>
    </div>

    <!-- Modal de Laplace -->
    <div id="laplace-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2 class="modal-title">Calcular Transformada de Laplace</h2><span class="modal-close" data-modal-target="laplace-modal">&times;</span></div>
            <div class="input-group">
                <label>Función f(t)</label>
                <input id="laplace-func" type="text" class="input-styled" placeholder="e.g., t^2 + sin(t)">
            </div>
            <div class="modal-grid-2">
                <div class="input-group">
                    <label>Variable Original</label>
                    <input type="text" class="input-styled" value="t" disabled>
                </div>
                <div class="input-group">
                    <label>Variable Transformada</label>
                    <input type="text" class="input-styled" value="s" disabled>
                </div>
            </div>
            <button id="laplace-calc-btn" class="keypad-button equals-key" style="width:100%">Calcular</button>
            <div id="laplace-result" class="modal-result"></div>
        </div>
    </div>

    <!-- Modal de Conversiones (NUEVO) -->
    <div id="convert-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2 class="modal-title">Conversor de Unidades</h2><span class="modal-close" data-modal-target="convert-modal">&times;</span></div>
            
            <h3 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; border-bottom: 1px solid var(--num-key-bg); padding-bottom: 0.5rem;">Conversión Angular</h3>
            <div class="modal-grid-3">
                <div class="input-group">
                    <label for="conv-degrees">Grados (°)</label>
                    <input type="number" id="conv-degrees" class="input-styled" oninput="convertAngles('degrees')">
                </div>
                <div class="input-group">
                    <label for="conv-radians">Radianes (rad)</label>
                    <input type="number" id="conv-radians" class="input-styled" oninput="convertAngles('radians')">
                </div>
                <div class="input-group">
                    <label for="conv-gradians">Gradianes (grad)</label>
                    <input type="number" id="conv-gradians" class="input-styled" oninput="convertAngles('gradians')">
                </div>
            </div>

            <h3 style="font-size: 1.1rem; font-weight: 600; margin-top: 2rem; margin-bottom: 1rem; border-bottom: 1px solid var(--num-key-bg); padding-bottom: 0.5rem;">Conversión de Coordenadas</h3>
            <div class="modal-grid-2">
                <div>
                    <label style="font-weight: 500;">Rectangulares</label>
                    <div class="input-group mt-4">
                        <label for="coord-x">Valor X</label>
                        <input type="number" id="coord-x" class="input-styled" oninput="convertCoords('rect')">
                    </div>
                    <div class="input-group">
                        <label for="coord-y">Valor Y</label>
                        <input type="number" id="coord-y" class="input-styled" oninput="convertCoords('rect')">
                    </div>
                </div>
                <div>
                    <label style="font-weight: 500;">Polares</label>
                    <div class="input-group mt-4">
                        <label for="coord-r">Radio (r)</label>
                        <input type="number" id="coord-r" class="input-styled" oninput="convertCoords('polar')">
                    </div>
                    <div class="input-group">
                        <label for="coord-theta">Ángulo θ (°)</label>
                        <input type="number" id="coord-theta" class="input-styled" oninput="convertCoords('polar')">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Límites -->
    <div id="limit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2 class="modal-title">Calcular Límite</h2><span class="modal-close" data-modal-target="limit-modal">&times;</span></div>
            <div class="input-group">
                <label>Función f(x)</label>
                <input id="limit-func" type="text" class="input-styled" placeholder="sin(x)/x">
            </div>
            <div class="modal-grid-2">
                <div class="input-group">
                    <label>Variable</label>
                    <input id="limit-var" type="text" class="input-styled" value="x">
                </div>
                <div class="input-group">
                    <label>Tiende a</label>
                    <input id="limit-point" type="text" class="input-styled" placeholder="0">
                </div>
            </div>
            <button id="limit-calc-btn" class="keypad-button equals-key" style="width:100%">Calcular</button>
            <div id="limit-result" class="modal-result"></div>
        </div>
    </div>

    <!-- Modal de Sumatorias -->
    <div id="sum-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2 class="modal-title">Calcular Sumatoria</h2><span class="modal-close" data-modal-target="sum-modal">&times;</span></div>
            <div class="input-group">
                <label>Expresión f(n)</label>
                <input id="sum-func" type="text" class="input-styled" placeholder="n^2">
            </div>
            <div class="modal-grid-3">
                <div class="input-group">
                    <label>Variable</label>
                    <input id="sum-var" type="text" class="input-styled" value="n">
                </div>
                <div class="input-group">
                    <label>Desde</label>
                    <input id="sum-from" type="text" class="input-styled" placeholder="1">
                </div>
                <div class="input-group">
                    <label>Hasta</label>
                    <input id="sum-to" type="text" class="input-styled" placeholder="10">
                </div>
            </div>
            <button id="sum-calc-btn" class="keypad-button equals-key" style="width:100%">Calcular</button>
            <div id="sum-result" class="modal-result"></div>
        </div>
    </div>

    <!-- Modal de Derivadas -->
    <div id="derivative-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2 class="modal-title">Calcular Derivada</h2><span class="modal-close" data-modal-target="derivative-modal">&times;</span></div>
            <div class="input-group">
                <label>Función f(x)</label>
                <input id="derivative-func" type="text" class="input-styled" placeholder="x^2 + sin(x)">
            </div>
            <div class="modal-grid-2">
                <div class="input-group">
                    <label>Variable</label>
                    <input id="derivative-var" type="text" class="input-styled" value="x">
                </div>
                <div class="input-group">
                    <label>Orden (opcional)</label>
                    <input id="derivative-order" type="number" class="input-styled" value="1" min="1">
                </div>
            </div>
            <div class="input-group">
                <label>
                    <input type="checkbox" id="derivative-evaluate"> Evaluar en punto
                </label>
                <input id="derivative-point" type="text" class="input-styled" placeholder="x = " style="display:none;">
            </div>
            <button id="derivative-calc-btn" class="keypad-button equals-key" style="width:100%">Calcular</button>
            <div id="derivative-result" class="modal-result"></div>
        </div>
    </div>

    <!-- Modal de Integrales -->
    <div id="integral-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2 class="modal-title">Calcular Integral</h2><span class="modal-close" data-modal-target="integral-modal">&times;</span></div>
            <div class="input-group">
                <label>Función f(x)</label>
                <input id="integral-func" type="text" class="input-styled" placeholder="x^2 + sin(x)">
            </div>
            <div class="input-group">
                <label>Variable de integración</label>
                <input id="integral-var" type="text" class="input-styled" value="x">
            </div>
            <div class="input-group">
                <label>
                    <input type="checkbox" id="integral-definite"> Integral definida
                </label>
            </div>
            <div id="integral-limits" style="display:none;" class="modal-grid-2">
                <div class="input-group">
                    <label>Límite inferior</label>
                    <input id="integral-lower" type="text" class="input-styled" placeholder="0">
                </div>
                <div class="input-group">
                    <label>Límite superior</label>
                    <input id="integral-upper" type="text" class="input-styled" placeholder="1">
                </div>
            </div>
            <button id="integral-calc-btn" class="keypad-button equals-key" style="width:100%">Calcular</button>
            <div id="integral-result" class="modal-result"></div>
        </div>
    </div>

    <!-- Modal de Combinatoria -->
    <div id="combinatorics-modal" class="modal">
        <div class="modal-content">
             <div class="modal-header"><h2 class="modal-title">Combinatoria</h2><span class="modal-close" data-modal-target="combinatorics-modal">&times;</span></div>
             <div class="input-group">
                <label>Tipo de Operación:</label>
                <select id="comb-op" class="input-styled">
                    <option value="C">Combinaciones C(n,r)</option>
                    <option value="P">Permutaciones P(n,r)</option>
                    <option value="CR">Combinaciones con Repetición</option>
                    <option value="VR">Variaciones con Repetición</option>
                </select>
             </div>
             <div class="modal-grid-2">
                <div class="input-group">
                    <label for="comb-n">n (total)</label>
                    <input id="comb-n" type="number" class="input-styled" min="0">
                </div>
                <div class="input-group">
                    <label for="comb-r">r (a elegir)</label>
                    <input id="comb-r" type="number" class="input-styled" min="0">
                </div>
             </div>
             <button id="comb-calc-btn" class="keypad-button equals-key" style="width:100%">Calcular</button>
             <div id="comb-result" class="modal-result"></div>
        </div>
    </div>

    <!-- Modal de Ecuaciones -->
    <div id="equations-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2 class="modal-title">Resolver Sistema de Ecuaciones</h2><span class="modal-close" data-modal-target="equations-modal">&times;</span></div>
            <div class="input-group">
                <label>Ecuaciones (una por línea)</label>
                <textarea id="eq-sys-input" class="input-styled" rows="3" placeholder="2*x+y=5&#10;x-3*y=-8"></textarea>
            </div>
            <button id="eq-sys-calc-btn" class="keypad-button equals-key" style="width:100%">Resolver</button>
            <div id="eq-sys-result" class="modal-result"></div>
        </div>
    </div>

    <!-- Modal de Matrices -->
    <div id="matrix-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2 class="modal-title">Operaciones de Matriz</h2><span class="modal-close" data-modal-target="matrix-modal">&times;</span></div>
            <select id="matrix-size" class="input-styled mb-4">
                <option value="2">Matriz 2x2</option>
                <option value="3">Matriz 3x3</option>
            </select>
            <div id="matrix-input-container"></div>
            <button id="matrix-calc-btn" class="keypad-button equals-key mt-4" style="width:100%">Calcular Det & Inv</button>
            <div id="matrix-result" class="modal-result"></div>
        </div>
    </div>

    <!-- Modal de EDO -->
    <div id="edo-modal" class="modal">
        <div class="modal-content">
             <div class="modal-header"><h2 class="modal-title">Resolver Ecuación Diferencial</h2><span class="modal-close" data-modal-target="edo-modal">&times;</span></div>
             <select id="edo-type" class="input-styled mb-4">
                <option value="first_order">1er Orden: y' + p(x)y = q(x)</option>
                <option value="second_order">2º Orden: ay'' + by' + cy = 0</option>
             </select>
             <div id="edo-first-order-fields">
                <div class="input-group">
                    <label>p(x) =</label>
                    <input id="edo-p" type="text" class="input-styled" value="1">
                </div>
                <div class="input-group">
                    <label>q(x) =</label>
                    <input id="edo-q" type="text" class="input-styled" value="x">
                </div>
            </div>
             <div id="edo-second-order-fields" style="display:none;" class="modal-grid-3">
                <div class="input-group">
                    <label>a =</label>
                    <input id="edo-a" type="number" class="input-styled" value="1">
                </div>
                <div class="input-group">
                    <label>b =</label>
                    <input id="edo-b" type="number" class="input-styled" value="5">
                </div>
                <div class="input-group">
                    <label>c =</label>
                    <input id="edo-c" type="number" class="input-styled" value="6">
                </div>
            </div>
             <button id="edo-solve-btn" class="keypad-button equals-key mt-4" style="width:100%">Resolver</button>
             <div id="edo-result" class="modal-result"></div>
        </div>
    </div>

    <!-- Modal de Gráficas -->
    <div id="graph-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2 class="modal-title">Graficador de Funciones</h2><span class="modal-close" data-modal-target="graph-modal">&times;</span></div>
            <div class="input-group">
                <label for="graph-func">f(x) =</label>
                <input id="graph-func" type="text" class="input-styled" placeholder="e.g., x^3 - sin(x)">
            </div>
             <div class="modal-grid-2">
                 <div class="input-group">
                    <label>x min:</label>
                    <input id="graph-xmin" type="number" value="-10" class="input-styled">
                 </div>
                 <div class="input-group">
                    <label>x max:</label>
                    <input id="graph-xmax" type="number" value="10" class="input-styled">
                 </div>
             </div>
             <button id="graph-btn" class="keypad-button equals-key" style="width:100%">Graficar</button>
             <div id="plot-container" class="mt-4" style="width:100%;height:300px;"></div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        if (typeof nerdamer === 'undefined' || typeof Plotly === 'undefined') {
            document.body.innerHTML = `<div style="color: red; text-align: center; padding: 2rem; font-family: 'Poppins', sans-serif;">
                <h1>Error Crítico de Carga</h1>
                <p>No se pudieron cargar las librerías necesarias para la calculadora (Nerdamer, Plotly).</p>
                <p>Por favor, revise su conexión a internet, asegúrese de que no haya bloqueadores de scripts y recargue la página.</p>
            </div>`;
            return;
        }

        nerdamer.register({
            name: 'log10',
            numargs: 1,
            build: function(x) {
                return nerdamer('log(x)/log(10)').sub('x', x);
            }
        });

        const appState = { 
            lastExpression: '', 
            lastSymbolicResult: null, 
            isDecimalDisplayed: false, 
            currentAngleMode: 'deg' 
        };
        
        const ui = {
            input: document.getElementById('function-input'),
            output: document.getElementById('output'),
            error: document.getElementById('error-message'),
            angleSelector: document.getElementById('angle-mode-selector'),
            advToggle: document.getElementById('adv-controls-toggle'),
            advPanel: document.getElementById('advanced-controls-panel'),
            menuToggle: document.getElementById('menu-toggle'),
            mainMenu: document.getElementById('main-menu'),
        };

        const preprocessExpression = (expr) => {
            return expr.replace(/ln\(/g, 'log(');
        };
        
        const postprocessLatex = (latex) => {
            return latex.replace(/\\log/g, '\\ln');
        };

        const clearScreen = () => { 
            ui.output.innerHTML = ''; 
            ui.error.style.display = 'none'; 
        };
        
        const showError = (msg) => { 
            clearScreen(); 
            ui.error.textContent = msg; 
            ui.error.style.display = 'block'; 
        };
        
        const renderMath = (content, element = ui.output) => {
            if (!content) {
                element.innerHTML = '';
                return;
            }
            element.innerHTML = `$${content}$`;
            if (window.MathJax) {
                MathJax.typesetPromise([element]).catch((e) => {
                    console.error("Error en MathJax:", e);
                    element.innerHTML = `<span style="font-family: monospace;">${content}</span>`;
                });
            }
        };

        const convertToRadians = (expr) => {
            if (appState.currentAngleMode === 'rad' || !expr) return expr;
            const factor = appState.currentAngleMode === 'deg' ? '*(pi/180)' : '*(pi/200)';
            const trigRegex = /(?<![a-z])(sin|cos|tan)\(([^()]*(\([^()]*\)[^()]*)*)\)/g;
            
            return expr.replace(trigRegex, (match, func, content) => {
                return `${func}((${content})${factor})`;
            });
        };
        
        const updateDisplay = () => {
            if (!appState.lastSymbolicResult) return;
            try {
                clearScreen();
                if (appState.isDecimalDisplayed) {
                    const numericString = appState.lastSymbolicResult.evaluate().text('decimal');
                    const cleanNumericString = parseFloat(numericString).toString();
                    renderMath(cleanNumericString);
                } else {
                    const latex = postprocessLatex(appState.lastSymbolicResult.toTeX());
                    renderMath(latex);
                }
            } catch (err) {
                showError("Error al actualizar la pantalla: " + err.message);
                ui.output.textContent = appState.lastSymbolicResult.toString();
            }
        };
        
        const performCalculation = (op, expr) => {
            const expression = expr || ui.input.value.trim();
            if (!expression) { 
                showError("Introduzca una expresión."); 
                return; 
            }
            
            try {
                clearScreen();
                const processedExpr = preprocessExpression(expression);
                let finalExpr = processedExpr;
                
                if (op === 'EVAL') {
                    finalExpr = convertToRadians(processedExpr);
                }
                
                let symbolicResult = nerdamer(finalExpr);
                
                appState.isDecimalDisplayed = (op === 'EVAL');
                appState.lastExpression = expression;
                appState.lastSymbolicResult = symbolicResult;
                
                updateDisplay();

            } catch (err) { 
                showError("Error de cálculo: " + err.message); 
            }
        };

        function insertAtCursor(text, targetInput) {
            const inputEl = targetInput || ui.input;
            const start = inputEl.selectionStart || 0;
            const end = inputEl.selectionEnd || 0;
            inputEl.value = inputEl.value.substring(0, start) + text + inputEl.value.substring(end);
            inputEl.focus();
            const cursorPos = start + text.length;
            inputEl.setSelectionRange(cursorPos, cursorPos);
        }
        
        // --- GESTIÓN DE EVENTOS ---

        document.querySelector('.calculator-body').addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            
            const { action, value, modalTarget } = button.dataset;
            
            if (value) {
                insertAtCursor(value);
            } else if (action) {
                switch (action) {
                    case 'EVAL': performCalculation('EVAL'); break;
                    case 'AC':
                        ui.input.value = '';
                        appState.lastSymbolicResult = null;
                        appState.lastExpression = '';
                        clearScreen();
                        break;
                    case 'DEL': ui.input.value = ui.input.value.slice(0, -1); break;
                    case 'S2D':
                        if (appState.lastSymbolicResult) {
                            appState.isDecimalDisplayed = !appState.isDecimalDisplayed;
                            updateDisplay();
                        }
                        break;
                }
            } else if (modalTarget) {
                const modal = document.getElementById(modalTarget);
                if (modal) modal.style.display = 'flex';
            }
        });

        document.querySelectorAll('.modal-close').forEach(btn => {
            btn.addEventListener('click', e => e.target.closest('.modal').style.display = 'none');
        });
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });
        
        ui.angleSelector.addEventListener('click', (e) => {
            const button = e.target.closest('button[data-mode]');
            if (!button) return;
            ui.angleSelector.querySelectorAll('.angle-btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            appState.currentAngleMode = button.dataset.mode;
            if (appState.lastExpression) {
                performCalculation('EVAL', appState.lastExpression);
            }
        });
        
        ui.advToggle.addEventListener('click', () => {
            const isVisible = ui.advPanel.style.display === 'block';
            ui.advPanel.style.display = isVisible ? 'none' : 'block';
            ui.advToggle.textContent = isVisible ? '▼ Funciones Avanzadas ▼' : '▲ Ocultar Funciones ▲';
        });
        
        ui.menuToggle.addEventListener('click', () => ui.mainMenu.classList.toggle('active'));
        
        document.getElementById('help-btn').addEventListener('click', () => {
            document.getElementById('help-modal').style.display = 'flex';
            ui.mainMenu.classList.remove('active');
        });
        
        document.querySelectorAll('.theme-btn').forEach(button => {
            button.addEventListener('click', () => {
                document.body.className = '';
                const theme = button.dataset.theme;
                if (theme !== 'default') document.body.classList.add(theme);
                localStorage.setItem('calculatorTheme', theme);
                ui.mainMenu.classList.remove('active');
            });
        });
        
        const savedTheme = localStorage.getItem('calculatorTheme') || 'default';
        if (savedTheme !== 'default') document.body.classList.add(savedTheme);
        
        window.addEventListener('click', e => {
            if (ui.mainMenu && !ui.mainMenu.contains(e.target) && !ui.menuToggle.contains(e.target)) {
                ui.mainMenu.classList.remove('active');
            }
        });

        // --- LÓGICA DE MODALES ---
        
        const renderModalResult = (div, latex) => {
            div.innerHTML = `$$${latex}$$`;
            if(window.MathJax) MathJax.typesetPromise([div]);
        };
        const renderModalError = (div, msg) => {
            div.innerHTML = `<p class="text-red-400">${msg}</p>`;
        };

        // Modal de Álgebra
        document.getElementById('algebra-calc-btn').addEventListener('click', () => {
            const op = document.getElementById('algebra-op').value;
            const input = document.getElementById('algebra-input').value.trim();
            const resultDiv = document.getElementById('algebra-result');
            if (!input) return renderModalError(resultDiv, 'Ingrese una expresión.');

            try {
                let result;
                let latexOutput;

                switch (op) {
                    case 'factor':
                    case 'expand':
                        result = nerdamer[op](input);
                        latexOutput = result.toTeX();
                        break;
                    
                    case 'solve':
                        const equation = input.includes('=') ? input : `${input}=0`;
                        const variables = nerdamer(equation).variables();
                        if (variables.length === 0) throw new Error('No se encontró una variable para resolver.');
                        const variableToSolve = variables[0];
                        
                        const solutions = nerdamer.solve(equation, variableToSolve);
                        const solutionArray = solutions.toString().replace(/[\[\]]/g, '').split(',');

                        if (solutionArray.length === 0 || solutionArray[0] === '') {
                             latexOutput = `\\text{No se encontraron soluciones para } ${variableToSolve}`;
                        } else {
                            latexOutput = solutionArray.map(sol => `${variableToSolve} = ${nerdamer(sol).toTeX()}`).join(',\\quad ');
                        }
                        break;

                    case 'gcd':
                    case 'lcm':
                        const parts = input.split(',').map(s => s.trim());
                        if (parts.length < 2) throw new Error('Se requieren al menos dos números para MCD/MCM.');
                        result = nerdamer[op](...parts);
                        latexOutput = `${op.toUpperCase()}(${parts.join(', ')}) = ${result.toTeX()}`;
                        break;
                    
                    case 'divisors':
                        const num = parseInt(input);
                        if (isNaN(num)) throw new Error('La entrada para divisores debe ser un número entero.');
                        const getDivisors = n => {
                            const absN = Math.abs(n);
                            const divs = new Set();
                            for (let i = 1; i <= Math.sqrt(absN); i++) {
                                if (absN % i === 0) {
                                    divs.add(i);
                                    divs.add(absN / i);
                                }
                            }
                            return Array.from(divs).sort((a, b) => a - b);
                        };
                        const divisorsList = getDivisors(num);
                        latexOutput = `Divisores(${num}) = [${divisorsList.join(',\\ ')}]`;
                        break;
                    
                    default:
                        throw new Error('Operación no reconocida.');
                }
                
                renderModalResult(resultDiv, latexOutput);

            } catch (e) {
                renderModalError(resultDiv, `Error: ${e.message}`);
            }
        });

        // Modal de Laplace
        document.getElementById('laplace-calc-btn').addEventListener('click', () => {
            const func = document.getElementById('laplace-func').value.trim();
            const resultDiv = document.getElementById('laplace-result');
            if (!func) return renderModalError(resultDiv, 'Ingrese una función f(t).');

            try {
                if (!nerdamer(func).variables().includes('t')) {
                    throw new Error("La función debe ser una expresión en la variable 't'.");
                }
                const result = nerdamer.laplace(func, 't', 's');
                const latex = `\\mathcal{L}\\{${func}\\} = ${result.toTeX()}`;
                renderModalResult(resultDiv, latex);
            } catch (e) {
                renderModalError(resultDiv, `Error: ${e.message}`);
            }
        });

        // Modal de Límites
        document.getElementById('limit-calc-btn').addEventListener('click', () => {
            const func = document.getElementById('limit-func').value.trim();
            const variable = document.getElementById('limit-var').value || 'x';
            const point = document.getElementById('limit-point').value.trim();
            const resultDiv = document.getElementById('limit-result');
            if (!func || !point) return renderModalError(resultDiv, 'Complete todos los campos.');
            
            try {
                const result = nerdamer.limit(func, variable, point);
                renderModalResult(resultDiv, `\\lim_{${variable} \\to ${point}} (${func}) = ${result.toTeX()}`);
            } catch(e) {
                renderModalError(resultDiv, `Error: ${e.message}`);
            }
        });

        // Modal de Sumatorias
        document.getElementById('sum-calc-btn').addEventListener('click', () => {
            const func = document.getElementById('sum-func').value.trim();
            const variable = document.getElementById('sum-var').value || 'n';
            const from = document.getElementById('sum-from').value.trim();
            const to = document.getElementById('sum-to').value.trim();
            const resultDiv = document.getElementById('sum-result');
            if (!func || !from || !to) return renderModalError(resultDiv, 'Complete todos los campos.');
            
            try {
                const result = nerdamer.sum(func, variable, from, to);
                renderModalResult(resultDiv, `\\sum_{${variable}=${from}}^{${to}} (${func}) = ${result.toTeX()}`);
            } catch(e) {
                renderModalError(resultDiv, `Error: ${e.message}`);
            }
        });

        // Modal de Derivadas
        document.getElementById('derivative-evaluate').addEventListener('change', (e) => {
            document.getElementById('derivative-point').style.display = e.target.checked ? 'block' : 'none';
        });
        document.getElementById('derivative-calc-btn').addEventListener('click', () => {
            const func = document.getElementById('derivative-func').value.trim();
            const variable = document.getElementById('derivative-var').value || 'x';
            const order = parseInt(document.getElementById('derivative-order').value) || 1;
            const evaluate = document.getElementById('derivative-evaluate').checked;
            const point = document.getElementById('derivative-point').value;
            const resultDiv = document.getElementById('derivative-result');
            if (!func) return renderModalError(resultDiv, 'Ingrese una función.');
            
            try {
                const derivative = nerdamer.diff(func, variable, order);
                let latex;
                const dNotation = order > 1 ? `\\frac{d^{${order}}}{d${variable}^{${order}}}` : `\\frac{d}{d${variable}}`;

                if (evaluate && point) {
                    const numResult = derivative.evaluate({[variable]: point});
                    latex = `${dNotation}(${func})\\bigg|_{${variable}=${point}} = ${numResult.toTeX()}`;
                } else {
                    latex = `${dNotation}(${func}) = ${derivative.toTeX()}`;
                }
                renderModalResult(resultDiv, latex);
            } catch(e) {
                renderModalError(resultDiv, `Error: ${e.message}`);
            }
        });

        // Modal de Integrales
        document.getElementById('integral-definite').addEventListener('change', (e) => {
            document.getElementById('integral-limits').style.display = e.target.checked ? 'grid' : 'none';
        });
        document.getElementById('integral-calc-btn').addEventListener('click', () => {
            const func = document.getElementById('integral-func').value.trim();
            const variable = document.getElementById('integral-var').value || 'x';
            const isDefinite = document.getElementById('integral-definite').checked;
            const lower = document.getElementById('integral-lower').value;
            const upper = document.getElementById('integral-upper').value;
            const resultDiv = document.getElementById('integral-result');
            if (!func) return renderModalError(resultDiv, 'Ingrese una función.');
            
            try {
                let result, latex;
                if (isDefinite && lower && upper) {
                    result = nerdamer.defint(func, variable, lower, upper);
                    latex = `\\int_{${lower}}^{${upper}} (${func}) \\, d${variable} = ${result.toTeX()}`;
                } else {
                    result = nerdamer.integrate(func, variable);
                    latex = `\\int (${func}) \\, d${variable} = ${result.toTeX()} + C`;
                }
                renderModalResult(resultDiv, latex);
            } catch(e) {
                renderModalError(resultDiv, `Error: ${e.message}`);
            }
        });

        // Modal de Combinatoria (usa matemáticas nativas de JS).
        document.getElementById('comb-calc-btn').addEventListener('click', () => {
            const op = document.getElementById('comb-op').value;
            const n = parseInt(document.getElementById('comb-n').value);
            const r = parseInt(document.getElementById('comb-r').value);
            const resultDiv = document.getElementById('comb-result');

            if (isNaN(n) || isNaN(r) || n < 0 || r < 0) {
                return renderModalError(resultDiv, 'Por favor, ingrese números enteros no negativos.');
            }

            const factorial = (num) => {
                if (num < 0) return NaN;
                if (num > 170) return Infinity; 
                if (num === 0) return 1;
                let result = 1;
                for (let i = 2; i <= num; i++) {
                    result *= i;
                }
                return result;
            };

            try {
                let result;
                let formula = '';

                switch(op) {
                    case 'C': 
                        if (r > n) return renderModalError(resultDiv, 'Error: r no puede ser mayor que n.');
                        formula = `C(${n},${r}) = \\frac{${n}!}{${r}!(${n}-${r})!}`;
                        result = factorial(n) / (factorial(r) * factorial(n - r));
                        break;
                    case 'P': 
                        if (r > n) return renderModalError(resultDiv, 'Error: r no puede ser mayor que n.');
                        formula = `P(${n},${r}) = \\frac{${n}!}{(${n}-${r})!}`;
                        result = factorial(n) / factorial(n - r);
                        break;
                    case 'CR': 
                        formula = `CR(${n},${r}) = \\frac{(${n}+${r}-1)!}{${r}!(${n}-1)!}`;
                        result = factorial(n + r - 1) / (factorial(r) * factorial(n - 1));
                        break;
                    case 'VR': 
                        formula = `VR(${n},${r}) = ${n}^{${r}}`;
                        result = Math.pow(n, r);
                        break;
                }

                if (!isFinite(result)) {
                    renderModalError(resultDiv, 'El resultado es demasiado grande para calcular.');
                } else {
                    renderModalResult(resultDiv, `${formula} = ${result.toLocaleString('es')}`);
                }
            } catch(e) {
                renderModalError(resultDiv, `Error de cálculo: ${e.message}`);
            }
        });
        
        // Modal de Sistema de Ecuaciones
        document.getElementById('eq-sys-calc-btn').addEventListener('click', () => {
            const eqns = document.getElementById('eq-sys-input').value.split('\n').filter(e => e.trim() !== '');
            const resultDiv = document.getElementById('eq-sys-result');
            if (eqns.length === 0) return renderModalError(resultDiv, 'Ingrese al menos una ecuación.');
            
            try {
                const result = nerdamer.solveEquations(eqns);
                let html = result.map(sol => `$$${sol[0]} = ${nerdamer(sol[1]).toTeX()}$$`).join('');
                resultDiv.innerHTML = `<p><strong>Solución:</strong></p>${html}`;
                MathJax.typesetPromise([resultDiv]);
            } catch(e) {
                renderModalError(resultDiv, `No se pudo resolver: ${e.message}`);
            }
        });

        // --- LÓGICA DEL MODAL DE MATRICES (CORREGIDO) ---
        const matrixContainer = document.getElementById('matrix-input-container');
        
        const getMatrixValuesFromModal = () => {
            const size = parseInt(document.getElementById('matrix-size').value);
            const inputs = matrixContainer.querySelectorAll('input');
            const matrix = [];
            for(let i = 0; i < size; i++) {
                const row = [];
                for(let j = 0; j < size; j++) {
                    const val = parseFloat(inputs[i * size + j].value);
                    if (isNaN(val)) throw new Error('Todas las celdas de la matriz deben contener números.');
                    row.push(val);
                }
                matrix.push(row);
            }
            return matrix;
        };

        const determinant = (matrix) => {
            if (matrix.length !== matrix[0].length) throw new Error('La matriz debe ser cuadrada.');
            if (matrix.length === 1) return matrix[0][0];
            if (matrix.length === 2) return matrix[0][0] * matrix[1][1] - matrix[0][1] * matrix[1][0];
            
            let det = 0;
            for (let i = 0; i < matrix[0].length; i++) {
                det += matrix[0][i] * cofactor(matrix, 0, i);
            }
            return det;
        };

        const cofactor = (matrix, row, col) => {
            const minor = matrix
                .filter((_, r) => r !== row)
                .map(r => r.filter((_, c) => c !== col));
            return Math.pow(-1, row + col) * determinant(minor);
        };

        const adjugate = (matrix) => {
            if (matrix.length !== matrix[0].length) throw new Error('La matriz debe ser cuadrada.');
            const n = matrix.length;
            const adj = Array(n).fill().map(() => Array(n).fill(0));
            for (let i = 0; i < n; i++) {
                for (let j = 0; j < n; j++) {
                    adj[j][i] = cofactor(matrix, i, j);
                }
            }
            return adj;
        };

        const inverseMatrix = (matrix) => {
            const det = determinant(matrix);
            if (Math.abs(det) < 1e-10) throw new Error('La matriz no tiene inversa (determinante es cero).');
            const adj = adjugate(matrix);
            return adj.map(row => row.map(val => val / det));
        };

        const formatMatrixToLatex = (matrix) => {
            return `\\begin{pmatrix} ${matrix.map(row => row.map(val => parseFloat(val.toFixed(4))).join(' & ')).join(' \\\\ ')} \\end{pmatrix}`;
        };

        const generateMatrixGrid = () => {
            const size = parseInt(document.getElementById('matrix-size').value);
            matrixContainer.innerHTML = '';
            matrixContainer.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
            matrixContainer.classList.add('matrix-grid');
            for(let i = 0; i < size * size; i++) {
                const cell = document.createElement('input');
                cell.type = 'number';
                cell.className = 'input-styled text-center';
                cell.placeholder = `a${Math.floor(i/size)+1}${i%size+1}`;
                matrixContainer.appendChild(cell);
            }
        };
        document.getElementById('matrix-size').addEventListener('change', generateMatrixGrid);
        
        document.getElementById('matrix-calc-btn').addEventListener('click', () => {
            const resultDiv = document.getElementById('matrix-result');
            try {
                const matrix = getMatrixValuesFromModal();
                const det = determinant(matrix);
                let html = `<p><strong>Determinante:</strong></p>$$|A| = ${parseFloat(det.toFixed(6))}$$`;
                
                if (Math.abs(det) > 1e-10) {
                    const inv = inverseMatrix(matrix);
                    html += `<p class="mt-4"><strong>Matriz Inversa:</strong></p>$$A^{-1} = ${formatMatrixToLatex(inv)}$$`;
                } else {
                    html += '<p class="mt-4"><em>La matriz no tiene inversa (determinante ≈ 0).</em></p>';
                }
                resultDiv.innerHTML = html;
                MathJax.typesetPromise([resultDiv]);
            } catch(e) {
                renderModalError(resultDiv, `Error: ${e.message}`);
            }
        });
        generateMatrixGrid();

        // --- LÓGICA DEL MODAL DE EDO (CORREGIDO) ---
        document.getElementById('edo-type').addEventListener('change', e => {
            const isFirst = e.target.value === 'first_order';
            document.getElementById('edo-first-order-fields').style.display = isFirst ? 'block' : 'none';
            document.getElementById('edo-second-order-fields').style.display = isFirst ? 'none' : 'grid';
        });

        document.getElementById('edo-solve-btn').addEventListener('click', () => {
            const type = document.getElementById('edo-type').value;
            const resultDiv = document.getElementById('edo-result');
            resultDiv.innerHTML = ''; // Limpiar resultados anteriores

            try {
                let latexOutput = '';
                if (type === 'first_order') {
                    const p = document.getElementById('edo-p').value.trim() || '0';
                    const q = document.getElementById('edo-q').value.trim() || '0';
                    if (!p || !q) throw new Error("p(x) y q(x) no pueden estar vacíos.");

                    const integratingFactor = nerdamer(`exp(integrate(${p},x))`).expand();
                    const integralPart = nerdamer(`integrate((${integratingFactor.text()})*(${q}),x)`);
                    const y_general = nerdamer(`(1/(${integratingFactor.text()}))*(${integralPart.text()}+C)`);

                    latexOutput = `
                        \\textbf{Ecuación:} & y' + (${nerdamer(p).toTeX()})y = ${nerdamer(q).toTeX()} \\\\
                        \\textbf{Factor Integrante:} & \\mu(x) = e^{\\int ${nerdamer(p).toTeX()}\\,dx} = ${integratingFactor.toTeX()} \\\\
                        \\textbf{Solución General:} & y(x) = ${y_general.toTeX()}
                    `;
                    // Usamos un array para alinear las ecuaciones
                    renderModalResult(resultDiv, `\\begin{align*} ${latexOutput} \\end{align*}`);
                    return;

                } else { // second_order
                    const a = parseFloat(document.getElementById('edo-a').value);
                    const b = parseFloat(document.getElementById('edo-b').value);
                    const c = parseFloat(document.getElementById('edo-c').value);

                    if (isNaN(a) || isNaN(b) || isNaN(c) || a === 0) {
                        throw new Error("Los coeficientes a, b, c deben ser números y 'a' no puede ser cero.");
                    }

                    const delta = b * b - 4 * a * c;
                    let yc = '';

                    if (delta > 0) {
                        const r1 = (-b + Math.sqrt(delta)) / (2 * a);
                        const r2 = (-b - Math.sqrt(delta)) / (2 * a);
                        yc = `C_1 e^{${r1.toFixed(3)}x} + C_2 e^{${r2.toFixed(3)}x}`;
                    } else if (Math.abs(delta) < 1e-9) { 
                        const r = -b / (2 * a);
                        yc = `(C_1 + C_2 x) e^{${r.toFixed(3)}x}`;
                    } else { 
                        const alpha = -b / (2 * a);
                        const beta = Math.sqrt(-delta) / (2 * a);
                        yc = `e^{${alpha.toFixed(3)}x}(C_1 \\cos(${beta.toFixed(3)}x) + C_2 \\sin(${beta.toFixed(3)}x))`;
                    }
                    latexOutput = `y(x) = ${yc}`;
                }
                renderModalResult(resultDiv, latexOutput);
            } catch (e) {
                renderModalError(resultDiv, `Error: ${e.message}`);
            }
        });
        
        // --- LÓGICA DEL MODAL DE CONVERSIONES (NUEVO) ---
        const convertAngles = (source) => {
            const degInput = document.getElementById('conv-degrees');
            const radInput = document.getElementById('conv-radians');
            const gradInput = document.getElementById('conv-gradians');
            const pi = Math.PI;
            let degValue = 0;

            // Para evitar bucles infinitos, se desactiva temporalmente el 'oninput' de los otros campos
            const others = {
                degrees: [radInput, gradInput],
                radians: [degInput, gradInput],
                gradians: [degInput, radInput]
            };
            others[source].forEach(el => el.oninput = null);

            if (source === 'degrees') {
                const deg = parseFloat(degInput.value);
                if (isNaN(deg)) { radInput.value = ''; gradInput.value = ''; return; }
                radInput.value = (deg * pi / 180).toFixed(5);
                gradInput.value = (deg * 200 / 180).toFixed(5);
            } else if (source === 'radians') {
                const rad = parseFloat(radInput.value);
                if (isNaN(rad)) { degInput.value = ''; gradInput.value = ''; return; }
                degInput.value = (rad * 180 / pi).toFixed(5);
                gradInput.value = (rad * 200 / pi).toFixed(5);
            } else if (source === 'gradians') {
                const grad = parseFloat(gradInput.value);
                if (isNaN(grad)) { degInput.value = ''; radInput.value = ''; return; }
                degInput.value = (grad * 180 / 200).toFixed(5);
                radInput.value = (grad * pi / 200).toFixed(5);
            }
            
            // Se reactiva el 'oninput'
            setTimeout(() => {
                others[source].forEach(el => el.oninput = () => convertAngles(el.id.split('-')[1]));
            }, 100);
        };
        
        const convertCoords = (source) => {
            const xInput = document.getElementById('coord-x');
            const yInput = document.getElementById('coord-y');
            const rInput = document.getElementById('coord-r');
            const thetaInput = document.getElementById('coord-theta');

            const others = {
                rect: [rInput, thetaInput],
                polar: [xInput, yInput]
            };
            others[source].forEach(el => el.oninput = null);

            if (source === 'rect') {
                const x = parseFloat(xInput.value) || 0;
                const y = parseFloat(yInput.value) || 0;
                const r = Math.sqrt(x*x + y*y);
                const theta = Math.atan2(y, x) * (180 / Math.PI);
                rInput.value = isNaN(r) ? '' : r.toFixed(4);
                thetaInput.value = isNaN(theta) ? '' : theta.toFixed(4);
            } else { // polar
                const r = parseFloat(rInput.value) || 0;
                const theta = parseFloat(thetaInput.value) || 0;
                const thetaRad = theta * (Math.PI / 180);
                const x = r * Math.cos(thetaRad);
                const y = r * Math.sin(thetaRad);
                xInput.value = isNaN(x) ? '' : x.toFixed(4);
                yInput.value = isNaN(y) ? '' : y.toFixed(4);
            }

            setTimeout(() => {
                others[source].forEach(el => el.oninput = () => convertCoords(el.id.includes('coord-x') || el.id.includes('coord-y') ? 'rect' : 'polar'));
            }, 100);
        };
        // Asignación inicial de los eventos para el nuevo modal
        document.getElementById('conv-degrees').oninput = () => convertAngles('degrees');
        document.getElementById('conv-radians').oninput = () => convertAngles('radians');
        document.getElementById('conv-gradians').oninput = () => convertAngles('gradians');
        document.getElementById('coord-x').oninput = () => convertCoords('rect');
        document.getElementById('coord-y').oninput = () => convertCoords('rect');
        document.getElementById('coord-r').oninput = () => convertCoords('polar');
        document.getElementById('coord-theta').oninput = () => convertCoords('polar');


        // Modal de Gráficas
        document.getElementById('graph-btn').addEventListener('click', () => {
            const funcStr = document.getElementById('graph-func').value.trim();
            const xmin = parseFloat(document.getElementById('graph-xmin').value);
            const xmax = parseFloat(document.getElementById('graph-xmax').value);
            const container = document.getElementById('plot-container');
            if (!funcStr) return container.innerHTML = '<p class="text-red-400">Ingrese una función.</p>';
            if (xmin >= xmax) return container.innerHTML = '<p class="text-red-400">x mín debe ser menor que x máx.</p>';
            
            try {
                const f = nerdamer(funcStr).buildFunction('x');
                const x_vals = [], y_vals = [];
                const step = (xmax - xmin) / 400;
                for(let x = xmin; x <= xmax; x += step) {
                    try {
                        const y = f(x);
                        if (isFinite(y)) { x_vals.push(x); y_vals.push(y); }
                    } catch(e) { /* Ignorar puntos indefinidos */ }
                }
                
                Plotly.newPlot(container, [{ x: x_vals, y: y_vals, mode: 'lines', line: { color: getComputedStyle(document.documentElement).getPropertyValue('--accent-color-1') }}], 
                {
                    paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
                    font: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-color') },
                    xaxis: { gridcolor: '#444', zerolinecolor: '#888', title: 'x'},
                    yaxis: { gridcolor: '#444', zerolinecolor: '#888', title: 'f(x)'},
                    title: { text: `f(x) = ${funcStr}`, font: { size: 14 } },
                    margin: { l: 40, r: 20, b: 40, t: 40 }
                }, {responsive: true});
            } catch(e) {
                container.innerHTML = `<p class="text-red-400">Error al graficar: ${e.message}</p>`;
            }
        });

        // Atajos de teclado
        ui.input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                performCalculation('EVAL');
            } else if (e.key === 'Escape') {
                ui.input.value = '';
                clearScreen();
            }
        });
    });
    </script>
</body>
</html>
