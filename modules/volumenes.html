<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Vol√∫menes de Revoluci√≥n PRO</title>
    
    <!-- Scripts de Librer√≠as -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.5.0/math.min.js"></script>
    <script>
        MathJax = { tex: { inlineMath: [['$', '$']] }, svg: { fontCache: 'global' } };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Definici√≥n de variables de CSS para Theming */
        :root {
            --bg-primary: #ffffff; --bg-secondary: #f0f2f5; --bg-control: #ffffff; --bg-modal: #ffffff; --bg-input: #ffffff; --bg-hover: #f9fafb;
            --text-primary: #1f2937; --text-secondary: #4b5563; --border-color: #d1d5db;
            --accent-color: #4f46e5; --accent-hover: #4338ca; --shadow-color: rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        body.theme-dark {
            --bg-primary: #111827; --bg-secondary: #030712; --bg-control: #1f2937; --bg-modal: #1f2937; --bg-input: #374151; --bg-hover: #374151;
            --text-primary: #f9fafb; --text-secondary: #d1d5db; --border-color: #4b5563;
            --accent-color: #6366f1; --accent-hover: #818cf8; --shadow-color: rgba(0, 0, 0, 0.4);
        }
        body.theme-midnight {
            --bg-primary: #1e293b; --bg-secondary: #0f172a; --bg-control: #334155; --bg-modal: #334155; --bg-input: #475569; --bg-hover: #475569;
            --text-primary: #f1f5f9; --text-secondary: #cbd5e1; --border-color: #64748b;
            --accent-color: #818cf8; --accent-hover: #a5b4fc; --shadow-color: rgba(0, 0, 0, 0.4);
        }
        body.theme-sepia {
            --bg-primary: #fbf5e9; --bg-secondary: #f3eade; --bg-control: #efe3d0; --bg-modal: #efe3d0; --bg-input: #fbf5e9; --bg-hover: #e9dccb;
            --text-primary: #5d4037; --text-secondary: #795548; --border-color: #bcaaa4;
            --accent-color: #8d6e63; --accent-hover: #795548; --shadow-color: rgba(93, 64, 55, 0.2);
        }
        body.theme-mint {
            --bg-primary: #f0fdfa; --bg-secondary: #ccfbf1; --bg-control: #ffffff; --bg-modal: #ffffff; --bg-input: #ffffff; --bg-hover: #f0fdfa;
            --text-primary: #0f766e; --text-secondary: #115e59; --border-color: #99f6e4;
            --accent-color: #14b8a6; --accent-hover: #0d9488; --shadow-color: rgba(13, 148, 136, 0.1);
        }
        body.theme-cherry {
            --bg-primary: #fff1f2; --bg-secondary: #ffe4e6; --bg-control: #ffffff; --bg-modal: #ffffff; --bg-input: #ffffff; --bg-hover: #fff1f2;
            --text-primary: #be123c; --text-secondary: #9f1239; --border-color: #fecdd3;
            --accent-color: #f43f5e; --accent-hover: #e11d48; --shadow-color: rgba(225, 29, 72, 0.1);
        }
        body.theme-galaxy {
            --bg-primary: #1e1b4b; --bg-secondary: #1b193a; --bg-control: #312e81; --bg-modal: #312e81; --bg-input: #4338ca; --bg-hover: #4338ca;
            --text-primary: #e0e7ff; --text-secondary: #c7d2fe; --border-color: #5b21b6;
            --accent-color: #a78bfa; --accent-hover: #c4b5fd; --shadow-color: rgba(67, 56, 202, 0.4);
        }
        body.theme-coffee {
            --bg-primary: #2d1e18; --bg-secondary: #1e120d; --bg-control: #402b23; --bg-modal: #402b23; --bg-input: #573d33; --bg-hover: #573d33;
            --text-primary: #f5e9e2; --text-secondary: #d4c4b8; --border-color: #714e3d;
            --accent-color: #a16207; --accent-hover: #c87d0a; --shadow-color: rgba(87, 61, 51, 0.4);
        }

        /* Aplicar variables */
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-secondary); color: var(--text-primary); }
        .control-panel, .plot-panel, .modal-content, #color-popover { background-color: var(--bg-control); box-shadow: 0 10px 15px -3px var(--shadow-color), 0 4px 6px -2px var(--shadow-color); }
        .modal-content { background-color: var(--bg-modal); }
        input, select { background-color: var(--bg-input); border-color: var(--border-color); color: var(--text-primary); }
        input[type="range"] { accent-color: var(--accent-color); }
        .btn-primary { background-color: var(--accent-color); &:hover { background-color: var(--accent-hover); } }
        
        /* Estilos adicionales */
        #plot-2d, #plot-3d canvas { width: 100% !important; height: 100% !important; }
        select:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body class="theme-light">

    <div class="container mx-auto p-4 md:p-6 flex flex-col min-h-screen">
        <main class="flex-grow">
            <header class="text-center mb-6">
                <h1 class="text-3xl md:text-4xl font-bold">Simulador Interactivo de Vol√∫menes</h1>
                <p class="text-md text-[var(--text-secondary)] mt-2">M√©todos de Discos, Arandelas y Cascarones Cil√≠ndricos</p>
            </header>

            <div class="flex flex-col lg:flex-row gap-6">

                <!-- Panel de Controles -->
                <div class="w-full lg:w-1/3 p-6 rounded-xl control-panel relative">
                    <div class="flex justify-between items-center border-b pb-2 mb-4 border-[var(--border-color)]">
                        <h2 class="text-xl font-semibold">Controles</h2>
                        <div class="flex gap-2">
                            <button id="color-palette-btn" title="Cambiar Paleta de Colores" class="p-2 rounded-full hover:bg-[var(--bg-hover)] transition-colors">üé®</button>
                            <button id="theme-btn" title="Cambiar Tema de Interfaz" class="p-2 rounded-full hover:bg-[var(--bg-hover)] transition-colors">üëï</button>
                        </div>
                    </div>
                    
                    <!-- Popover de Colores -->
                    <div id="color-popover" class="absolute top-16 right-6 w-64 bg-white p-4 rounded-lg shadow-xl z-20 hidden">
                        <h4 class="font-semibold mb-2">Paletas de Colores</h4>
                        <div id="palette-presets" class="grid grid-cols-3 gap-2 mb-4"></div>
                        <h4 class="font-semibold mb-2">Personalizado</h4>
                        <div class="flex gap-2 items-center">
                            <input type="color" id="color-start" class="w-full h-8 p-0 border-none rounded cursor-pointer" value="#3b82f6">
                            <span>‚Üí</span>
                            <input type="color" id="color-end" class="w-full h-8 p-0 border-none rounded cursor-pointer" value="#a855f7">
                        </div>
                    </div>

                    <!-- Controles -->
                    <div class="space-y-4">
                        <div>
                            <label for="rotation-axis" class="block text-sm font-medium text-[var(--text-secondary)] mb-1">Eje de Rotaci√≥n</label>
                            <select id="rotation-axis" class="w-full p-2 border rounded-md shadow-sm focus:ring-[var(--accent-color)] focus:border-[var(--accent-color)]"></select>
                        </div>
                        <div>
                            <label for="method" class="block text-sm font-medium text-[var(--text-secondary)] mb-1">M√©todo de C√°lculo</label>
                            <select id="method" class="w-full p-2 border rounded-md shadow-sm focus:ring-[var(--accent-color)] focus:border-[var(--accent-color)]"></select>
                        </div>
                        <div>
                            <label for="func1" class="block text-sm font-medium text-[var(--text-secondary)]">Funci√≥n y = f(x)</label>
                            <input type="text" id="func1" value="sqrt(x)" class="mt-1 w-full p-2 border rounded-md shadow-sm">
                        </div>
                        <div id="func2-container" class="hidden">
                            <label for="func2" class="block text-sm font-medium text-[var(--text-secondary)]">Funci√≥n y = g(x)</label>
                            <input type="text" id="func2" value="x/2" class="mt-1 w-full p-2 border rounded-md shadow-sm">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="limit-a" class="block text-sm font-medium text-[var(--text-secondary)]">L√≠mite a</label>
                                <input type="number" id="limit-a" value="0" step="0.1" class="mt-1 w-full p-2 border rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="limit-b" class="block text-sm font-medium text-[var(--text-secondary)]">L√≠mite b</label>
                                <input type="number" id="limit-b" value="4" step="0.1" class="mt-1 w-full p-2 border rounded-md shadow-sm">
                            </div>
                        </div>
                        <div>
                            <label for="slices" class="block text-sm font-medium text-[var(--text-secondary)]">N√∫mero de Elementos: <span id="slices-value" class="font-bold">20</span></label>
                            <input type="range" id="slices" min="2" max="100" value="20" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        </div>
                         <div>
                            <label for="opacity-slider" class="block text-sm font-medium text-[var(--text-secondary)]">Opacidad del S√≥lido: <span id="opacity-value" class="font-bold">100%</span></label>
                            <input type="range" id="opacity-slider" min="0.1" max="1" step="0.05" value="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        </div>
                        <div id="result-container" class="mt-4 p-4 bg-[var(--bg-secondary)] rounded-lg border border-[var(--border-color)]">
                            <h3 class="font-semibold text-lg mb-2">F√≥rmula y Volumen</h3>
                            <div id="formula" class="text-center text-lg overflow-x-auto"></div>
                            <div id="volume" class="text-center text-lg font-bold mt-2"></div>
                            <button id="show-calc-btn" class="mt-4 w-full bg-[var(--text-secondary)] text-[var(--bg-primary)] font-semibold py-2 px-4 rounded-md hover:opacity-80 transition">
                                Ver Detalles del C√°lculo
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Panel de Visualizaci√≥n -->
                <div class="w-full lg:w-2/3 flex flex-col gap-6">
                    <div class="p-4 rounded-xl plot-panel flex-1">
                        <h2 class="text-xl font-semibold mb-2 text-center">1. Regi√≥n Plana a Rotar</h2>
                        <div id="plot-2d" class="w-full h-64 md:h-full min-h-[300px]"></div>
                    </div>
                    <div class="p-4 rounded-xl plot-panel flex-1">
                        <h2 class="text-xl font-semibold mb-2 text-center">2. S√≥lido de Revoluci√≥n</h2>
                        <div id="plot-3d" class="w-full h-64 md:h-full min-h-[300px] cursor-move"></div>
                    </div>
                </div>
            </div>
        </main>
        <footer class="text-center p-4 mt-8 text-[var(--text-secondary)] text-sm">
            <p>Autor: Msc N√©stor Fabio Montoya Palacios &amp; Gemini AI</p>
        </footer>
    </div>
    
    <!-- Modals -->
    <div id="calculation-modal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="modal-content rounded-2xl w-full max-w-3xl max-h-[90vh] flex flex-col transform transition-all duration-300 scale-95 opacity-0">
            <div class="flex justify-between items-center p-5 border-b border-[var(--border-color)]">
                <h2 class="text-2xl font-bold">Desglose del C√°lculo</h2>
                <button class="close-modal-btn text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition">&times;</button>
            </div>
            <div class="p-6 space-y-6 overflow-y-auto modal-body">
                <!-- Card de Volumen Aproximado -->
                <div class="bg-[var(--bg-secondary)] p-5 rounded-lg border border-[var(--border-color)]">
                    <h3 class="font-semibold text-xl mb-3">Volumen Aproximado (Suma de Riemann)</h3>
                    <div id="approx-volume-details" class="space-y-3 text-[var(--text-secondary)]"></div>
                </div>
                <!-- Card de Volumen Exacto -->
                <div class="bg-[var(--bg-secondary)] p-5 rounded-lg border border-[var(--border-color)]">
                     <h3 class="font-semibold text-xl mb-3">Volumen Exacto (Integral Definida)</h3>
                    <div id="exact-volume-details" class="space-y-3 text-[var(--text-secondary)]"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="theme-modal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="modal-content rounded-2xl w-full max-w-lg max-h-[90vh] flex flex-col transform transition-all duration-300 scale-95 opacity-0">
            <div class="flex justify-between items-center p-5 border-b border-[var(--border-color)]">
                <h2 class="text-2xl font-bold">Seleccionar Tema</h2>
                <button class="close-modal-btn text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition">&times;</button>
            </div>
            <div id="theme-selector" class="p-6 grid grid-cols-2 md:grid-cols-4 gap-4"></div>
        </div>
    </div>

    <script type="module">
        // --- GLOBAL STATE & CONFIG ---
        let scene, camera, renderer, controls, solidGroup, labeledAxes;
        let gradientStart = new THREE.Color("#3b82f6");
        let gradientEnd = new THREE.Color("#a855f7");
        let materialOpacity = 1.0;

        const PALETTES = { "Oc√©ano": ["#0077b6", "#90e0ef"], "Atardecer": ["#f77f00", "#d62828"], "Bosque": ["#2d6a4f", "#b7e4c7"], "Ne√≥n": ["#ea00d9", "#0abdc6"], "Grises": ["#495057", "#dee2e6"] };
        const THEMES = { "Claro": "theme-light", "Oscuro": "theme-dark", "Medianoche": "theme-midnight", "Sepia": "theme-sepia", "Menta": "theme-mint", "Cereza": "theme-cherry", "Galaxia": "theme-galaxy", "Caf√©": "theme-coffee" };
        const AXES = { "Eje X": "x", "Eje Y": "y" };

        const ui = {
            body: document.body, plot3dContainer: document.getElementById('plot-3d'), method: document.getElementById('method'), rotationAxis: document.getElementById('rotation-axis'),
            func1: document.getElementById('func1'), func2: document.getElementById('func2'), func2Container: document.getElementById('func2-container'),
            limitA: document.getElementById('limit-a'), limitB: document.getElementById('limit-b'), slices: document.getElementById('slices'), slicesValue: document.getElementById('slices-value'),
            opacitySlider: document.getElementById('opacity-slider'), opacityValue: document.getElementById('opacity-value'),
            formulaDiv: document.getElementById('formula'), volumeDiv: document.getElementById('volume'),
            colorPaletteBtn: document.getElementById('color-palette-btn'), colorPopover: document.getElementById('color-popover'), palettePresets: document.getElementById('palette-presets'),
            colorStart: document.getElementById('color-start'), colorEnd: document.getElementById('color-end'), themeBtn: document.getElementById('theme-btn'), themeModal: document.getElementById('theme-modal'),
            themeSelector: document.getElementById('theme-selector'), calculationModal: document.getElementById('calculation-modal'), approxVolumeDetails: document.getElementById('approx-volume-details'),
            exactVolumeDetails: document.getElementById('exact-volume-details'), showCalcBtn: document.getElementById('show-calc-btn'),
        };

        // --- INITIALIZATION ---
        function init() {
            // Populate UI
            Object.entries(AXES).forEach(([name, val]) => ui.rotationAxis.add(new Option(name, val)));
            
            Object.entries(PALETTES).forEach(([name, colors]) => {
                const btn = document.createElement('button');
                btn.className = 'h-8 rounded border-2 border-transparent focus:border-blue-500';
                btn.style.background = `linear-gradient(to right, ${colors[0]}, ${colors[1]})`;
                btn.onclick = () => { ui.colorStart.value = colors[0]; ui.colorEnd.value = colors[1]; updateGradientColors(); };
                ui.palettePresets.appendChild(btn);
            });
            
            Object.entries(THEMES).forEach(([name, className]) => {
                const btn = document.createElement('button');
                btn.textContent = name;
                btn.className = 'p-4 rounded-lg text-center font-semibold transition-transform hover:scale-105 aspect-video flex items-center justify-center';
                btn.onclick = () => applyTheme(className);
                const tempBody = document.createElement('body'); tempBody.className = className; document.head.append(tempBody);
                const style = getComputedStyle(tempBody);
                btn.style.backgroundColor = style.getPropertyValue('--bg-control');
                btn.style.color = style.getPropertyValue('--text-primary');
                btn.style.border = `2px solid ${style.getPropertyValue('--border-color')}`;
                tempBody.remove();
                ui.themeSelector.appendChild(btn);
            });

            // 3D Scene Setup
            scene = new THREE.Scene();
            const { width, height } = ui.plot3dContainer.getBoundingClientRect();
            camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
            camera.position.set(5, 5, 5);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(width, height);
            ui.plot3dContainer.appendChild(renderer.domElement);
            
            const ambientLight = new THREE.AmbientLight(0xffffff, 1.5); scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.5); directionalLight.position.set(5, 10, 7.5); scene.add(directionalLight);
            
            controls = new THREE.OrbitControls(camera, renderer.domElement); controls.enableDamping = true;
            solidGroup = new THREE.Group(); scene.add(solidGroup);
            
            labeledAxes = createLabeledAxes(10, 1);
            scene.add(labeledAxes);
            
            setupEventListeners();
            applyTheme('theme-light');
            updateAvailableMethods();
            generateVisualization();
            animate();
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            ui.rotationAxis.addEventListener('change', updateAvailableMethods);
            
            // Listener for the method dropdown to update UI and regenerate
            ui.method.addEventListener('change', () => {
                updateUI();
                generateVisualization();
            });

            // Listeners for other inputs that only need to regenerate the visualization
            [ui.func1, ui.func2, ui.limitA, ui.limitB].forEach(el => el.addEventListener('change', generateVisualization));
            
            ui.slices.addEventListener('input', () => ui.slicesValue.textContent = ui.slices.value);
            ui.slices.addEventListener('change', generateVisualization);
            
            ui.opacitySlider.addEventListener('input', (e) => {
                materialOpacity = parseFloat(e.target.value);
                ui.opacityValue.textContent = `${Math.round(materialOpacity * 100)}%`;
            });
            ui.opacitySlider.addEventListener('change', generateVisualization);

            ui.colorPaletteBtn.addEventListener('click', (e) => { e.stopPropagation(); ui.colorPopover.classList.toggle('hidden'); });
            document.addEventListener('click', (e) => { if (!ui.colorPopover.contains(e.target) && !ui.colorPaletteBtn.contains(e.target)) ui.colorPopover.classList.add('hidden'); });
            ui.colorStart.addEventListener('input', updateGradientColors);
            ui.colorEnd.addEventListener('input', updateGradientColors);

            setupModal(ui.themeBtn, ui.themeModal);
            setupModal(ui.showCalcBtn, ui.calculationModal);

            window.addEventListener('resize', onWindowResize, false);
        }

        function setupModal(button, modal) {
            const content = modal.querySelector('.modal-content');
            const closeBtns = modal.querySelectorAll('.close-modal-btn');
            button.addEventListener('click', () => { modal.classList.remove('hidden'); setTimeout(() => content.classList.remove('scale-95', 'opacity-0'), 10); });
            const closeModal = () => { content.classList.add('scale-95', 'opacity-0'); setTimeout(() => modal.classList.add('hidden'), 300); };
            closeBtns.forEach(btn => btn.addEventListener('click', closeModal));
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
        }
        
        // --- CORE LOGIC ---
        function generateVisualization() {
            solidGroup.clear();
            
            const method = ui.method.value;
            const rotationAxis = ui.rotationAxis.value;
            const f1 = math.compile(ui.func1.value);
            const f2 = method === 'washer' ? math.compile(ui.func2.value) : null;
            const a = parseFloat(ui.limitA.value);
            const b = parseFloat(ui.limitB.value);
            const n = parseInt(ui.slices.value, 10);

            if (!f1 || (method === 'washer' && !f2) || isNaN(a) || isNaN(b) || a >= b) return;

            const xValues = [], y1Values = [], y2Values = [];
            for (let i = 0; i <= 100; i++) {
                const x = a + (b - a) * i / 100;
                xValues.push(x);
                try {
                    const yVal1 = f1.evaluate({ x }); y1Values.push(isFinite(yVal1) ? yVal1 : null);
                    if (f2) { const yVal2 = f2.evaluate({ x }); y2Values.push(isFinite(yVal2) ? yVal2 : null); }
                } catch { y1Values.push(null); if (f2) y2Values.push(null); }
            }
            draw2DPlot(xValues, y1Values, y2Values, method);
            
            let approxVolume = 0;
            const delta = (b - a) / n;

            for (let i = 0; i < n; i++) {
                const x_mid = a + (i + 0.5) * delta;
                const color = new THREE.Color().lerpColors(gradientStart, gradientEnd, n > 1 ? i / (n - 1) : 1);
                const material = new THREE.MeshStandardMaterial({
                    color, side: THREE.DoubleSide, roughness: 0.6, metalness: 0.1,
                    transparent: materialOpacity < 1.0, opacity: materialOpacity
                });
                const edgeMaterial = new THREE.LineBasicMaterial({ color: new THREE.Color(0x000000), transparent: true, opacity: materialOpacity * 0.5 });


                try {
                    const r1 = Math.abs(f1.evaluate({ x: x_mid }));
                    if (!isFinite(r1)) continue;

                    let element;
                    if (rotationAxis === 'x' && (method === 'disk' || method === 'washer')) {
                         if (method === 'disk') {
                            const geometry = new THREE.CylinderGeometry(r1, r1, delta, 48);
                            geometry.rotateZ(Math.PI / 2);
                            element = new THREE.Mesh(geometry, material);
                            element.position.set(x_mid, 0, 0);
                            approxVolume += Math.PI * r1**2 * delta;
                        } else { // Washer
                            const r2 = Math.abs(f2.evaluate({ x: x_mid }));
                            if (!isFinite(r2)) continue;
                            const [outerR, innerR] = [Math.max(r1, r2), Math.min(r1, r2)];
                            const shape = new THREE.Shape().absarc(0, 0, outerR, 0, Math.PI * 2, false);
                            shape.holes.push(new THREE.Path().absarc(0, 0, innerR, 0, Math.PI * 2, true));
                            const geometry = new THREE.ExtrudeGeometry(shape, { depth: delta, bevelEnabled: false });
                            geometry.rotateY(Math.PI / 2);
                            element = new THREE.Mesh(geometry, material);
                            element.position.set(x_mid, 0, 0);
                            approxVolume += Math.PI * (outerR**2 - innerR**2) * delta;
                        }
                    } else if (rotationAxis === 'y' && method === 'shell') {
                        const geometry = new THREE.CylinderGeometry(x_mid + delta / 2, x_mid - delta / 2, r1, 48, 1, false);
                        element = new THREE.Mesh(geometry, material);
                        element.position.set(0, r1 / 2, 0);
                        approxVolume += 2 * Math.PI * x_mid * r1 * delta;
                    }
                    
                    if (element) {
                        element.add(new THREE.LineSegments(new THREE.EdgesGeometry(element.geometry), edgeMaterial));
                        solidGroup.add(element);
                    }
                } catch (e) { console.warn(e); }
            }
            updateCalculations(method, rotationAxis, a, b, n, approxVolume);
        }

        // --- UI & THEME MANAGEMENT ---
        function updateAvailableMethods() {
            const axis = ui.rotationAxis.value;
            const currentMethod = ui.method.value;
            ui.method.innerHTML = ''; // Clear options
            
            if (axis === 'x') {
                // For X-axis rotation, Disks and Washers are standard
                ui.method.add(new Option('Discos', 'disk'));
                ui.method.add(new Option('Arandelas', 'washer'));
                ui.method.value = (currentMethod === 'disk' || currentMethod === 'washer') ? currentMethod : 'disk';
            } else { // axis === 'y'
                // For Y-axis rotation, Shells are standard
                ui.method.add(new Option('Cascarones Cil√≠ndricos', 'shell'));
                ui.method.value = 'shell';
            }
            updateUI();
            generateVisualization();
        }

        function updateUI() {
            ui.func2Container.classList.toggle('hidden', ui.method.value !== 'washer');
        }

        function applyTheme(themeClass) {
            ui.body.className = themeClass;
            // Update axes colors based on new theme
            if(labeledAxes) {
                scene.remove(labeledAxes);
                labeledAxes = createLabeledAxes(10, 1);
                scene.add(labeledAxes);
            }
            updatePlotBackgrounds();
        }

        function updateGradientColors() {
            gradientStart.set(ui.colorStart.value);
            gradientEnd.set(ui.colorEnd.value);
            generateVisualization();
        }

        // --- PLOTTING & RENDERING ---
        function createLabeledAxes(size, divisions) {
            const axes = new THREE.Group();
            const style = getComputedStyle(document.body);
            const secondaryTextColor = style.getPropertyValue('--text-secondary').trim();

            function makeTextSprite(message, opts = {}) {
                const {
                    fontface = 'Inter, sans-serif',
                    fontsize = 64,
                    textColor = secondaryTextColor,
                    scale = 0.3
                } = opts;

                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                
                context.font = `Bold ${fontsize}px ${fontface}`;
                const metrics = context.measureText(message);
                const textWidth = metrics.width;

                canvas.width = textWidth;
                canvas.height = fontsize * 1.2;

                context.font = `Bold ${fontsize}px ${fontface}`;
                context.fillStyle = textColor;
                context.textAlign = 'center';
                context.textBaseline = 'middle';
                context.fillText(message, canvas.width / 2, canvas.height / 2);

                const texture = new THREE.Texture(canvas);
                texture.minFilter = THREE.LinearFilter;
                texture.needsUpdate = true;
                
                const spriteMaterial = new THREE.SpriteMaterial({ map: texture });
                const sprite = new THREE.Sprite(spriteMaterial);
                
                const aspect = canvas.width / canvas.height;
                sprite.scale.set(scale * aspect, scale, 1);
                
                return sprite;
            }

            // Axis lines
            axes.add(new THREE.Line(new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(-size, 0, 0), new THREE.Vector3(size, 0, 0)]), new THREE.LineBasicMaterial({ color: 0xff3333, transparent: true, opacity: 0.8 })));
            axes.add(new THREE.Line(new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0, -size, 0), new THREE.Vector3(0, size, 0)]), new THREE.LineBasicMaterial({ color: 0x33ff33, transparent: true, opacity: 0.8 })));
            axes.add(new THREE.Line(new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0, 0, -size), new THREE.Vector3(0, 0, size)]), new THREE.LineBasicMaterial({ color: 0x3333ff, transparent: true, opacity: 0.8 })));

            // Axis labels (X, Y, Z)
            const xLabel = makeTextSprite("X", { fontsize: 96, textColor: '#ff3333', scale: 0.5 });
            xLabel.position.set(size + 0.8, 0, 0);
            axes.add(xLabel);
            const yLabel = makeTextSprite("Y", { fontsize: 96, textColor: '#33ff33', scale: 0.5 });
            yLabel.position.set(0, size + 0.8, 0);
            axes.add(yLabel);
            const zLabel = makeTextSprite("Z", { fontsize: 96, textColor: '#3333ff', scale: 0.5 });
            zLabel.position.set(0, 0, size + 0.8);
            axes.add(zLabel);
            
            // Ticks and numbers
            const tickSize = 0.2;
            const tickMaterial = new THREE.LineBasicMaterial({ color: secondaryTextColor });
            for (let i = -size; i <= size; i += divisions) {
                if (i === 0) continue;
                
                // X-axis
                axes.add(new THREE.Line(new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(i, -tickSize, 0), new THREE.Vector3(i, tickSize, 0)]), tickMaterial));
                const xNum = makeTextSprite(String(i));
                xNum.position.set(i, -tickSize - 0.4, 0);
                axes.add(xNum);

                // Y-axis
                axes.add(new THREE.Line(new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(-tickSize, i, 0), new THREE.Vector3(tickSize, i, 0)]), tickMaterial));
                const yNum = makeTextSprite(String(i));
                yNum.position.set(-tickSize - 0.5, i, 0);
                axes.add(yNum);

                // Z-axis
                axes.add(new THREE.Line(new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(-tickSize, 0, i), new THREE.Vector3(tickSize, 0, i)]), tickMaterial));
                const zNum = makeTextSprite(String(i));
                zNum.position.set(tickSize, 0, i);
                axes.add(zNum);
            }
            return axes;
        }

        function onWindowResize() {
            const { width, height } = ui.plot3dContainer.getBoundingClientRect();
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
            updatePlotBackgrounds();
        }

        function updatePlotBackgrounds() {
            const plotDiv = document.getElementById('plot-2d');
            if (!plotDiv.data) return;
            
            const style = getComputedStyle(ui.body);
            const bgColor = style.getPropertyValue('--bg-control').trim();
            const textColor = style.getPropertyValue('--text-primary').trim();
            const gridColor = style.getPropertyValue('--border-color').trim();

            scene.background = new THREE.Color(bgColor);
            Plotly.relayout('plot-2d', {
                paper_bgcolor: bgColor, plot_bgcolor: bgColor, 'font.color': textColor,
                'xaxis.gridcolor': gridColor, 'yaxis.gridcolor': gridColor,
                'xaxis.zerolinecolor': gridColor, 'yaxis.zerolinecolor': gridColor,
            });
        }

        function draw2DPlot(x, y1, y2, method) {
            const traces = [{ x, y: y1, mode: 'lines', line: { color: '#3b82f6', width: 3 }, name: 'f(x)', connectgaps: true }];
            if (method === 'washer') {
                traces.push({ x, y: y2, mode: 'lines', line: { color: '#ef4444', width: 3 }, name: 'g(x)', connectgaps: true });
                traces.push({ x: x.concat(x.slice().reverse()), y: y1.concat(y2.slice().reverse()), fill: 'toself', fillcolor: 'rgba(239, 68, 68, 0.3)', line: { color: 'transparent' } });
            } else {
                traces.push({ x, y: y1, fill: 'tozeroy', fillcolor: 'rgba(59, 130, 246, 0.3)', line: { color: 'transparent' } });
            }
            const layout = { margin: { l: 40, r: 20, b: 40, t: 20 }, xaxis: { title: 'x' }, yaxis: { title: 'y' }, showlegend: false };
            Plotly.newPlot('plot-2d', traces, layout, { responsive: true }).then(updatePlotBackgrounds);
        }

        function updateCalculations(method, axis, a, b, n, approxVol) {
            const f1_str = ui.func1.value.replace(/\*/g, '');
            const f2_str = ui.func2.value.replace(/\*/g, '');
            let formulaStr = 'V = ', approxFormula = `$$V_{aprox} = \\sum_{i=1}^{${n}} `, integrandStr = '';

            if (axis === 'x' && method === 'disk') {
                formulaStr += `\\pi \\int_{${a}}^{${b}} \\left(${f1_str}\\right)^2 \\, dx`;
                approxFormula += `\\pi (f(x_i))^2 \\Delta x$$`;
                integrandStr = `pi * (${f1_str})^2`;
            } else if (axis === 'x' && method === 'washer') {
                formulaStr += `\\pi \\int_{${a}}^{${b}} \\left[ \\left(${f1_str}\\right)^2 - \\left(${f2_str}\\right)^2 \\right] \\, dx`;
                approxFormula += `\\pi ((f(x_i))^2 - (g(x_i))^2) \\Delta x$$`;
                integrandStr = `pi * ((${f1_str})^2 - (${f2_str})^2)`;
            } else if (axis === 'y' && method === 'shell') {
                 formulaStr += `2\\pi \\int_{${a}}^{${b}} x \\left(${f1_str}\\right) \\, dx`;
                 approxFormula += `2\\pi x_i f(x_i) \\Delta x$$`;
                 integrandStr = `2 * pi * x * (${f1_str})`;
            }
            
            let exactVolText = '';
            if (integrandStr) {
                try {
                    const exactVol = math.integral(integrandStr, 'x').evaluate({x: b}) - math.integral(integrandStr, 'x').evaluate({x: a});
                    exactVolText = `$$V = ${math.format(exactVol, {notation: 'fixed', precision: 5})} \\text{ u}^3$$`;
                } catch (e) { exactVolText = `<p class="text-sm text-red-500">C√°lculo simb√≥lico no disponible.</p>`; }
            }
            
            ui.formulaDiv.innerHTML = `$$${formulaStr}$$`;
            ui.volumeDiv.innerHTML = `$$V \\approx ${approxVol.toFixed(5)} \\text{ u}^3$$`;
            ui.approxVolumeDetails.innerHTML = `<p>La f√≥rmula de la suma de Riemann para esta configuraci√≥n es:</p><div class="math-container text-center my-2 p-3 bg-[var(--bg-input)] rounded-md">${approxFormula}</div><p>Donde $\\Delta x = \\frac{b-a}{n} = \\frac{${b}-${a}}{${n}} = ${((b-a)/n).toFixed(4)}$ y $x_i$ es el punto medio de cada subintervalo.</p>`;
            ui.exactVolumeDetails.innerHTML = `<p>El volumen exacto se calcula con la integral definida:</p><div class="math-container text-center my-2 p-3 bg-[var(--bg-input)] rounded-md">$$${formulaStr}$$</div><p class="font-bold text-lg mt-3">Resultado: ${exactVolText}</p>`;

            if (window.MathJax?.typesetPromise) {
                window.MathJax.typesetPromise([ui.formulaDiv, ui.volumeDiv, ui.approxVolumeDetails, ui.exactVolumeDetails])
                    .catch(err => console.error("Error al renderizar MathJax:", err));
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        window.onload = init;
    </script>
</body>
</html>
