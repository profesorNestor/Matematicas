<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Vol√∫menes de Revoluci√≥n PRO</title>
    
    <!-- Scripts de Librer√≠as -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.5.0/math.min.js"></script>
    <script>
        MathJax = { tex: { inlineMath: [['$', '$']] }, svg: { fontCache: 'global' } };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">


    <style>
        /* Definici√≥n de variables de CSS para Theming */
        :root {
            --bg-primary: #ffffff; --bg-secondary: #f0f2f5; --bg-control: #ffffff; --bg-modal: #ffffff; --bg-input: #ffffff; --bg-hover: #f9fafb;
            --text-primary: #1f2937; --text-secondary: #4b5563; --border-color: #d1d5db;
            --accent-color: #4f46e5; --accent-hover: #4338ca; --shadow-color: rgba(0, 0, 0, 0.1);
        }
        body.theme-dark {
            --bg-primary: #111827; --bg-secondary: #030712; --bg-control: #1f2937; --bg-modal: #1f2937; --bg-input: #374151; --bg-hover: #374151;
            --text-primary: #f9fafb; --text-secondary: #d1d5db; --border-color: #4b5563;
            --accent-color: #6366f1; --accent-hover: #818cf8; --shadow-color: rgba(0, 0, 0, 0.4);
        }
        body.theme-midnight {
            --bg-primary: #1e293b; --bg-secondary: #0f172a; --bg-control: #334155; --bg-modal: #334155; --bg-input: #475569; --bg-hover: #475569;
            --text-primary: #f1f5f9; --text-secondary: #cbd5e1; --border-color: #64748b;
            --accent-color: #818cf8; --accent-hover: #a5b4fc; --shadow-color: rgba(0, 0, 0, 0.4);
        }
        body.theme-sepia {
            --bg-primary: #fbf5e9; --bg-secondary: #f3eade; --bg-control: #efe3d0; --bg-modal: #efe3d0; --bg-input: #fbf5e9; --bg-hover: #e9dccb;
            --text-primary: #5d4037; --text-secondary: #795548; --border-color: #bcaaa4;
            --accent-color: #8d6e63; --accent-hover: #795548; --shadow-color: rgba(93, 64, 55, 0.2);
        }
        body.theme-mint {
            --bg-primary: #f0fdfa; --bg-secondary: #ccfbf1; --bg-control: #f0fdfa; --bg-modal: #f0fdfa; --bg-input: #ffffff; --bg-hover: #dcfce7;
            --text-primary: #0f766e; --text-secondary: #115e59; --border-color: #99f6e4;
            --accent-color: #14b8a6; --accent-hover: #0d9488; --shadow-color: rgba(13, 148, 136, 0.1);
        }
        body.theme-cherry {
            --bg-primary: #fff1f2; --bg-secondary: #ffe4e6; --bg-control: #fff1f2; --bg-modal: #fff1f2; --bg-input: #ffffff; --bg-hover: #ffe4e6;
            --text-primary: #be123c; --text-secondary: #9f1239; --border-color: #fecdd3;
            --accent-color: #f43f5e; --accent-hover: #e11d48; --shadow-color: rgba(225, 29, 72, 0.1);
        }
        body.theme-galaxy {
            --bg-primary: #1e1b4b; --bg-secondary: #1b193a; --bg-control: #312e81; --bg-modal: #312e81; --bg-input: #4338ca; --bg-hover: #4338ca;
            --text-primary: #e0e7ff; --text-secondary: #c7d2fe; --border-color: #5b21b6;
            --accent-color: #a78bfa; --accent-hover: #c4b5fd; --shadow-color: rgba(67, 56, 202, 0.4);
        }
        body.theme-coffee {
            --bg-primary: #2d1e18; --bg-secondary: #1e120d; --bg-control: #402b23; --bg-modal: #402b23; --bg-input: #573d33; --bg-hover: #573d33;
            --text-primary: #f5e9e2; --text-secondary: #d4c4b8; --border-color: #714e3d;
            --accent-color: #a16207; --accent-hover: #c87d0a; --shadow-color: rgba(87, 61, 51, 0.4);
        }

        /* Aplicar variables */
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-secondary); color: var(--text-primary); }
        .control-panel, .plot-panel, .modal-content, #color-popover { background-color: var(--bg-control); box-shadow: 0 10px 15px -3px var(--shadow-color), 0 4px 6px -2px var(--shadow-color); }
        .modal-content { background-color: var(--bg-modal); }
        input, select { background-color: var(--bg-input); border-color: var(--border-color); color: var(--text-primary); }
        input[type="range"] { accent-color: var(--accent-color); }
        .btn-primary { background-color: var(--accent-color); &:hover { background-color: var(--accent-hover); } }
        
        /* Estilos adicionales */
        #plot-2d, #plot-3d canvas { width: 100% !important; height: 100% !important; }
        select:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Estilos para el panel de control 3D */
        #view-controls-panel {
            background-color: rgba(var(--bg-control-rgb), 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .control-switch {
            width: 44px; height: 24px; background-color: var(--bg-input);
            border-radius: 9999px; position: relative; cursor: pointer;
            border: 1px solid var(--border-color);
        }
        .control-switch .slider {
            position: absolute; top: 2px; left: 2px; width: 18px; height: 18px;
            background-color: var(--text-secondary); border-radius: 50%;
            transition: transform 0.2s ease-in-out;
        }
        .control-switch.active .slider { transform: translateX(20px); background-color: var(--accent-color); }
    </style>
</head>
<body class="theme-light">

    <div class="container mx-auto p-4 md:p-6 flex flex-col min-h-screen">
        <main class="flex-grow">
            <header class="text-center mb-6">
                <h1 class="text-3xl md:text-4xl font-bold">Simulador Interactivo de Vol√∫menes</h1>
                <p class="text-md text-[var(--text-secondary)] mt-2">M√©todos de Discos, Arandelas y Cascarones Cil√≠ndricos</p>
            </header>

            <div class="flex flex-col lg:flex-row gap-6">

                <!-- Panel de Controles -->
                <div class="w-full lg:w-1/3 p-6 rounded-xl control-panel relative">
                    <div class="flex justify-between items-center border-b pb-2 mb-4 border-[var(--border-color)]">
                        <h2 class="text-xl font-semibold">Controles</h2>
                        <div class="flex gap-2">
                            <button id="color-palette-btn" title="Cambiar Paleta de Colores" class="p-2 rounded-full hover:bg-[var(--bg-hover)] transition-colors">üé®</button>
                            <button id="theme-btn" title="Cambiar Tema de Interfaz" class="p-2 rounded-full hover:bg-[var(--bg-hover)] transition-colors">üëï</button>
                        </div>
                    </div>
                    
                    <!-- Popover de Colores -->
                    <div id="color-popover" class="absolute top-16 right-6 w-64 p-4 rounded-lg shadow-xl z-20 hidden">
                        <h4 class="font-semibold mb-2">Gradiente de Color</h4>
                        <div class="flex items-center gap-2 mb-2">
                            <input type="checkbox" id="rainbow-toggle" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <label for="rainbow-toggle" class="text-sm">Usar Arco√≠ris</label>
                        </div>
                        <div id="palette-presets" class="grid grid-cols-3 gap-2 mb-4"></div>
                        <h4 class="font-semibold mb-2">Personalizado</h4>
                        <div class="flex gap-2 items-center">
                            <input type="color" id="color-start" class="w-full h-8 p-0 border-none rounded cursor-pointer" value="#3b82f6">
                            <span>‚Üí</span>
                            <input type="color" id="color-end" class="w-full h-8 p-0 border-none rounded cursor-pointer" value="#a855f7">
                        </div>
                    </div>

                    <!-- Controles -->
                    <div class="space-y-4">
                        <div>
                            <label for="rotation-axis" class="block text-sm font-medium text-[var(--text-secondary)] mb-1">Eje de Rotaci√≥n</label>
                            <select id="rotation-axis" class="w-full p-2 border rounded-md shadow-sm focus:ring-[var(--accent-color)] focus:border-[var(--accent-color)]"></select>
                        </div>
                        <div>
                            <label for="method" class="block text-sm font-medium text-[var(--text-secondary)] mb-1">M√©todo de C√°lculo</label>
                            <select id="method" class="w-full p-2 border rounded-md shadow-sm focus:ring-[var(--accent-color)] focus:border-[var(--accent-color)]"></select>
                        </div>
                        <div>
                            <label for="func1" class="block text-sm font-medium text-[var(--text-secondary)]">Funci√≥n y = f(x)</label>
                            <input type="text" id="func1" value="sqrt(x)" class="mt-1 w-full p-2 border rounded-md shadow-sm">
                        </div>
                        <div id="func2-container" class="hidden">
                            <label for="func2" class="block text-sm font-medium text-[var(--text-secondary)]">Funci√≥n y = g(x)</label>
                            <input type="text" id="func2" value="x/2" class="mt-1 w-full p-2 border rounded-md shadow-sm">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="limit-a" class="block text-sm font-medium text-[var(--text-secondary)]">L√≠mite a</label>
                                <input type="number" id="limit-a" value="0" step="0.1" class="mt-1 w-full p-2 border rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="limit-b" class="block text-sm font-medium text-[var(--text-secondary)]">L√≠mite b</label>
                                <input type="number" id="limit-b" value="4" step="0.1" class="mt-1 w-full p-2 border rounded-md shadow-sm">
                            </div>
                        </div>
                        <div>
                            <label for="slices" class="block text-sm font-medium text-[var(--text-secondary)]">N√∫mero de Elementos: <span id="slices-value" class="font-bold">20</span></label>
                            <input type="range" id="slices" min="2" max="100" value="20" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        </div>
                         <div>
                            <label for="opacity-slider" class="block text-sm font-medium text-[var(--text-secondary)]">Opacidad del S√≥lido: <span id="opacity-value" class="font-bold">100%</span></label>
                            <input type="range" id="opacity-slider" min="0.1" max="1" step="0.05" value="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        </div>
                        <div id="result-container" class="mt-4 p-4 bg-[var(--bg-secondary)] rounded-lg border border-[var(--border-color)]">
                            <h3 class="font-semibold text-lg mb-2">F√≥rmula y Volumen</h3>
                            <div id="formula" class="text-center text-lg overflow-x-auto"></div>
                            <div id="volume" class="text-center text-lg font-bold mt-2"></div>
                            <button id="show-calc-btn" class="mt-4 w-full bg-[var(--text-secondary)] text-[var(--bg-primary)] font-semibold py-2 px-4 rounded-md hover:opacity-80 transition">
                                Ver Detalles del C√°lculo
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Panel de Visualizaci√≥n -->
                <div class="w-full lg:w-2/3 flex flex-col gap-6">
                    <div class="p-4 rounded-xl plot-panel flex-1">
                        <h2 class="text-xl font-semibold mb-2 text-center">1. Regi√≥n Plana a Rotar</h2>
                        <div id="plot-2d" class="w-full h-64 md:h-full min-h-[300px]"></div>
                    </div>
                    <div class="p-4 rounded-xl plot-panel flex-1 relative">
                        <h2 class="text-xl font-semibold mb-2 text-center">2. S√≥lido de Revoluci√≥n</h2>
                        <div id="plot-3d" class="w-full h-64 md:h-full min-h-[400px] cursor-move"></div>
                        
                        <!-- Bot√≥n para mostrar controles del visor -->
                        <button id="show-view-controls-btn" class="absolute top-4 left-4 z-10 p-2 rounded-full bg-[var(--bg-control)] shadow-lg text-2xl text-[var(--accent-color)] hover:bg-[var(--bg-hover)] transition-colors">‚öôÔ∏è</button>

                        <!-- Panel de Control 3D Flotante -->
                        <div id="view-controls-panel" class="absolute top-16 left-4 w-52 rounded-lg shadow-lg border border-[var(--border-color)] hidden p-4 space-y-3">
                            <div class="flex justify-between items-center">
                                <label class="text-sm">Zoom</label>
                                <div class="flex gap-1">
                                    <button id="zoom-in-btn" class="px-2 py-1 rounded bg-[var(--bg-hover)]"><i class="fas fa-search-plus"></i></button>
                                    <button id="zoom-out-btn" class="px-2 py-1 rounded bg-[var(--bg-hover)]"><i class="fas fa-search-minus"></i></button>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <label class="text-sm">Mostrar Rejilla</label>
                                <div id="toggle-grid" class="control-switch active"><div class="slider"></div></div>
                            </div>
                            <div class="flex justify-between items-center">
                                <label class="text-sm">Permitir Rotaci√≥n</label>
                                <div id="toggle-rotate" class="control-switch active"><div class="slider"></div></div>
                            </div>
                            <div class="flex justify-between items-center">
                                <label class="text-sm">Permitir Paneo</label>
                                <div id="toggle-pan" class="control-switch active"><div class="slider"></div></div>
                            </div>
                            <button id="reset-view-btn" class="w-full mt-2 py-2 px-4 rounded-md bg-[var(--accent-color)] text-white font-semibold text-sm">
                                <i class="fas fa-sync-alt mr-2"></i>Reiniciar Vista
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <footer class="text-center p-4 mt-8 text-[var(--text-secondary)] text-sm">
            <p>Autor: Msc N√©stor Fabio Montoya Palacios &amp; Gemini AI</p>
        </footer>
    </div>
    
    <!-- Modals -->
    <div id="calculation-modal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="modal-content rounded-2xl w-full max-w-4xl max-h-[90vh] flex flex-col transform transition-all duration-300 scale-95 opacity-0">
            <div class="flex justify-between items-center p-5 border-b border-[var(--border-color)]">
                <h2 class="text-2xl font-bold">Desglose Detallado del C√°lculo</h2>
                <button class="close-modal-btn text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition text-3xl leading-none">&times;</button>
            </div>
            <div class="p-6 space-y-6 overflow-y-auto modal-body">
                <!-- Card de Volumen Aproximado -->
                <div class="bg-[var(--bg-secondary)] p-5 rounded-lg border border-[var(--border-color)]">
                    <h3 class="font-semibold text-xl mb-3">Volumen Aproximado (Suma de Riemann)</h3>
                    <div id="approx-volume-details" class="space-y-4 text-[var(--text-secondary)]"></div>
                </div>
                <!-- Card de Volumen Exacto -->
                <div class="bg-[var(--bg-secondary)] p-5 rounded-lg border border-[var(--border-color)]">
                     <h3 class="font-semibold text-xl mb-3">Volumen Exacto (Integral Definida)</h3>
                    <div id="exact-volume-details" class="space-y-4 text-[var(--text-secondary)]"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="theme-modal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="modal-content rounded-2xl w-full max-w-lg max-h-[90vh] flex flex-col transform transition-all duration-300 scale-95 opacity-0">
            <div class="flex justify-between items-center p-5 border-b border-[var(--border-color)]">
                <h2 class="text-2xl font-bold">Seleccionar Tema</h2>
                <button class="close-modal-btn text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition text-3xl leading-none">&times;</button>
            </div>
            <div id="theme-selector" class="p-6 grid grid-cols-2 md:grid-cols-4 gap-4"></div>
        </div>
    </div>

    <script type="module">
        // --- GLOBAL STATE & CONFIG ---
        let scene, camera, renderer, controls, solidGroup, labeledAxes, groundPlane, gridHelper;
        let gradientStart = new THREE.Color("#3b82f6");
        let gradientEnd = new THREE.Color("#a855f7");
        let useRainbowColors = false;
        let materialOpacity = 1.0;

        const PALETTES = { "Oc√©ano": ["#0077b6", "#90e0ef"], "Atardecer": ["#f77f00", "#d62828"], "Bosque": ["#2d6a4f", "#b7e4c7"], "Ne√≥n": ["#ea00d9", "#0abdc6"], "Grises": ["#495057", "#dee2e6"] };
        const THEMES = { "Claro": "theme-light", "Oscuro": "theme-dark", "Medianoche": "theme-midnight", "Sepia": "theme-sepia", "Menta": "theme-mint", "Cereza": "theme-cherry", "Galaxia": "theme-galaxy", "Caf√©": "theme-coffee" };
        const AXES = { "Eje X": "x", "Eje Y": "y" };

        const ui = {
            body: document.body, plot3dContainer: document.getElementById('plot-3d'), method: document.getElementById('method'), rotationAxis: document.getElementById('rotation-axis'),
            func1: document.getElementById('func1'), func2: document.getElementById('func2'), func2Container: document.getElementById('func2-container'),
            limitA: document.getElementById('limit-a'), limitB: document.getElementById('limit-b'), slices: document.getElementById('slices'), slicesValue: document.getElementById('slices-value'),
            opacitySlider: document.getElementById('opacity-slider'), opacityValue: document.getElementById('opacity-value'),
            formulaDiv: document.getElementById('formula'), volumeDiv: document.getElementById('volume'),
            colorPaletteBtn: document.getElementById('color-palette-btn'), colorPopover: document.getElementById('color-popover'), palettePresets: document.getElementById('palette-presets'),
            rainbowToggle: document.getElementById('rainbow-toggle'),
            colorStart: document.getElementById('color-start'), colorEnd: document.getElementById('color-end'), themeBtn: document.getElementById('theme-btn'), themeModal: document.getElementById('theme-modal'),
            themeSelector: document.getElementById('theme-selector'), calculationModal: document.getElementById('calculation-modal'), approxVolumeDetails: document.getElementById('approx-volume-details'),
            exactVolumeDetails: document.getElementById('exact-volume-details'), showCalcBtn: document.getElementById('show-calc-btn'),
            showViewControlsBtn: document.getElementById('show-view-controls-btn'),
            viewControlsPanel: document.getElementById('view-controls-panel'),
            zoomInBtn: document.getElementById('zoom-in-btn'), zoomOutBtn: document.getElementById('zoom-out-btn'),
            toggleGrid: document.getElementById('toggle-grid'),
            toggleRotate: document.getElementById('toggle-rotate'), togglePan: document.getElementById('toggle-pan'),
            resetViewBtn: document.getElementById('reset-view-btn')
        };

        // --- INITIALIZATION ---
        function init() {
            // Populate UI
            Object.entries(AXES).forEach(([name, val]) => ui.rotationAxis.add(new Option(name, val)));
            
            Object.entries(PALETTES).forEach(([name, colors]) => {
                const btn = document.createElement('button');
                btn.className = 'h-8 rounded border-2 border-transparent focus:border-blue-500';
                btn.style.background = `linear-gradient(to right, ${colors[0]}, ${colors[1]})`;
                btn.onclick = () => { ui.colorStart.value = colors[0]; ui.colorEnd.value = colors[1]; updateGradientColors(); };
                ui.palettePresets.appendChild(btn);
            });
            
            Object.entries(THEMES).forEach(([name, className]) => {
                const btn = document.createElement('button');
                btn.textContent = name;
                btn.className = 'p-4 rounded-lg text-center font-semibold transition-transform hover:scale-105 aspect-video flex items-center justify-center';
                btn.onclick = () => applyTheme(className);
                const tempBody = document.createElement('body'); tempBody.className = className; document.head.append(tempBody);
                const style = getComputedStyle(tempBody);
                btn.style.backgroundColor = style.getPropertyValue('--bg-control');
                btn.style.color = style.getPropertyValue('--text-primary');
                btn.style.border = `2px solid ${style.getPropertyValue('--border-color')}`;
                const rgb = style.backgroundColor.match(/\d+/g).slice(0, 3).join(', ');
                btn.dataset.bgRgb = rgb;
                tempBody.remove();
                ui.themeSelector.appendChild(btn);
            });

            // 3D Scene Setup
            scene = new THREE.Scene();
            const { width, height } = ui.plot3dContainer.getBoundingClientRect();
            camera = new THREE.PerspectiveCamera(60, width / height, 0.1, 1000);
            camera.position.set(8, 8, 8);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(width, height);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            ui.plot3dContainer.appendChild(renderer.domElement);
            
            // Lighting
            const hemisphereLight = new THREE.HemisphereLight(0xffffff, 0x444444, 1.5);
            hemisphereLight.position.set(0, 20, 0);
            scene.add(hemisphereLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.5);
            directionalLight.position.set(10, 20, 5);
            directionalLight.castShadow = true;
            directionalLight.shadow.camera.top = 10; directionalLight.shadow.camera.bottom = -10;
            directionalLight.shadow.camera.left = -10; directionalLight.shadow.camera.right = 10;
            directionalLight.shadow.mapSize.width = 2048; directionalLight.shadow.mapSize.height = 2048;
            scene.add(directionalLight);
            
            // Ground
            const planeGeometry = new THREE.PlaneGeometry(20, 20);
            const planeMaterial = new THREE.ShadowMaterial({ opacity: 0.3 });
            groundPlane = new THREE.Mesh(planeGeometry, planeMaterial);
            groundPlane.rotation.x = -Math.PI / 2;
            groundPlane.receiveShadow = true;
            scene.add(groundPlane);

            gridHelper = new THREE.GridHelper(20, 20);
            scene.add(gridHelper);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            
            solidGroup = new THREE.Group();
            scene.add(solidGroup);
            
            labeledAxes = createLabeledAxes(10, 2);
            scene.add(labeledAxes);
            
            setupEventListeners();
            applyTheme('theme-light');
            updateAvailableMethods();
            generateVisualization();
            animate();
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            ui.rotationAxis.addEventListener('change', updateAvailableMethods);
            ui.method.addEventListener('change', () => { updateUI(); generateVisualization(); });
            [ui.func1, ui.func2, ui.limitA, ui.limitB].forEach(el => el.addEventListener('change', generateVisualization));
            ui.slices.addEventListener('input', () => ui.slicesValue.textContent = ui.slices.value);
            ui.slices.addEventListener('change', generateVisualization);
            
            ui.opacitySlider.addEventListener('input', (e) => {
                materialOpacity = parseFloat(e.target.value);
                ui.opacityValue.textContent = `${Math.round(materialOpacity * 100)}%`;
            });
            ui.opacitySlider.addEventListener('change', generateVisualization);

            ui.colorPaletteBtn.addEventListener('click', (e) => { e.stopPropagation(); ui.colorPopover.classList.toggle('hidden'); });
            document.addEventListener('click', (e) => { if (!ui.colorPopover.contains(e.target) && !ui.colorPaletteBtn.contains(e.target)) ui.colorPopover.classList.add('hidden'); });
            ui.rainbowToggle.addEventListener('change', (e) => { useRainbowColors = e.target.checked; generateVisualization(); });
            ui.colorStart.addEventListener('input', updateGradientColors);
            ui.colorEnd.addEventListener('input', updateGradientColors);

            setupModal(ui.themeBtn, ui.themeModal);
            setupModal(ui.showCalcBtn, ui.calculationModal);

            // 3D View Controls
            ui.showViewControlsBtn.addEventListener('click', () => {
                ui.viewControlsPanel.classList.toggle('hidden');
            });

            ui.zoomInBtn.addEventListener('click', () => {
                const scale = Math.pow(0.95, controls.zoomSpeed);
                const offset = new THREE.Vector3().subVectors(camera.position, controls.target);
                offset.multiplyScalar(scale);
                camera.position.copy(controls.target).add(offset);
            });
            ui.zoomOutBtn.addEventListener('click', () => {
                const scale = Math.pow(0.95, controls.zoomSpeed);
                const offset = new THREE.Vector3().subVectors(camera.position, controls.target);
                offset.multiplyScalar(1 / scale);
                camera.position.copy(controls.target).add(offset);
            });

            ui.resetViewBtn.addEventListener('click', () => { controls.reset(); });
            
            function setupSwitch(element, callback) {
                element.addEventListener('click', () => {
                    element.classList.toggle('active');
                    callback(element.classList.contains('active'));
                });
            }
            setupSwitch(ui.toggleGrid, (active) => {
                gridHelper.visible = active;
                groundPlane.visible = active;
            });
            setupSwitch(ui.toggleRotate, (active) => controls.enableRotate = active);
            setupSwitch(ui.togglePan, (active) => controls.enablePan = active);

            window.addEventListener('resize', onWindowResize, false);
        }

        function setupModal(button, modal) {
            const content = modal.querySelector('.modal-content');
            const closeBtns = modal.querySelectorAll('.close-modal-btn');
            button.addEventListener('click', () => { modal.classList.remove('hidden'); setTimeout(() => content.classList.remove('scale-95', 'opacity-0'), 10); });
            const closeModal = () => { content.classList.add('scale-95', 'opacity-0'); setTimeout(() => modal.classList.add('hidden'), 300); };
            closeBtns.forEach(btn => btn.addEventListener('click', closeModal));
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
        }
        
        // --- CORE LOGIC ---
        function generateVisualization() {
            solidGroup.clear();
            
            const method = ui.method.value;
            const rotationAxis = ui.rotationAxis.value;
            const f1 = math.compile(ui.func1.value);
            const f2 = method === 'washer' ? math.compile(ui.func2.value) : null;
            const a = parseFloat(ui.limitA.value);
            const b = parseFloat(ui.limitB.value);
            const n = parseInt(ui.slices.value, 10);

            if (!f1 || (method === 'washer' && !f2) || isNaN(a) || isNaN(b) || a >= b) return;

            const xValues = [], y1Values = [], y2Values = [];
            for (let i = 0; i <= 100; i++) {
                const x = a + (b - a) * i / 100;
                xValues.push(x);
                try {
                    const yVal1 = f1.evaluate({ x }); y1Values.push(isFinite(yVal1) ? yVal1 : null);
                    if (f2) { const yVal2 = f2.evaluate({ x }); y2Values.push(isFinite(yVal2) ? yVal2 : null); }
                } catch { y1Values.push(null); if (f2) y2Values.push(null); }
            }
            draw2DPlot(xValues, y1Values, y2Values, method);
            
            let approxVolume = 0;
            const delta = (b - a) / n;
            const calculationSteps = [];

            for (let i = 0; i < n; i++) {
                const x_mid = a + (i + 0.5) * delta;
                const color = new THREE.Color();
                if (useRainbowColors) {
                    color.setHSL(i / n, 0.9, 0.6);
                } else {
                    color.lerpColors(gradientStart, gradientEnd, n > 1 ? i / (n - 1) : 1);
                }

                const material = new THREE.MeshStandardMaterial({
                    color, side: THREE.DoubleSide, roughness: 0.4, metalness: 0.3,
                    transparent: materialOpacity < 1.0, opacity: materialOpacity
                });

                try {
                    const r1_val = f1.evaluate({ x: x_mid });
                    if (!isFinite(r1_val)) continue;
                    const r1 = Math.abs(r1_val);

                    let element;
                    let step = { i: i + 1, x_i: x_mid.toFixed(4), vol_i: 0 };

                    if (rotationAxis === 'x' && (method === 'disk' || method === 'washer')) {
                         if (method === 'disk') {
                            const geometry = new THREE.CylinderGeometry(r1, r1, delta, 48);
                            geometry.rotateZ(Math.PI / 2);
                            element = new THREE.Mesh(geometry, material);
                            element.position.set(x_mid, 0, 0);
                            step.vol_i = Math.PI * r1**2 * delta;
                            step.details = `r = |f(${step.x_i})| = ${r1.toFixed(4)}`;
                        } else { // Washer
                            const r2_val = f2.evaluate({ x: x_mid });
                            if (!isFinite(r2_val)) continue;
                            const r2 = Math.abs(r2_val);
                            const [outerR, innerR] = [Math.max(r1, r2), Math.min(r1, r2)];
                            const shape = new THREE.Shape().absarc(0, 0, outerR, 0, Math.PI * 2, false);
                            shape.holes.push(new THREE.Path().absarc(0, 0, innerR, 0, Math.PI * 2, true));
                            const geometry = new THREE.ExtrudeGeometry(shape, { depth: delta, bevelEnabled: false, steps: 1 });
                            geometry.center();
                            geometry.rotateY(Math.PI / 2);
                            element = new THREE.Mesh(geometry, material);
                            element.position.set(x_mid, 0, 0);
                            step.vol_i = Math.PI * (outerR**2 - innerR**2) * delta;
                            step.details = `R=${outerR.toFixed(4)}, r=${innerR.toFixed(4)}`;
                        }
                    } else if (rotationAxis === 'y' && method === 'shell') {
                        const geometry = new THREE.CylinderGeometry(x_mid, x_mid, r1, 48, 1, true);
                        element = new THREE.Mesh(geometry, material.clone());
                        element.position.set(0, r1 / 2, 0);
                        step.vol_i = 2 * Math.PI * x_mid * r1 * delta;
                        step.details = `r(radio)=${step.x_i}, h=${r1.toFixed(4)}`;
                    }
                    
                    if (element) {
                        element.castShadow = true;
                        element.receiveShadow = true;
                        solidGroup.add(element);
                        approxVolume += step.vol_i;
                        if (i < 5 || i > n - 3) calculationSteps.push(step); // Store first 5 and last 2
                    }
                } catch (e) { console.warn(e); }
            }
            updateCalculations(method, rotationAxis, a, b, n, approxVolume, calculationSteps);
        }

        // --- UI & THEME MANAGEMENT ---
        function updateAvailableMethods() {
            const axis = ui.rotationAxis.value;
            const currentMethod = ui.method.value;
            ui.method.innerHTML = '';
            
            if (axis === 'x') {
                ui.method.add(new Option('Discos', 'disk'));
                ui.method.add(new Option('Arandelas', 'washer'));
                ui.method.value = (currentMethod === 'disk' || currentMethod === 'washer') ? currentMethod : 'disk';
            } else {
                ui.method.add(new Option('Cascarones Cil√≠ndricos', 'shell'));
                ui.method.value = 'shell';
            }
            updateUI();
            generateVisualization();
        }

        function updateUI() {
            ui.func2Container.classList.toggle('hidden', ui.method.value !== 'washer');
        }

        function applyTheme(themeClass) {
            ui.body.className = themeClass;
            const themeBtn = Array.from(ui.themeSelector.children).find(btn => btn.textContent === Object.keys(THEMES).find(key => THEMES[key] === themeClass));
            if (themeBtn && themeBtn.dataset.bgRgb) {
                document.documentElement.style.setProperty('--bg-control-rgb', themeBtn.dataset.bgRgb);
            }
            if(labeledAxes) {
                scene.remove(labeledAxes);
                labeledAxes = createLabeledAxes(10, 2);
                scene.add(labeledAxes);
            }
            updatePlotBackgrounds();
        }

        function updateGradientColors() {
            useRainbowColors = false;
            ui.rainbowToggle.checked = false;
            gradientStart.set(ui.colorStart.value);
            gradientEnd.set(ui.colorEnd.value);
            generateVisualization();
        }

        // --- PLOTTING & RENDERING ---
        function createLabeledAxes(size, step) {
            const axesGroup = new THREE.Group();
            const style = getComputedStyle(document.body);
            const textColor = style.getPropertyValue('--text-primary').trim();
            const axisRadius = 0.05;
            const coneHeight = 0.4;
            const coneRadius = 0.15;

            const xMat = new THREE.MeshStandardMaterial({ color: 0xdc2626 });
            const yMat = new THREE.MeshStandardMaterial({ color: 0x16a34a });
            const zMat = new THREE.MeshStandardMaterial({ color: 0x2563eb });
            const tickMat = new THREE.MeshBasicMaterial({ color: textColor });

            function createAxis(direction, material) {
                const axis = new THREE.Group();
                const cylinderGeom = new THREE.CylinderGeometry(axisRadius, axisRadius, size, 8);
                const cylinder = new THREE.Mesh(cylinderGeom, material);
                const coneGeom = new THREE.ConeGeometry(coneRadius, coneHeight, 8);
                const cone = new THREE.Mesh(coneGeom, material);
                cone.position.y = size / 2;
                axis.add(cylinder, cone);
                if (direction === 'x') axis.rotation.z = -Math.PI / 2;
                else if (direction === 'z') axis.rotation.x = Math.PI / 2;
                return axis;
            }
            
            axesGroup.add(createAxis('x', xMat), createAxis('y', yMat), createAxis('z', zMat));

            function makeTextSprite(message, opts = {}) {
                const { fontface = 'Inter, sans-serif', fontsize = 64, color = textColor, scale = 0.3 } = opts;
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                context.font = `Bold ${fontsize}px ${fontface}`;
                const metrics = context.measureText(message);
                canvas.width = metrics.width; canvas.height = fontsize * 1.2;
                context.font = `Bold ${fontsize}px ${fontface}`;
                context.fillStyle = color;
                context.textAlign = 'center'; context.textBaseline = 'middle';
                context.fillText(message, canvas.width / 2, canvas.height / 2);
                const texture = new THREE.Texture(canvas);
                texture.minFilter = THREE.LinearFilter; texture.needsUpdate = true;
                const spriteMaterial = new THREE.SpriteMaterial({ map: texture, depthTest: false });
                const sprite = new THREE.Sprite(spriteMaterial);
                sprite.scale.set(scale * (canvas.width / canvas.height), scale, 1);
                return sprite;
            }
            
            const labelOffset = size / 2 + coneHeight + 0.5;
            
            const xLabel = makeTextSprite("X", { fontsize: 96, color: xMat.color.getStyle(), scale: 0.5 });
            xLabel.position.set(labelOffset, 0, 0);
            axesGroup.add(xLabel);

            const yLabel = makeTextSprite("Y", { fontsize: 96, color: yMat.color.getStyle(), scale: 0.5 });
            yLabel.position.set(0, labelOffset, 0);
            axesGroup.add(yLabel);

            const zLabel = makeTextSprite("Z", { fontsize: 96, color: zMat.color.getStyle(), scale: 0.5 });
            zLabel.position.set(0, 0, labelOffset);
            axesGroup.add(zLabel);


            // Ticks and Numbers
            const tickGeom = new THREE.CylinderGeometry(axisRadius * 1.5, axisRadius * 1.5, 0.2, 8);
            for (let i = -size/2 + step; i < size/2; i += step) {
                if (i === 0) continue;
                // X-axis
                const xTick = new THREE.Mesh(tickGeom.clone(), tickMat);
                xTick.position.x = i;
                xTick.rotation.z = Math.PI / 2;
                const xNum = makeTextSprite(String(i), {scale: 0.5});
                xNum.position.set(i, -0.7, 0);
                axesGroup.add(xTick, xNum);

                // Y-axis
                const yTick = new THREE.Mesh(tickGeom.clone(), tickMat);
                yTick.position.y = i;
                const yNum = makeTextSprite(String(i), {scale: 0.5});
                yNum.position.set(-0.7, i, 0);
                axesGroup.add(yTick, yNum);

                // Z-axis
                const zTick = new THREE.Mesh(tickGeom.clone(), tickMat);
                zTick.position.z = i;
                zTick.rotation.x = Math.PI / 2;
                const zNum = makeTextSprite(String(i), {scale: 0.5});
                zNum.position.set(0, -0.7, i);
                axesGroup.add(zTick, zNum);
            }
            
            return axesGroup;
        }

        function onWindowResize() {
            const { width, height } = ui.plot3dContainer.getBoundingClientRect();
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
            updatePlotBackgrounds();
        }

        function updatePlotBackgrounds() {
            const plotDiv = document.getElementById('plot-2d');
            if (!plotDiv.data) return;
            
            const style = getComputedStyle(ui.body);
            const bgColor = style.getPropertyValue('--bg-control').trim();
            const textColor = style.getPropertyValue('--text-primary').trim();
            const gridColor = style.getPropertyValue('--border-color').trim();

            scene.background = new THREE.Color(bgColor);
            gridHelper.material.color.set(gridColor); gridHelper.material.needsUpdate = true;
            
            Plotly.relayout('plot-2d', {
                paper_bgcolor: bgColor, plot_bgcolor: bgColor, 'font.color': textColor,
                'xaxis.gridcolor': gridColor, 'yaxis.gridcolor': gridColor,
                'xaxis.zerolinecolor': gridColor, 'yaxis.zerolinecolor': gridColor,
            });
        }

        function draw2DPlot(x, y1, y2, method) {
            const traces = [{ x, y: y1, mode: 'lines', line: { color: '#3b82f6', width: 3 }, name: 'f(x)', connectgaps: true }];
            if (method === 'washer') {
                traces.push({ x, y: y2, mode: 'lines', line: { color: '#ef4444', width: 3 }, name: 'g(x)', connectgaps: true });
                traces.push({ x: x.concat(x.slice().reverse()), y: y1.concat(y2.slice().reverse()), fill: 'toself', fillcolor: 'rgba(239, 68, 68, 0.3)', line: { color: 'transparent' } });
            } else {
                traces.push({ x, y: y1, fill: 'tozeroy', fillcolor: 'rgba(59, 130, 246, 0.3)', line: { color: 'transparent' } });
            }
            const layout = { margin: { l: 40, r: 20, b: 40, t: 20 }, xaxis: { title: 'x' }, yaxis: { title: 'y' }, showlegend: false };
            Plotly.newPlot('plot-2d', traces, layout, { responsive: true }).then(updatePlotBackgrounds);
        }

        function updateCalculations(method, axis, a, b, n, approxVol, steps) {
            const f1_str = ui.func1.value.replace(/\*/g, '');
            const f2_str = ui.method.value === 'washer' ? ui.func2.value.replace(/\*/g, '') : '';
            let formulaStr = 'V = ', approxFormula = '', integrandStr = '', method_name = '';

            if (axis === 'x' && method === 'disk') {
                method_name = 'Discos';
                formulaStr += `\\pi \\int_{${a}}^{${b}} \\left(${f1_str}\\right)^2 \\, dx`;
                approxFormula = `V_i = \\pi [f(x_i)]^2 \\Delta x`;
                integrandStr = `pi * (${f1_str})^2`;
            } else if (axis === 'x' && method === 'washer') {
                method_name = 'Arandelas';
                formulaStr += `\\pi \\int_{${a}}^{${b}} \\left[ \\left(${f1_str}\\right)^2 - \\left(${f2_str}\\right)^2 \\right] \\, dx`;
                approxFormula = `V_i = \\pi ([f(x_i)]^2 - [g(x_i)]^2) \\Delta x`;
                integrandStr = `pi * ((${f1_str})^2 - (${f2_str})^2)`;
            } else if (axis === 'y' && method === 'shell') {
                 method_name = 'Cascarones';
                 formulaStr += `2\\pi \\int_{${a}}^{${b}} x \\left(${f1_str}\\right) \\, dx`;
                 approxFormula = `V_i = 2\\pi x_i f(x_i) \\Delta x`;
                 integrandStr = `2 * pi * x * (${f1_str})`;
            }
            
            // --- Exact Volume ---
            let exactVolText = '', antiderivativeText = '';
            if (integrandStr) {
                try {
                    const antiderivativeNode = math.integral(integrandStr, 'x');
                    antiderivativeText = `$$F(x) = \\int \\left( ${antiderivativeNode.toTex()} \\right) \\, dx$$`;
                    const exactVol = antiderivativeNode.evaluate({x: b}) - antiderivativeNode.evaluate({x: a});
                    exactVolText = `$$V = F(${b}) - F(${a}) = ${math.format(exactVol, {notation: 'fixed', precision: 5})} \\text{ u}^3$$`;
                } catch (e) { 
                    exactVolText = `<p class="text-sm text-red-500">C√°lculo simb√≥lico no disponible para esta funci√≥n.</p>`; 
                    antiderivativeText = `<p class="text-sm text-red-500">No se pudo encontrar la antiderivada simb√≥lica.</p>`;
                }
            }
            
            // --- UI Update ---
            ui.formulaDiv.innerHTML = `$$${formulaStr}$$`;
            ui.volumeDiv.innerHTML = `$$V \\approx ${approxVol.toFixed(5)} \\text{ u}^3$$`;

            // --- Modal Content ---
            // Approx Volume
            const deltaX = (b - a) / n;
            const tableRows = steps.map(s => `<tr><td class="p-2 border-t">${s.i}</td><td class="p-2 border-t">${s.x_i}</td><td class="p-2 border-t">${s.details}</td><td class="p-2 border-t">${s.vol_i.toFixed(5)}</td></tr>`).join('');
            ui.approxVolumeDetails.innerHTML = `
                <p>El volumen se aproxima sumando el volumen de ${n} ${method_name}, cada uno con un grosor de $\\Delta x$. Esto es una <strong>Suma de Riemann</strong>.</p>
                <p>1. <strong>Grosor del elemento ($\\Delta x$):</strong> $$ \\Delta x = \\frac{b-a}{n} = \\frac{${b}-${a}}{${n}} = ${deltaX.toFixed(5)} $$</p>
                <p>2. <strong>F√≥rmula del volumen del elemento i-√©simo ($V_i$):</strong> $$ ${approxFormula} $$</p>
                <p>3. <strong>Suma total:</strong> $$ V_{aprox} = \\sum_{i=1}^{${n}} V_i $$</p>
                <h4 class="font-semibold text-lg mt-4">Ejemplo de C√°lculos de Elementos:</h4>
                <div class="overflow-x-auto"><table class="w-full text-sm text-left">
                    <thead class="bg-[var(--bg-input)]"><tr><th class="p-2">Elemento (i)</th><th class="p-2">Punto Medio (x_i)</th><th class="p-2">Dimensiones</th><th class="p-2">Volumen (V_i)</th></tr></thead>
                    <tbody>${tableRows}</tbody>
                </table></div>`;

            // Exact Volume
            ui.exactVolumeDetails.innerHTML = `
                <p>El volumen exacto se encuentra tomando el l√≠mite cuando el n√∫mero de elementos tiende a infinito ($n \\to \\infty$), lo que convierte la suma en una <strong>integral definida</strong>.</p>
                <p>1. <strong>Configuraci√≥n de la Integral:</strong> $$ ${formulaStr} $$</p>
                <p>2. <strong>Antiderivada (Integral Indefinida):</strong> Se busca una funci√≥n $F(x)$ tal que $F'(x)$ sea el integrando.</p>
                <div class="math-container text-center my-2 p-3 bg-[var(--bg-input)] rounded-md">${antiderivativeText}</div>
                <p>3. <strong>Teorema Fundamental del C√°lculo:</strong> Se eval√∫a la antiderivada en los l√≠mites de integraci√≥n.</p>
                <p class="font-bold text-lg mt-3 text-center">Resultado Final: ${exactVolText}</p>`;

            if (window.MathJax?.typesetPromise) {
                window.MathJax.typesetPromise([ui.formulaDiv, ui.volumeDiv, ui.approxVolumeDetails, ui.exactVolumeDetails])
                    .catch(err => console.error("Error al renderizar MathJax:", err));
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        window.onload = init;
    </script>
</body>
</html>
