<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explorador Interactivo del Triángulo de Pascal</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- MathJax for LaTeX Math Rendering -->
    <script>
        MathJax = {
          tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']]
          },
          svg: {
            fontCache: 'global'
          }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
    </script>
    
    <!-- Math.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/12.4.1/math.min.js"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">

    <style>
        /* --- Base Styles & Theme Variables --- */
        :root, [data-theme="cosmic"] {
            --bg-gradient-start: #1e1b4b; /* indigo-950 */
            --bg-gradient-mid: #581c87;   /* purple-900 */
            --bg-gradient-end: #831843;     /* pink-900 */
            --panel-bg: rgba(10, 5, 20, 0.3);
            --panel-border: rgba(168, 85, 247, 0.3); /* purple-500 */
            --button-bg: rgba(147, 51, 234, 0.7); /* purple-600 */
            --button-hover-bg: rgba(168, 85, 247, 0.9); /* purple-500 */
            --button-shadow: rgba(147, 51, 234, 0.5);
            --text-color: #e0e0e0;
            --accent-color: #d8b4fe; /* purple-300 */
            --cell-bg-start: rgba(168, 85, 247, 0.15);
            --cell-bg-end: rgba(219, 39, 119, 0.15);
            --cell-border: rgba(192, 132, 252, 0.4);
            --slider-thumb-bg: linear-gradient(45deg, #8b5cf6, #ec4899);
        }

        [data-theme="neon"] {
            --bg-gradient-start: #111827;
            --bg-gradient-mid: #1e3a8a;
            --bg-gradient-end: #581c87;
            --panel-bg: rgba(6, 78, 99, 0.25);
            --panel-border: rgba(34, 211, 238, 0.4);
            --button-bg: rgba(6, 182, 212, 0.7);
            --button-hover-bg: rgba(34, 211, 238, 0.9);
            --button-shadow: rgba(6, 182, 212, 0.5);
            --text-color: #ecfeff;
            --accent-color: #67e8f9;
            --cell-bg-start: rgba(34, 211, 238, 0.1);
            --cell-bg-end: rgba(59, 130, 246, 0.1);
            --cell-border: rgba(34, 211, 238, 0.5);
            --slider-thumb-bg: linear-gradient(45deg, #06b6d4, #3b82f6);
        }

        [data-theme="forest"] {
            --bg-gradient-start: #064e3b;
            --bg-gradient-mid: #065f46;
            --bg-gradient-end: #134e4a;
            --panel-bg: rgba(5, 46, 22, 0.3);
            --panel-border: rgba(16, 185, 129, 0.3);
            --button-bg: rgba(5, 150, 105, 0.8);
            --button-hover-bg: rgba(16, 185, 129, 0.9);
            --button-shadow: rgba(5, 150, 105, 0.5);
            --text-color: #d1fae5;
            --accent-color: #6ee7b7;
            --cell-bg-start: rgba(16, 185, 129, 0.1);
            --cell-bg-end: rgba(20, 83, 45, 0.15);
            --cell-border: rgba(16, 185, 129, 0.4);
            --slider-thumb-bg: linear-gradient(45deg, #10b981, #14b8a6);
        }

        [data-theme="sunset"] {
            --bg-gradient-start: #7c2d12;
            --bg-gradient-mid: #991b1b;
            --bg-gradient-end: #831843;
            --panel-bg: rgba(124, 45, 18, 0.3);
            --panel-border: rgba(249, 115, 22, 0.3);
            --button-bg: rgba(234, 88, 12, 0.8);
            --button-hover-bg: rgba(249, 115, 22, 0.9);
            --button-shadow: rgba(234, 88, 12, 0.5);
            --text-color: #fff7ed;
            --accent-color: #fdba74;
            --cell-bg-start: rgba(249, 115, 22, 0.1);
            --cell-bg-end: rgba(220, 38, 38, 0.1);
            --cell-border: rgba(249, 115, 22, 0.4);
            --slider-thumb-bg: linear-gradient(45deg, #f97316, #ef4444);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-image: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-mid), var(--bg-gradient-end));
            color: var(--text-color);
            transition: background-image 0.5s ease;
        }

        /* --- Custom Animated Background --- */
        @keyframes move-stars {
            from { transform: translateY(0px); }
            to   { transform: translateY(-2000px); }
        }
        .stars, .stars2, .stars3 {
            position: absolute; top: 0; right: 0; width: 100%; height: 100%; pointer-events: none;
        }
        .stars {
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="2000" height="2000"><circle cx="100" cy="100" r="1" fill="white"/><circle cx="300" cy="800" r="1.2" fill="white"/><circle cx="900" cy="200" r="0.8" fill="white"/><circle cx="1200" cy="1100" r="1.5" fill="white"/><circle cx="1800" cy="500" r="0.7" fill="white"/></svg>');
            animation: move-stars 150s linear infinite;
        }
        .stars2 {
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="2000" height="2000"><circle cx="500" cy="400" r="1" fill="white"/><circle cx="200" cy="1200" r="1.2" fill="white"/><circle cx="1100" cy="1500" r="0.8" fill="white"/><circle cx="1500" cy="900" r="1.5" fill="white"/><circle cx="1900" cy="1800" r="0.7" fill="white"/></svg>');
            animation: move-stars 100s linear infinite;
        }
        .stars3 {
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="2000" height="2000"><circle cx="800" cy="600" r="1" fill="white"/><circle cx="400" cy="1400" r="1.2" fill="white"/><circle cx="1300" cy="1800" r="0.8" fill="white"/><circle cx="1600" cy="200" r="1.5" fill="white"/><circle cx="100" cy="1900" r="0.7" fill="white"/></svg>');
            animation: move-stars 50s linear infinite;
        }

        /* --- Control Panel & Responsiveness --- */
        #control-panel {
            background: var(--panel-bg); backdrop-filter: blur(12px); border: 1px solid var(--panel-border);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), background-color 0.5s ease, border-color 0.5s ease;
            transform: translateX(0);
        }
        @media (max-width: 1024px) {
            #control-panel { transform: translateX(-110%); z-index: 50; }
            #control-panel.open { transform: translateX(0); }
            #app-container { padding-left: 1rem; }
            #menu-toggle { display: flex; }
        }

        /* --- General Component Styling --- */
        .control-button {
            background-color: var(--button-bg); color: white; font-weight: 600; border-radius: 0.75rem;
            transition: all 0.2s ease-out;
            box-shadow: 0 4px 15px -5px var(--button-shadow), inset 0 -2px 0 rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .control-button:hover {
            background-color: var(--button-hover-bg); transform: translateY(-2px);
            box-shadow: 0 8px 20px -6px var(--button-shadow), inset 0 -2px 0 rgba(0,0,0,0.2);
        }
        .control-button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 10px -5px var(--button-shadow), inset 0 1px 0 rgba(0,0,0,0.2);
        }
        input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; background: transparent; cursor: pointer; }
        input[type="range"]::-webkit-slider-runnable-track { height: 6px; background: rgba(0,0,0,0.4); border-radius: 3px; }
        input[type="range"]::-moz-range-track { height: 6px; background: rgba(0,0,0,0.4); border-radius: 3px; }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; margin-top: -7px; width: 20px; height: 20px;
            border-radius: 50%; background: var(--slider-thumb-bg); border: 2px solid white; box-shadow: 0 0 10px var(--button-shadow);
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px; height: 20px; border-radius: 50%; background: var(--slider-thumb-bg);
            border: 2px solid white; box-shadow: 0 0 10px var(--button-shadow);
        }
        .custom-select {
            background-color: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23d8b4fe' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 1em;
        }
        
        /* --- Triangle Cell Styling --- */
        .pascal-cell {
            background-image: linear-gradient(145deg, var(--cell-bg-start), var(--cell-bg-end));
            border: 1px solid var(--cell-border);
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .pascal-cell.grid-lines { border-width: 2px; }
        .pascal-cell:hover { transform: scale(1.1) translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.3); z-index: 10; }
        .pascal-cell.selected { transform: scale(1.15); box-shadow: 0 0 25px var(--button-shadow); border-color: var(--accent-color); }
        
        /* --- Animations --- */
        @keyframes row-pop-in { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .pascal-row { animation: row-pop-in 0.5s cubic-bezier(0.16, 1, 0.3, 1) both; }
        @keyframes ping-pong {
            0%, 100% { transform: scale(1); box-shadow: 0 0 25px var(--button-shadow); }
            50% { transform: scale(1.15); box-shadow: 0 0 35px var(--button-shadow); }
        }
        .pascal-cell.selected { animation: ping-pong 1.5s ease-in-out infinite; }
        
        /* --- Formulas Modal Styling --- */
        #formulas-modal {
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            transition: opacity 0.3s ease;
        }
        #modal-content {
            background: var(--panel-bg);
            border: 1px solid var(--panel-border);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1), background-color 0.5s ease, border-color 0.5s ease;
            transform: scale(0.95);
        }
        #formulas-modal.open #modal-content {
            transform: scale(1);
        }
        .binomial-card-style {
            background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0));
            border: 1px solid rgba(255,255,255,0.1);
        }
    </style>
</head>
<body class="bg-gray-900 overflow-hidden h-screen w-screen">

    <!-- Animated Background -->
    <div class="stars"></div><div class="stars2"></div><div class="stars3"></div>

    <!-- Main Application Wrapper -->
    <div id="app-wrapper" class="h-full w-full flex">
        
        <!-- Control Panel (Sidebar) -->
        <aside id="control-panel" class="fixed left-4 top-4 bottom-4 w-80 lg:w-96 rounded-2xl p-6 z-20 overflow-y-auto flex flex-col space-y-6 shadow-2xl">
            <!-- Header -->
            <div class="text-center flex-shrink-0">
                <h1 class="text-3xl font-bold mb-1 bg-gradient-to-r from-white via-purple-300 to-pink-300 bg-clip-text text-transparent">Triángulo de Pascal</h1>
                <p id="theme-accent-text" class="text-sm font-medium" style="color: var(--accent-color);">Explorador Matemático</p>
            </div>

            <!-- Controls -->
            <div class="flex-grow space-y-5 overflow-y-auto pr-2">
                <!-- Rows & Speed -->
                <div class="control-group space-y-4 p-4 bg-black/20 rounded-xl">
                    <div>
                        <label for="rows-slider" class="flex justify-between text-sm font-medium">Filas: <span id="rows-value">15</span></label>
                        <input id="rows-slider" type="range" min="5" max="30" value="15" class="w-full h-2 rounded-lg appearance-none cursor-pointer mt-2">
                    </div>
                    <div>
                        <label for="speed-slider" class="flex justify-between text-sm font-medium">Velocidad (ms): <span id="speed-value">100</span></label>
                        <input id="speed-slider" type="range" min="50" max="500" step="10" value="100" class="w-full h-2 rounded-lg appearance-none cursor-pointer mt-2">
                    </div>
                </div>

                <!-- Animation Controls -->
                <div class="control-group space-y-3">
                    <div class="flex gap-3">
                        <button id="toggle-animation-btn" class="control-button flex-1 py-2.5 flex items-center justify-center gap-2">
                            <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg>
                            <svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" class="hidden"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>
                            <span id="animation-btn-text">Animar</span>
                        </button>
                        <button id="reset-btn" class="control-button px-4 py-2.5" title="Reiniciar">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
                        </button>
                    </div>
                </div>

                <!-- View Controls -->
                <div class="control-group space-y-3 p-4 bg-black/20 rounded-xl">
                     <label class="block text-sm font-medium">Controles de Vista</label>
                     <div class="flex gap-2">
                        <button id="zoom-out-btn" class="control-button flex-1 py-2" title="Alejar"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg></button>
                        <button id="zoom-in-btn" class="control-button flex-1 py-2" title="Acercar"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg></button>
                        <button id="grid-btn" class="control-button flex-1 py-2" title="Mostrar/Ocultar Rejilla"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="3" y1="15" x2="21" y2="15"></line><line x1="9" y1="3" x2="9" y2="21"></line><line x1="15" y1="3" x2="15" y2="21"></line></svg></button>
                     </div>
                </div>
                
                <!-- Highlight & Formulas -->
                <div class="control-group space-y-3">
                    <select id="highlight-mode-select" class="custom-select w-full px-3 py-2.5 rounded-lg focus:border-white/40 focus:outline-none text-sm">
                        <option value="none">Resaltado: Ninguno</option>
                        <option value="even">Resaltar Pares</option>
                        <option value="odd">Resaltar Impares</option>
                        <option value="powers">Potencias de 2</option>
                        <option value="fibonacci">Sucesión de Fibonacci</option>
                        <option value="divisible">Divisibles por 3</option>
                    </select>
                    <button id="open-formulas-btn" class="control-button w-full py-2.5 flex items-center justify-center gap-2 text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                        <span>Mostrar Fórmulas</span>
                    </button>
                </div>
                
                <!-- Selected Cell Info -->
                <div id="selected-cell-info" class="space-y-2 pt-4 border-t border-white/10 hidden">
                    <label class="block text-sm font-medium">Celda Seleccionada</label>
                    <div class="bg-black/20 rounded-lg p-3 space-y-2 text-sm">
                        <p><span class="font-semibold">Posición:</span> <span id="cell-pos"></span></p>
                        <p><span class="font-semibold">Valor:</span> <span id="cell-value"></span></p>
                        <div id="cell-formula-container" class="text-base pt-2">
                           $C(n, k) = \frac{n!}{k!(n-k)!}$
                        </div>
                    </div>
                </div>
            </div>

            <!-- Theme Selector -->
            <div class="flex-shrink-0 pt-4 border-t border-white/10">
                <label class="block text-sm font-medium mb-2 text-center">Tema Visual</label>
                <div id="theme-selector" class="grid grid-cols-5 gap-2"></div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main id="app-container" class="flex-1 h-full overflow-hidden p-4 lg:pl-96 transition-all duration-300">
            <div id="triangle-viewport" class="w-full h-full overflow-auto flex items-center justify-center">
                <div id="triangle-container" class="flex flex-col items-center py-8 transition-transform duration-300"></div>
            </div>
        </main>
        
        <!-- Mobile Menu Toggle Button -->
        <button id="menu-toggle" class="control-button fixed top-4 left-4 z-30 w-12 h-12 items-center justify-center rounded-full hidden lg:hidden">
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        </button>

        <!-- Animation Progress Indicator -->
        <div id="animation-indicator" class="fixed bottom-4 right-4 bg-black/50 backdrop-blur-md rounded-lg p-3 shadow-lg hidden">
            <div class="flex items-center gap-3"><div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div><span id="animation-progress-text" class="text-sm"></span></div>
            <div class="w-full bg-gray-700 rounded-full h-1.5 mt-2"><div id="animation-progress-bar" class="bg-gradient-to-r from-purple-500 to-pink-500 h-1.5 rounded-full transition-all duration-200"></div></div>
        </div>
    </div>
    
    <!-- Formulas Modal -->
    <div id="formulas-modal" class="fixed inset-0 z-50 items-center justify-center p-4 hidden">
        <div class="absolute inset-0" id="modal-overlay"></div>
        <div id="modal-content" class="relative w-full max-w-4xl max-h-[90vh] rounded-2xl p-6 shadow-2xl flex flex-col">
            <div class="flex items-center justify-between mb-4 flex-shrink-0">
                <h2 class="text-2xl font-bold">Fórmulas del Binomio (Fila n=<span id="binomial-n"></span>)</h2>
                <button id="close-modal-btn" class="control-button w-10 h-10 flex items-center justify-center rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            
            <div class="flex-grow overflow-y-auto pr-2 space-y-4">
                <!-- Binomial Expansion Card -->
                <div class="binomial-card-style p-4 rounded-xl">
                    <h3 class="text-lg font-semibold mb-2" style="color: var(--accent-color);">Desarrollo con Coeficientes Binomiales</h3>
                    <div class="w-full overflow-x-auto pb-2">
                        <div id="binomial-formula" class="text-lg whitespace-nowrap"></div>
                    </div>
                </div>

                <!-- Calculated Binomial Expansion Card -->
                <div class="binomial-card-style p-4 rounded-xl">
                    <h3 class="text-lg font-semibold mb-2" style="color: var(--accent-color);">Desarrollo con Coeficientes Calculados</h3>
                    <div class="w-full overflow-x-auto pb-2">
                        <div id="binomial-formula-calculated" class="text-lg whitespace-nowrap"></div>
                    </div>
                </div>

                <!-- Combinatorics List -->
                <div>
                    <h3 class="text-lg font-semibold my-2">Lista de Coeficientes</h3>
                    <div id="formulas-list" class="space-y-2 text-base"></div>
                </div>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Element References ---
            const dom = {
                body: document.body,
                controlPanel: document.getElementById('control-panel'),
                menuToggle: document.getElementById('menu-toggle'),
                rowsSlider: document.getElementById('rows-slider'),
                rowsValue: document.getElementById('rows-value'),
                speedSlider: document.getElementById('speed-slider'),
                speedValue: document.getElementById('speed-value'),
                toggleAnimationBtn: document.getElementById('toggle-animation-btn'),
                playIcon: document.getElementById('play-icon'),
                pauseIcon: document.getElementById('pause-icon'),
                animationBtnText: document.getElementById('animation-btn-text'),
                resetBtn: document.getElementById('reset-btn'),
                themeSelector: document.getElementById('theme-selector'),
                highlightModeSelect: document.getElementById('highlight-mode-select'),
                zoomInBtn: document.getElementById('zoom-in-btn'),
                zoomOutBtn: document.getElementById('zoom-out-btn'),
                gridBtn: document.getElementById('grid-btn'),
                openFormulasBtn: document.getElementById('open-formulas-btn'),
                triangleContainer: document.getElementById('triangle-container'),
                selectedCellInfo: document.getElementById('selected-cell-info'),
                cellPos: document.getElementById('cell-pos'),
                cellValue: document.getElementById('cell-value'),
                cellFormulaContainer: document.getElementById('cell-formula-container'),
                animationIndicator: document.getElementById('animation-indicator'),
                animationProgressText: document.getElementById('animation-progress-text'),
                animationProgressBar: document.getElementById('animation-progress-bar'),
                themeAccentText: document.getElementById('theme-accent-text'),
                // Modal elements
                formulasModal: document.getElementById('formulas-modal'),
                modalOverlay: document.getElementById('modal-overlay'),
                modalContent: document.getElementById('modal-content'),
                closeModalBtn: document.getElementById('close-modal-btn'),
                binomialN: document.getElementById('binomial-n'),
                binomialFormula: document.getElementById('binomial-formula'),
                binomialFormulaCalculated: document.getElementById('binomial-formula-calculated'),
                formulasList: document.getElementById('formulas-list'),
            };

            // --- State Management ---
            let state = {
                rows: 15, animationSpeed: 100, isAnimating: false, currentRow: 0,
                theme: 'cosmic', highlightMode: 'none', zoom: 1, selectedCell: null,
                showGridLines: false, pascalTriangle: [], animationInterval: null,
            };

            const themes = {
                cosmic: { name: 'Cósmico', accent: '#d8b4fe' },
                neon: { name: 'Neón', accent: '#67e8f9' },
                forest: { name: 'Bosque', accent: '#6ee7b7' },
                sunset: { name: 'Atardecer', accent: '#fdba74' },
            };

            const fibSeq = [1, 2, 3, 5, 8, 13, 21, 34, 55, 89, 144, 233, 377, 610, 987, 1597, 2584, 4181, 6765, 10946, 17711, 28657, 46368, 75025];

            // --- Core Functions ---
            const generatePascalTriangle = () => {
                state.pascalTriangle = Array.from({ length: state.rows }, (_, i) => 
                    Array.from({ length: i + 1 }, (_, j) => math.combinations(i, j))
                );
            };

            const renderTriangle = () => {
                dom.triangleContainer.innerHTML = '';
                state.pascalTriangle.forEach((row, rowIndex) => {
                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'pascal-row flex items-center justify-center mb-1 sm:mb-2';
                    rowDiv.style.animationDelay = `${rowIndex * 20}ms`;
                    if (state.isAnimating && rowIndex > state.currentRow) rowDiv.style.opacity = '0.2';

                    row.forEach((value, colIndex) => {
                        const cellDiv = document.createElement('div');
                        cellDiv.className = `pascal-cell relative m-0.5 sm:m-1 transition-all duration-300 cursor-pointer rounded-lg p-1 sm:p-2 min-w-[40px] min-h-[40px] sm:min-w-[55px] sm:min-h-[55px] flex items-center justify-center text-center shadow-md`;
                        if (state.showGridLines) cellDiv.classList.add('grid-lines');
                        
                        cellDiv.innerHTML = `<span class="text-xs sm:text-sm font-bold">${formatNumber(value)}</span>`;
                        applyHighlighting(cellDiv, value);
                        
                        if (state.selectedCell && state.selectedCell.row === rowIndex && state.selectedCell.col === colIndex) {
                            cellDiv.classList.add('selected');
                        }
                        cellDiv.addEventListener('click', () => handleCellClick(rowIndex, colIndex, value));
                        rowDiv.appendChild(cellDiv);
                    });
                    dom.triangleContainer.appendChild(rowDiv);
                });
            };
            
            const applyHighlighting = (cellDiv, value) => {
                let highlightClass = '';
                switch (state.highlightMode) {
                    case 'odd': if (value % 2 === 1) highlightClass = 'ring-2 ring-yellow-400 bg-yellow-400/30'; break;
                    case 'even': if (value % 2 === 0) highlightClass = 'ring-2 ring-blue-400 bg-blue-400/30'; break;
                    case 'powers': if (value > 0 && (value & (value - 1)) === 0) highlightClass = 'ring-2 ring-red-400 bg-red-400/30'; break;
                    case 'fibonacci': if (fibSeq.includes(value)) highlightClass = 'ring-2 ring-green-400 bg-green-400/30'; break;
                    case 'divisible': if (value > 0 && value % 3 === 0) highlightClass = 'ring-2 ring-purple-400 bg-purple-400/30'; break;
                }
                if (highlightClass) cellDiv.classList.add(...highlightClass.split(' '));
            };

            const handleCellClick = (row, col, value) => {
                state.selectedCell = { row, col, value };
                updateUI();
            };

            const formatNumber = (num) => {
                if (num > 999999) return (num / 1000000).toFixed(1) + 'M';
                if (num > 999) return (num / 1000).toFixed(1) + 'K';
                return num.toString();
            };

            const getCombinatorialFormula = (row, col) => `C(${row}, ${col}) = \\binom{${row}}{${col}} = \\frac{${row}!}{${col}!(${row}-${col})!}`;

            // --- Animation Logic ---
            const startAnimation = () => {
                if (state.animationInterval) clearInterval(state.animationInterval);
                state.isAnimating = true;
                if (state.currentRow >= state.rows - 1) state.currentRow = 0;
                state.animationInterval = setInterval(() => {
                    if (state.currentRow >= state.rows - 1) { stopAnimation(); return; }
                    state.currentRow++;
                    updateUI();
                }, state.animationSpeed);
                updateUI();
            };

            const stopAnimation = () => {
                clearInterval(state.animationInterval);
                state.animationInterval = null;
                state.isAnimating = false;
                updateUI();
            };

            const resetAnimation = () => {
                stopAnimation();
                state.currentRow = 0;
                state.selectedCell = null;
                updateUI();
            };
            
            // --- Modal Logic ---
            const openFormulasModal = () => {
                const n = state.rows - 1;
                dom.binomialN.textContent = n;

                const coefficients = state.pascalTriangle[n];

                // Generate Binomial Expansion with Combinatorics
                const binomialTerms = coefficients.map((_, k) => {
                    const aPower = n - k;
                    const bPower = k;
                    let term = `\\binom{${n}}{${k}}`;
                    if (aPower > 0) term += `a^{${aPower > 1 ? aPower : ''}}`;
                    if (bPower > 0) term += `b^{${bPower > 1 ? bPower : ''}}`;
                    return term;
                });
                dom.binomialFormula.textContent = `$(a+b)^{${n}} = ${binomialTerms.join(' + ')}$`;
                
                // Generate Binomial Expansion with Calculated Coefficients
                const calculatedBinomialTerms = coefficients.map((coeff, k) => {
                    const aPower = n - k;
                    const bPower = k;
                    let coeffStr = (coeff > 1) ? coeff.toLocaleString() : '';
                    if (coeff === 1 && aPower === 0 && bPower === 0) coeffStr = '1';
                    
                    let aStr = aPower > 0 ? (aPower === 1 ? 'a' : `a^{${aPower}}`) : '';
                    let bStr = bPower > 0 ? (bPower === 1 ? 'b' : `b^{${bPower}}`) : '';
                    
                    if (coeff === 1 && (aStr || bStr)) coeffStr = '';
                    
                    return `${coeffStr}${aStr}${bStr}`;
                });
                dom.binomialFormulaCalculated.textContent = `$(a+b)^{${n}} = ${calculatedBinomialTerms.join(' + ')}$`;

                // Generate Combinatorics List
                let formulasHtml = '';
                for(let i = 0; i < state.rows; i++) {
                    for(let j = 0; j <= i; j++) {
                        const value = state.pascalTriangle[i][j];
                        formulasHtml += `<p>$${getCombinatorialFormula(i,j)} = ${value.toLocaleString()}$</p>`;
                    }
                }
                dom.formulasList.innerHTML = formulasHtml;
                
                // Show modal and render math
                dom.formulasModal.classList.remove('hidden');
                dom.formulasModal.classList.add('flex');
                setTimeout(() => dom.formulasModal.classList.add('open'), 10);
                
                if (window.MathJax) {
                    MathJax.typesetPromise([dom.modalContent]).catch((err) => console.log('MathJax Error: ', err));
                }
            };
            
            const closeFormulasModal = () => {
                dom.formulasModal.classList.remove('open');
                setTimeout(() => {
                    dom.formulasModal.classList.add('hidden');
                    dom.formulasModal.classList.remove('flex');
                }, 300);
            };

            // --- UI Update Function ---
            const updateUI = () => {
                dom.rowsValue.textContent = state.rows;
                dom.speedValue.textContent = state.animationSpeed;
                dom.playIcon.classList.toggle('hidden', state.isAnimating);
                dom.pauseIcon.classList.toggle('hidden', !state.isAnimating);
                dom.animationBtnText.textContent = state.isAnimating ? 'Pausar' : 'Animar';
                renderTriangle();
                dom.triangleContainer.style.transform = `scale(${state.zoom})`;

                if (state.selectedCell) {
                    dom.selectedCellInfo.classList.remove('hidden');
                    dom.cellPos.textContent = `(${state.selectedCell.row}, ${state.selectedCell.col})`;
                    dom.cellValue.textContent = state.selectedCell.value.toLocaleString();
                    dom.cellFormulaContainer.textContent = `$${getCombinatorialFormula(state.selectedCell.row, state.selectedCell.col)}$`;
                    if(window.MathJax) MathJax.typesetPromise([dom.cellFormulaContainer]);
                } else {
                    dom.selectedCellInfo.classList.add('hidden');
                }

                dom.animationIndicator.classList.toggle('hidden', !state.isAnimating);
                if (state.isAnimating) {
                    dom.animationProgressText.textContent = `Animando fila ${state.currentRow + 1} de ${state.rows}`;
                    dom.animationProgressBar.style.width = `${((state.currentRow + 1) / state.rows) * 100}%`;
                }
            };
            
            // --- Event Listeners ---
            dom.rowsSlider.addEventListener('input', (e) => { state.rows = parseInt(e.target.value); resetAnimation(); generatePascalTriangle(); updateUI(); });
            dom.speedSlider.addEventListener('input', (e) => { state.animationSpeed = parseInt(e.target.value); if (state.isAnimating) { stopAnimation(); startAnimation(); } updateUI(); });
            dom.toggleAnimationBtn.addEventListener('click', () => { if (state.isAnimating) stopAnimation(); else startAnimation(); });
            dom.resetBtn.addEventListener('click', resetAnimation);
            dom.highlightModeSelect.addEventListener('change', (e) => { state.highlightMode = e.target.value; updateUI(); });
            dom.zoomInBtn.addEventListener('click', () => { state.zoom = Math.min(2, state.zoom + 0.1); updateUI(); });
            dom.zoomOutBtn.addEventListener('click', () => { state.zoom = Math.max(0.3, state.zoom - 0.1); updateUI(); });
            dom.gridBtn.addEventListener('click', () => { state.showGridLines = !state.showGridLines; updateUI(); });
            dom.menuToggle.addEventListener('click', () => dom.controlPanel.classList.toggle('open'));
            
            // Modal Listeners
            dom.openFormulasBtn.addEventListener('click', openFormulasModal);
            dom.closeModalBtn.addEventListener('click', closeFormulasModal);
            dom.modalOverlay.addEventListener('click', closeFormulasModal);

            // --- Initialization ---
            const init = () => {
                Object.entries(themes).forEach(([key, themeData]) => {
                    const button = document.createElement('button');
                    button.dataset.theme = key;
                    button.className = 'h-8 rounded-md border-2 border-transparent transition-all';
                    const tempRoot = document.createElement('div');
                    tempRoot.setAttribute('data-theme', key);
                    document.body.appendChild(tempRoot);
                    const style = getComputedStyle(tempRoot);
                    button.style.background = `linear-gradient(135deg, ${style.getPropertyValue('--bg-gradient-start')}, ${style.getPropertyValue('--bg-gradient-mid')})`;
                    document.body.removeChild(tempRoot);
                    if (key === state.theme) button.classList.add('ring-2', 'ring-white', 'ring-offset-2', 'ring-offset-black/20');
                    button.addEventListener('click', () => {
                        state.theme = key;
                        dom.body.dataset.theme = key;
                        dom.themeAccentText.style.color = themes[key].accent;
                        document.querySelectorAll('#theme-selector button').forEach(btn => btn.classList.remove('ring-2', 'ring-white', 'ring-offset-2', 'ring-offset-black/20'));
                        button.classList.add('ring-2', 'ring-white', 'ring-offset-2', 'ring-offset-black/20');
                    });
                    dom.themeSelector.appendChild(button);
                });
                generatePascalTriangle();
                updateUI();
            };
            init();
        });
    </script>
</body>
</html>
