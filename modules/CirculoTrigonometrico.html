<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>C√≠rculo Trigonom√©trico Interactivo</title>
    
    <!-- Librer√≠as y Fuentes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        // Cargar lucide de forma as√≠ncrona
        (function() {
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/lucide@latest/dist/umd/lucide.js';
            script.onload = function() {
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            };
            document.head.appendChild(script);
        })();
    </script>

    <!-- Estilos CSS -->
    <style>
        :root {
            --background: 220 14.3% 95.9%;
            --foreground: 224 71.4% 4.1%;
            --card: 0 0% 100%;
            --card-foreground: 224 71.4% 4.1%;
            --primary: 220.9 39.3% 11%;
            --primary-foreground: 210 20% 98%;
            --secondary: 220 13% 91%;
            --secondary-foreground: 220.9 39.3% 11%;
            --muted: 220 13% 91%;
            --muted-foreground: 225 8.9% 46.1%;
            --accent: 48 96% 59%;
            --border: 220 13% 85%;
            --ring: 220.9 39.3% 11%;
            --radius: 0.75rem;
        }

        .dark {
            --background: 222 83.9% 4.9%;
            --foreground: 210 20% 98%;
            --card: 222 47.4% 11.2%;
            --card-foreground: 210 20% 98%;
            --primary: 210 20% 98%;
            --primary-foreground: 222 47.4% 11.2%;
            --secondary: 217 32.6% 17.5%;
            --secondary-foreground: 210 20% 98%;
            --muted: 217 32.6% 17.5%;
            --muted-foreground: 215 20.2% 65.1%;
            --border: 217 32.6% 17.5%;
            --ring: 215 20.2% 65.1%;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
            transition: background-color 0.3s, color 0.3s;
            overscroll-behavior: none;
        }

        .canvas-container {
            touch-action: none;
            overflow: hidden;
            cursor: crosshair;
            position: relative;
        }

        .canvas-container:active {
            cursor: grabbing;
        }

        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-content {
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s ease;
        }
        
        /* Estilos para los sliders */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: hsl(var(--secondary));
            border-radius: 9999px;
            outline: none;
            transition: background 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: hsl(var(--primary));
            cursor: pointer;
            border-radius: 50%;
            border: 3px solid hsl(var(--card));
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: hsl(var(--primary));
            cursor: pointer;
            border-radius: 50%;
            border: 3px solid hsl(var(--card));
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* Animaci√≥n para transiciones suaves */
        .smooth-transition {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Estilos para botones de √°ngulos especiales */
        .angle-button {
            transition: all 0.2s ease;
        }

        .angle-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .angle-button.active {
            background-color: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
        }

        /* Canvas de leyenda */
        .legend-canvas {
            border: 1px solid hsl(var(--border));
            border-radius: 8px;
            margin: 8px 0;
        }
    </style>
</head>

<body class="antialiased">
    <div class="relative min-h-screen container mx-auto p-4 md:p-8 lg:p-12 overflow-y-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-slate-800 dark:text-slate-50 mb-2">
                C√≠rculo Trigonom√©trico
            </h1>
            <p class="text-lg text-slate-500 dark:text-slate-400">Visualizaci√≥n interactiva de las funciones trigonom√©tricas</p>
        </header>

        <!-- Barra de Herramientas Flotante -->
        <div class="absolute top-4 right-4 z-40 bg-white dark:bg-slate-800 p-2 rounded-full shadow-lg border border-slate-300 dark:border-slate-600 flex items-center gap-1">
            <button id="home-btn" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors focus:ring-2 focus:ring-slate-800 dark:focus:ring-slate-200 focus:outline-none" aria-label="Reiniciar">
                <i data-lucide="home" class="w-5 h-5 text-slate-800 dark:text-slate-50"></i>
            </button>
            <button id="animate-btn" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors focus:ring-2 focus:ring-slate-800 dark:focus:ring-slate-200 focus:outline-none" aria-label="Animar">
                <i data-lucide="play" class="w-5 h-5 text-slate-800 dark:text-slate-50"></i>
            </button>
            <button id="legend-btn" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors focus:ring-2 focus:ring-slate-800 dark:focus:ring-slate-200 focus:outline-none" aria-label="Mostrar Leyenda">
                <i data-lucide="info" class="w-5 h-5 text-slate-800 dark:text-slate-50"></i>
            </button>
            <button id="theme-toggle-btn" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors focus:ring-2 focus:ring-slate-800 dark:focus:ring-slate-200 focus:outline-none" aria-label="Cambiar Tema">
                <i data-lucide="sun" class="w-5 h-5 text-slate-800 dark:text-slate-50 block dark:hidden"></i>
                <i data-lucide="moon" class="w-5 h-5 text-slate-800 dark:text-slate-50 hidden dark:block"></i>
            </button>
            <button id="help-modal-btn" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors focus:ring-2 focus:ring-slate-800 dark:focus:ring-slate-200 focus:outline-none" aria-label="Mostrar ayuda">
                <i data-lucide="help-circle" class="w-5 h-5 text-slate-800 dark:text-slate-50"></i>
            </button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12 lg:items-start">
            <!-- Columna de Controles y Datos -->
            <div class="space-y-6">
                <div id="parameters-panel" class="bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-2xl shadow-lg p-6">
                    <h2 class="text-2xl font-semibold mb-6 text-slate-800 dark:text-slate-50 flex items-center gap-2">
                        <i data-lucide="sliders-horizontal"></i> Controles
                    </h2>
                    <div class="space-y-6">
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <label for="angle-slider" class="text-sm font-medium text-slate-500 dark:text-slate-400">√Ångulo (Œ∏)</label>
                                <div class="flex items-center gap-2">
                                    <span id="angle-value" class="px-2 py-1 text-sm font-semibold text-slate-800 dark:text-slate-50 bg-slate-100 dark:bg-slate-700 rounded-md">45¬∞</span>
                                    <span id="angle-rad" class="px-2 py-1 text-sm font-medium text-slate-600 dark:text-slate-400 bg-slate-100 dark:bg-slate-700 rounded-md">œÄ/4 rad</span>
                                </div>
                            </div>
                            <input type="range" id="angle-slider" min="0" max="360" value="45" step="1">
                            
                            <!-- Botones de √°ngulos especiales -->
                            <div class="mt-3 grid grid-cols-6 gap-2">
                                <button class="angle-button px-2 py-1 text-sm font-medium bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-md smooth-transition" data-angle="0">0¬∞</button>
                                <button class="angle-button px-2 py-1 text-sm font-medium bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-md smooth-transition" data-angle="30">30¬∞</button>
                                <button class="angle-button px-2 py-1 text-sm font-medium bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-md smooth-transition" data-angle="45">45¬∞</button>
                                <button class="angle-button px-2 py-1 text-sm font-medium bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-md smooth-transition" data-angle="60">60¬∞</button>
                                <button class="angle-button px-2 py-1 text-sm font-medium bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-md smooth-transition" data-angle="90">90¬∞</button>
                                <button class="angle-button px-2 py-1 text-sm font-medium bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-md smooth-transition" data-angle="180">180¬∞</button>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <label for="radius-slider" class="text-sm font-medium text-slate-500 dark:text-slate-400">Radio (r)</label>
                                <span id="radius-value" class="px-2 py-1 text-sm font-semibold text-slate-800 dark:text-slate-50 bg-slate-100 dark:bg-slate-700 rounded-md">1.0</span>
                            </div>
                            <input type="range" id="radius-slider" min="0.5" max="2.5" value="1.0" step="0.1">
                        </div>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-2xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold mb-4 text-slate-800 dark:text-slate-50 flex items-center gap-2">
                        <i data-lucide="calculator"></i> Valores de las Funciones
                    </h2>
                    <div id="values-grid" class="grid grid-cols-2 gap-4">
                        <!-- Los valores se insertar√°n aqu√≠ din√°micamente -->
                    </div>
                </div>

                <!-- Panel de Coordenadas -->
                <div class="bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-2xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold mb-4 text-slate-800 dark:text-slate-50 flex items-center gap-2">
                        <i data-lucide="compass"></i> Coordenadas del Punto
                    </h2>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="flex justify-between items-center bg-slate-100 dark:bg-slate-700 p-2 rounded-lg">
                            <span class="text-sm font-medium text-slate-600 dark:text-slate-300">X (cos Œ∏)</span>
                            <span id="coord-x" class="font-bold text-base text-slate-800 dark:text-slate-50">0.71</span>
                        </div>
                        <div class="flex justify-between items-center bg-slate-100 dark:bg-slate-700 p-2 rounded-lg">
                            <span class="text-sm font-medium text-slate-600 dark:text-slate-300">Y (sin Œ∏)</span>
                            <span id="coord-y" class="font-bold text-base text-slate-800 dark:text-slate-50">0.71</span>
                        </div>
                    </div>
                    <div class="mt-3 flex justify-center">
                        <div class="bg-slate-100 dark:bg-slate-700 px-3 py-1 rounded-lg">
                            <span class="text-sm font-medium text-slate-600 dark:text-slate-300">Cuadrante: </span>
                            <span id="quadrant" class="font-bold text-base text-slate-800 dark:text-slate-50">I</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Columna de Simulaci√≥n -->
            <div class="lg:col-span-1 min-h-[70vh] lg:min-h-[600px]">
                <div id="canvas-container" class="canvas-container bg-gradient-to-br from-white via-white to-slate-50 dark:from-slate-900 dark:via-slate-900 dark:to-slate-800 border border-slate-300 dark:border-slate-600 rounded-2xl shadow-xl w-full h-full relative overflow-hidden">
                    <canvas id="trig-canvas"></canvas>
                </div>
            </div>
        </div>
        
        <footer class="text-center mt-12 py-4 border-t border-slate-300 dark:border-slate-600">
            <p class="text-sm text-slate-500 dark:text-slate-400">
                Versi√≥n mejorada del c√≠rculo trigonom√©trico interactivo
            </p>
        </footer>

        <!-- Modal de Leyenda Mejorada -->
        <div id="legend-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 opacity-0 pointer-events-none modal">
            <div class="modal-content bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden transform scale-95">
                <div class="flex items-center justify-between p-6 border-b border-slate-300 dark:border-slate-600">
                    <h2 class="text-xl font-bold text-slate-800 dark:text-slate-50 flex items-center gap-2">
                        <i data-lucide="palette"></i> Leyenda Visual de Funciones Trigonom√©tricas
                    </h2>
                    <button id="close-legend-btn" class="p-2 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                        <i data-lucide="x"></i>
                    </button>
                </div>
                <div class="p-6 space-y-4 overflow-y-auto">
                    <!-- Canvas para cada funci√≥n -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-slate-50 dark:bg-slate-900 p-4 rounded-lg">
                            <h3 class="font-semibold mb-2 flex items-center gap-2">
                                <div class="w-6 h-1 bg-[#ef4444] rounded-full"></div>
                                Seno (sin Œ∏)
                            </h3>
                            <canvas id="legend-sin" class="legend-canvas w-full h-32 bg-white dark:bg-slate-800"></canvas>
                            <p class="text-sm text-slate-600 dark:text-slate-400 mt-2">Proyecci√≥n vertical del punto sobre el eje Y</p>
                        </div>
                        
                        <div class="bg-slate-50 dark:bg-slate-900 p-4 rounded-lg">
                            <h3 class="font-semibold mb-2 flex items-center gap-2">
                                <div class="w-6 h-1 bg-[#3b82f6] rounded-full"></div>
                                Coseno (cos Œ∏)
                            </h3>
                            <canvas id="legend-cos" class="legend-canvas w-full h-32 bg-white dark:bg-slate-800"></canvas>
                            <p class="text-sm text-slate-600 dark:text-slate-400 mt-2">Proyecci√≥n horizontal del punto sobre el eje X</p>
                        </div>
                        
                        <div class="bg-slate-50 dark:bg-slate-900 p-4 rounded-lg">
                            <h3 class="font-semibold mb-2 flex items-center gap-2">
                                <div class="w-6 h-1 bg-[#16a34a] rounded-full"></div>
                                Tangente (tan Œ∏)
                            </h3>
                            <canvas id="legend-tan" class="legend-canvas w-full h-32 bg-white dark:bg-slate-800"></canvas>
                            <p class="text-sm text-slate-600 dark:text-slate-400 mt-2">L√≠nea vertical desde x=1 hasta la prolongaci√≥n del radio</p>
                        </div>
                        
                        <div class="bg-slate-50 dark:bg-slate-900 p-4 rounded-lg">
                            <h3 class="font-semibold mb-2 flex items-center gap-2">
                                <div class="w-6 h-1 bg-[#f97316] rounded-full"></div>
                                Cotangente (cot Œ∏)
                            </h3>
                            <canvas id="legend-cot" class="legend-canvas w-full h-32 bg-white dark:bg-slate-800"></canvas>
                            <p class="text-sm text-slate-600 dark:text-slate-400 mt-2">L√≠nea horizontal desde y=1 hasta la prolongaci√≥n del radio</p>
                        </div>
                        
                        <div class="bg-slate-50 dark:bg-slate-900 p-4 rounded-lg">
                            <h3 class="font-semibold mb-2 flex items-center gap-2">
                                <div class="w-6 h-1 bg-[#a855f7] rounded-full"></div>
                                Secante (sec Œ∏)
                            </h3>
                            <canvas id="legend-sec" class="legend-canvas w-full h-32 bg-white dark:bg-slate-800"></canvas>
                            <p class="text-sm text-slate-600 dark:text-slate-400 mt-2">Distancia desde el origen hasta el punto de la tangente</p>
                        </div>
                        
                        <div class="bg-slate-50 dark:bg-slate-900 p-4 rounded-lg">
                            <h3 class="font-semibold mb-2 flex items-center gap-2">
                                <div class="w-6 h-1 bg-[#eab308] rounded-full"></div>
                                Cosecante (csc Œ∏)
                            </h3>
                            <canvas id="legend-csc" class="legend-canvas w-full h-32 bg-white dark:bg-slate-800"></canvas>
                            <p class="text-sm text-slate-600 dark:text-slate-400 mt-2">Distancia desde el origen hasta el punto de la cotangente</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de Ayuda -->
        <div id="help-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 opacity-0 pointer-events-none modal">
            <div class="modal-content bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col transform scale-95">
                <div class="flex items-center justify-between p-6 border-b border-slate-300 dark:border-slate-600">
                    <h2 class="text-xl font-bold text-slate-800 dark:text-slate-50 flex items-center gap-2">
                        <i data-lucide="book-open-check"></i> Gu√≠a de Uso
                    </h2>
                    <button id="close-help-btn" class="p-2 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                        <i data-lucide="x"></i>
                    </button>
                </div>
                <div class="p-6 overflow-y-auto space-y-4">
                    <div class="bg-slate-100/50 dark:bg-slate-700/50 p-4 rounded-lg">
                        <h3 class="font-semibold text-lg mb-3 text-slate-800 dark:text-slate-50">C√≥mo Interactuar</h3>
                        <ul class="list-disc list-inside ml-2 space-y-2 text-slate-600 dark:text-slate-300">
                            <li><strong>Ajusta el √Ångulo:</strong> Usa el deslizador o haz clic en los botones de √°ngulos especiales</li>
                            <li><strong>Clic en el C√≠rculo:</strong> Haz clic directamente en el c√≠rculo para ajustar el √°ngulo</li>
                            <li><strong>Modifica el Radio:</strong> Cambia el tama√±o del c√≠rculo con el deslizador de radio</li>
                            <li><strong>Animaci√≥n:</strong> Presiona el bot√≥n de play para ver una animaci√≥n continua</li>
                            <li><strong>Zoom:</strong> Usa la rueda del mouse para acercar o alejar la vista</li>
                            <li><strong>Mover Vista:</strong> Mant√©n presionado y arrastra para desplazar la vista</li>
                        </ul>
                    </div>
                    <div class="bg-slate-100/50 dark:bg-slate-700/50 p-4 rounded-lg">
                        <h3 class="font-semibold text-lg mb-3 text-slate-800 dark:text-slate-50">Conceptos Matem√°ticos</h3>
                        <p class="text-slate-600 dark:text-slate-300 mb-2">
                            El c√≠rculo trigonom√©trico es una herramienta fundamental para entender las funciones trigonom√©tricas:
                        </p>
                        <ul class="list-disc list-inside ml-2 space-y-1 text-sm text-slate-600 dark:text-slate-300">
                            <li><strong>Seno y Coseno:</strong> Son las coordenadas (x,y) del punto en el c√≠rculo</li>
                            <li><strong>Tangente:</strong> Es la raz√≥n sin/cos, representada por la l√≠nea vertical en x=1</li>
                            <li><strong>Funciones Rec√≠procas:</strong> sec = 1/cos, csc = 1/sin, cot = 1/tan</li>
                            <li><strong>Periodicidad:</strong> Las funciones se repiten cada 360¬∞ (2œÄ radianes)</li>
                        </ul>
                    </div>
                    <div class="bg-amber-100/50 dark:bg-amber-900/20 p-4 rounded-lg">
                        <h3 class="font-semibold text-lg mb-2 text-slate-800 dark:text-slate-50">üí° Tip</h3>
                        <p class="text-sm text-slate-600 dark:text-slate-300">
                            Observa c√≥mo las funciones cambian en los cuadrantes. Por ejemplo, el seno es positivo en los cuadrantes I y II, mientras que el coseno es positivo en los cuadrantes I y IV.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Funci√≥n para cargar iconos de forma segura
            function loadIcons() {
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                } else {
                    setTimeout(loadIcons, 100);
                }
            }
            
            // Cargar iconos cuando est√©n disponibles
            loadIcons();
            
            // --- REFERENCIAS AL DOM ---
            const dom = {
                canvas: document.getElementById('trig-canvas'),
                canvasContainer: document.getElementById('canvas-container'),
                angleSlider: document.getElementById('angle-slider'),
                angleValue: document.getElementById('angle-value'),
                angleRad: document.getElementById('angle-rad'),
                radiusSlider: document.getElementById('radius-slider'),
                radiusValue: document.getElementById('radius-value'),
                valuesGrid: document.getElementById('values-grid'),
                coordX: document.getElementById('coord-x'),
                coordY: document.getElementById('coord-y'),
                // Toolbar buttons
                homeBtn: document.getElementById('home-btn'),
                animateBtn: document.getElementById('animate-btn'),
                legendBtn: document.getElementById('legend-btn'),
                themeToggleBtn: document.getElementById('theme-toggle-btn'),
                helpModalBtn: document.getElementById('help-modal-btn'),
                // Modals
                legendModal: document.getElementById('legend-modal'),
                closeLegendBtn: document.getElementById('close-legend-btn'),
                helpModal: document.getElementById('help-modal'),
                closeHelpBtn: document.getElementById('close-help-btn'),
                // Legend canvases
                legendSin: document.getElementById('legend-sin'),
                legendCos: document.getElementById('legend-cos'),
                legendTan: document.getElementById('legend-tan'),
                legendCot: document.getElementById('legend-cot'),
                legendSec: document.getElementById('legend-sec'),
                legendCsc: document.getElementById('legend-csc'),
            };

            const ctx = dom.canvas.getContext('2d');
            
            // --- ESTADO ---
            const state = {
                angle: 45, // en grados
                radius: 1.0,
                scale: 140, // p√≠xeles por unidad (aumentado para mejor visualizaci√≥n)
                panOffset: { x: 0, y: 0 },
                isPanning: false,
                panStart: { x: 0, y: 0 },
                isAnimating: false,
                animationId: null,
            };

            const colors = {
                sin: '#ef4444', 
                cos: '#3b82f6', 
                tan: '#16a34a',
                cot: '#f97316', 
                sec: '#a855f7', 
                csc: '#eab308',
                radius: '#6b7280',
                point: '#1e293b'
            };

            // --- FUNCIONES UTILITARIAS ---
            function toRadians(degrees) {
                return degrees * Math.PI / 180;
            }

            function formatRadians(degrees) {
                const rad = degrees * Math.PI / 180;
                const pi = Math.PI;
                
                // Casos especiales comunes
                if (degrees === 0) return '0';
                if (degrees === 30) return 'œÄ/6';
                if (degrees === 45) return 'œÄ/4';
                if (degrees === 60) return 'œÄ/3';
                if (degrees === 90) return 'œÄ/2';
                if (degrees === 120) return '2œÄ/3';
                if (degrees === 135) return '3œÄ/4';
                if (degrees === 150) return '5œÄ/6';
                if (degrees === 180) return 'œÄ';
                if (degrees === 210) return '7œÄ/6';
                if (degrees === 225) return '5œÄ/4';
                if (degrees === 240) return '4œÄ/3';
                if (degrees === 270) return '3œÄ/2';
                if (degrees === 300) return '5œÄ/3';
                if (degrees === 315) return '7œÄ/4';
                if (degrees === 330) return '11œÄ/6';
                if (degrees === 360) return '2œÄ';
                
                // Para otros valores, mostrar en decimales
                return (rad / pi).toFixed(3) + 'œÄ';
            }

            // --- FUNCIONES DE MODALES ---
            function openModal(modal) {
                modal.classList.remove('opacity-0', 'pointer-events-none');
                const content = modal.querySelector('.modal-content');
                content.classList.remove('scale-95');
                
                // Si es el modal de leyenda, dibujar los mini canvas
                if (modal === dom.legendModal) {
                    drawLegendCanvases();
                }
            }

            function closeModal(modal) {
                modal.classList.add('opacity-0');
                const content = modal.querySelector('.modal-content');
                content.classList.add('scale-95');
                setTimeout(() => modal.classList.add('pointer-events-none'), 300);
            }

            // --- FUNCIONES DE TEMA ---
            function applyTheme(theme) {
                document.documentElement.classList.toggle('dark', theme === 'dark');
                localStorage.setItem('theme', theme);
                draw();
                if (dom.legendModal.classList.contains('opacity-0') === false) {
                    drawLegendCanvases();
                }
            }

            // --- FUNCIONES DE ACTUALIZACI√ìN ---
            function updateValues() {
                const angleRad = toRadians(state.angle);
                const cos_a = Math.cos(angleRad);
                const sin_a = Math.sin(angleRad);
                
                const f = {
                    sin: sin_a,
                    cos: cos_a,
                    tan: Math.tan(angleRad),
                    cot: 1 / Math.tan(angleRad),
                    sec: 1 / cos_a,
                    csc: 1 / sin_a,
                };

                dom.angleValue.textContent = `${state.angle}¬∞`;
                dom.angleRad.textContent = formatRadians(state.angle);
                dom.radiusValue.textContent = state.radius.toFixed(1);
                
                // Actualizar coordenadas
                dom.coordX.textContent = (state.radius * cos_a).toFixed(3);
                dom.coordY.textContent = (state.radius * sin_a).toFixed(3);
                
                // Actualizar valores de funciones con colores y tooltips
                dom.valuesGrid.innerHTML = `
                    <div class="flex justify-between items-center bg-slate-100 dark:bg-slate-700 p-3 rounded-lg hover:shadow-md transition-shadow">
                        <span class="text-sm font-medium" style="color: ${colors.sin}">sin Œ∏</span>
                        <strong class="text-base" style="color: ${colors.sin}">${f.sin.toFixed(4)}</strong>
                    </div>
                    <div class="flex justify-between items-center bg-slate-100 dark:bg-slate-700 p-3 rounded-lg hover:shadow-md transition-shadow">
                        <span class="text-sm font-medium" style="color: ${colors.cos}">cos Œ∏</span>
                        <strong class="text-base" style="color: ${colors.cos}">${f.cos.toFixed(4)}</strong>
                    </div>
                    <div class="flex justify-between items-center bg-slate-100 dark:bg-slate-700 p-3 rounded-lg hover:shadow-md transition-shadow">
                        <span class="text-sm font-medium" style="color: ${colors.tan}">tan Œ∏</span>
                        <strong class="text-base" style="color: ${colors.tan}">${isFinite(f.tan) ? f.tan.toFixed(4) : '‚àû'}</strong>
                    </div>
                    <div class="flex justify-between items-center bg-slate-100 dark:bg-slate-700 p-3 rounded-lg hover:shadow-md transition-shadow">
                        <span class="text-sm font-medium" style="color: ${colors.cot}">cot Œ∏</span>
                        <strong class="text-base" style="color: ${colors.cot}">${isFinite(f.cot) ? f.cot.toFixed(4) : '‚àû'}</strong>
                    </div>
                    <div class="flex justify-between items-center bg-slate-100 dark:bg-slate-700 p-3 rounded-lg hover:shadow-md transition-shadow">
                        <span class="text-sm font-medium" style="color: ${colors.sec}">sec Œ∏</span>
                        <strong class="text-base" style="color: ${colors.sec}">${isFinite(f.sec) ? f.sec.toFixed(4) : '‚àû'}</strong>
                    </div>
                    <div class="flex justify-between items-center bg-slate-100 dark:bg-slate-700 p-3 rounded-lg hover:shadow-md transition-shadow">
                        <span class="text-sm font-medium" style="color: ${colors.csc}">csc Œ∏</span>
                        <strong class="text-base" style="color: ${colors.csc}">${isFinite(f.csc) ? f.csc.toFixed(4) : '‚àû'}</strong>
                    </div>
                `;

                // Actualizar botones de √°ngulos especiales
                document.querySelectorAll('.angle-button').forEach(btn => {
                    const btnAngle = parseInt(btn.dataset.angle);
                    btn.classList.toggle('active', btnAngle === state.angle);
                });
            }

            // --- FUNCIONES DEL CANVAS ---
            function adjustLayout() {
                const parametersPanel = document.getElementById('parameters-panel');
                if (window.innerWidth >= 1024) { // lg breakpoint
                    // Hacer el canvas m√°s alto que el panel de par√°metros
                    const panelHeight = parametersPanel.clientHeight;
                    dom.canvasContainer.style.height = `${Math.max(panelHeight + 100, 600)}px`;
                } else {
                    dom.canvasContainer.style.height = '70vh';
                }
                setupCanvas();
            }

            function setupCanvas() {
                const dpr = window.devicePixelRatio || 1;
                const rect = dom.canvasContainer.getBoundingClientRect();
                dom.canvas.width = rect.width * dpr;
                dom.canvas.height = rect.height * dpr;
                ctx.scale(dpr, dpr);
                draw();
            }

            function draw() {
                const rect = dom.canvasContainer.getBoundingClientRect();
                const isDark = document.documentElement.classList.contains('dark');
                const bgColor = isDark ? '#0f172a' : '#ffffff';
                const gridColor = isDark ? '#374151' : '#e5e7eb';
                const axisColor = isDark ? '#9ca3af' : '#4b5563';
                const circleColor = isDark ? '#e2e8f0' : '#1e293b';
                const textColor = isDark ? '#9ca3af' : '#6b7280';

                // Limpiar con color de fondo
                ctx.fillStyle = bgColor;
                ctx.fillRect(0, 0, rect.width, rect.height);
                
                const centerX = rect.width / 2 + state.panOffset.x;
                const centerY = rect.height / 2 + state.panOffset.y;
                
                ctx.save();
                ctx.translate(centerX, centerY);
                ctx.scale(state.scale, -state.scale); // Invertir eje Y

                // Dibujar grilla m√°s extensa
                ctx.strokeStyle = gridColor;
                ctx.lineWidth = 0.5 / state.scale;
                const maxUnits = Math.max(rect.width, rect.height) / state.scale + 2;
                for (let i = -Math.ceil(maxUnits); i <= Math.ceil(maxUnits); i++) {
                    ctx.beginPath(); 
                    ctx.moveTo(i, -maxUnits); 
                    ctx.lineTo(i, maxUnits); 
                    ctx.stroke();
                    ctx.beginPath(); 
                    ctx.moveTo(-maxUnits, i); 
                    ctx.lineTo(maxUnits, i); 
                    ctx.stroke();
                }

                // Dibujar ejes con marcas
                ctx.strokeStyle = axisColor;
                ctx.lineWidth = 3 / state.scale;
                
                // Eje X
                ctx.beginPath(); 
                ctx.moveTo(-maxUnits, 0); 
                ctx.lineTo(maxUnits, 0); 
                ctx.stroke();
                
                // Eje Y
                ctx.beginPath(); 
                ctx.moveTo(0, -maxUnits); 
                ctx.lineTo(0, maxUnits); 
                ctx.stroke();
                
                // Marcas en los ejes con n√∫meros
                ctx.fillStyle = textColor;
                ctx.font = `${12 / state.scale}px Inter`;
                ctx.save();
                ctx.scale(1, -1); // Voltear texto
                
                // Etiquetas de ejes y marcas
                for (let i = -Math.floor(maxUnits); i <= Math.floor(maxUnits); i++) {
                    if (i !== 0 && Math.abs(i) <= 3) { // Solo mostrar n√∫meros del -3 al 3
                        // Marcas en X
                        ctx.beginPath();
                        ctx.moveTo(i, -0.05);
                        ctx.lineTo(i, 0.05);
                        ctx.stroke();
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'top';
                        ctx.fillText(i.toString(), i, 0.1);
                        
                        // Marcas en Y
                        ctx.beginPath();
                        ctx.moveTo(-0.05, -i);
                        ctx.lineTo(0.05, -i);
                        ctx.stroke();
                        ctx.textAlign = 'left';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(i.toString(), 0.1, -i);
                    }
                }
                
                // Etiquetas de los ejes
                ctx.font = `bold ${14 / state.scale}px Inter`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('X', maxUnits - 0.5, 0.15);
                ctx.fillText('Y', 0.15, -maxUnits + 0.5);
                ctx.restore();
                
                // Dibujar c√≠rculo principal
                ctx.strokeStyle = circleColor;
                ctx.lineWidth = 4 / state.scale;
                ctx.beginPath(); 
                ctx.arc(0, 0, state.radius, 0, 2 * Math.PI); 
                ctx.stroke();
                
                // Dibujar √°ngulos principales (0¬∞, 90¬∞, 180¬∞, 270¬∞)
                ctx.save();
                ctx.scale(1, -1); // Voltear texto
                ctx.fillStyle = textColor;
                ctx.font = `${16 / state.scale}px Inter`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                const labelOffset = 1.4;
                ctx.fillText('0¬∞', state.radius * labelOffset, 0);
                ctx.fillText('90¬∞', 0, -state.radius * labelOffset);
                ctx.fillText('180¬∞', -state.radius * labelOffset, 0);
                ctx.fillText('270¬∞', 0, state.radius * labelOffset);
                
                // Etiquetas adicionales en 45¬∞, 135¬∞, 225¬∞, 315¬∞
                const diagonalOffset = labelOffset * 0.9;
                ctx.font = `${14 / state.scale}px Inter`;
                ctx.fillText('45¬∞', state.radius * diagonalOffset * 0.707, -state.radius * diagonalOffset * 0.707);
                ctx.fillText('135¬∞', -state.radius * diagonalOffset * 0.707, -state.radius * diagonalOffset * 0.707);
                ctx.fillText('225¬∞', -state.radius * diagonalOffset * 0.707, state.radius * diagonalOffset * 0.707);
                ctx.fillText('315¬∞', state.radius * diagonalOffset * 0.707, state.radius * diagonalOffset * 0.707);
                ctx.restore();

                drawTrigFunctions(isDark, maxUnits);
                ctx.restore();
            }
            
            function drawTrigFunctions(isDark, maxUnits) {
                const r = state.radius;
                const angleRad = toRadians(state.angle);
                const cos_a = Math.cos(angleRad);
                const sin_a = Math.sin(angleRad);
                
                const P = { x: r * cos_a, y: r * sin_a };

                ctx.lineWidth = 4 / state.scale;
                
                // Seno (l√≠nea vertical desde el punto hasta el eje X)
                ctx.strokeStyle = colors.sin;
                ctx.beginPath(); 
                ctx.moveTo(P.x, 0); 
                ctx.lineTo(P.x, P.y); 
                ctx.stroke();
                
                // Punto en el eje X para seno
                ctx.fillStyle = colors.sin;
                ctx.beginPath();
                ctx.arc(P.x, 0, 5 / state.scale, 0, 2 * Math.PI);
                ctx.fill();
                
                // Coseno (l√≠nea horizontal desde el origen hasta la proyecci√≥n X)
                ctx.strokeStyle = colors.cos;
                ctx.beginPath(); 
                ctx.moveTo(0, 0); 
                ctx.lineTo(P.x, 0); 
                ctx.stroke();

                // Radio con estilo punteado
                ctx.strokeStyle = colors.radius;
                ctx.lineWidth = 3 / state.scale;
                ctx.setLineDash([5 / state.scale, 5 / state.scale]);
                ctx.beginPath(); 
                ctx.moveTo(0, 0); 
                ctx.lineTo(P.x, P.y); 
                ctx.stroke();
                ctx.setLineDash([]);

                // Tangente y Secante
                if (Math.abs(cos_a) > 1e-9) {
                    const tan_val = r * (sin_a / cos_a);
                    const T = { x: r, y: tan_val };
                    
                    // Limitar la visualizaci√≥n de la tangente
                    const maxTan = maxUnits * 2;
                    if (Math.abs(T.y) < maxTan) {
                        // Tangente (l√≠nea vertical desde (r,0) hasta la intersecci√≥n)
                        ctx.strokeStyle = colors.tan;
                        ctx.lineWidth = 4 / state.scale;
                        ctx.beginPath(); 
                        ctx.moveTo(r, 0); 
                        ctx.lineTo(T.x, T.y); 
                        ctx.stroke();
                        
                        // Punto de tangente
                        ctx.fillStyle = colors.tan;
                        ctx.beginPath();
                        ctx.arc(T.x, T.y, 5 / state.scale, 0, 2 * Math.PI);
                        ctx.fill();
                        
                        // Secante (l√≠nea desde el origen hasta T)
                        ctx.strokeStyle = colors.sec;
                        ctx.lineWidth = 3 / state.scale;
                        ctx.setLineDash([3 / state.scale, 3 / state.scale]);
                        ctx.beginPath(); 
                        ctx.moveTo(0, 0); 
                        ctx.lineTo(T.x, T.y); 
                        ctx.stroke();
                        ctx.setLineDash([]);
                    }
                }
                
                // Cotangente y Cosecante
                if (Math.abs(sin_a) > 1e-9) {
                    const cot_val = r * (cos_a / sin_a);
                    const Q = { x: cot_val, y: r };
                    
                    // Limitar la visualizaci√≥n de la cotangente
                    const maxCot = maxUnits * 2;
                    if (Math.abs(Q.x) < maxCot) {
                        // Cotangente (l√≠nea horizontal desde (0,r) hasta la intersecci√≥n)
                        ctx.strokeStyle = colors.cot;
                        ctx.lineWidth = 4 / state.scale;
                        ctx.beginPath(); 
                        ctx.moveTo(0, r); 
                        ctx.lineTo(Q.x, Q.y); 
                        ctx.stroke();
                        
                        // Punto de cotangente
                        ctx.fillStyle = colors.cot;
                        ctx.beginPath();
                        ctx.arc(Q.x, Q.y, 5 / state.scale, 0, 2 * Math.PI);
                        ctx.fill();
                        
                        // Cosecante (l√≠nea desde el origen hasta Q)
                        ctx.strokeStyle = colors.csc;
                        ctx.lineWidth = 3 / state.scale;
                        ctx.setLineDash([3 / state.scale, 3 / state.scale]);
                        ctx.beginPath(); 
                        ctx.moveTo(0, 0); 
                        ctx.lineTo(Q.x, Q.y); 
                        ctx.stroke();
                        ctx.setLineDash([]);
                    }
                }

                // Arco del √°ngulo
                ctx.fillStyle = 'rgba(100, 116, 139, 0.25)';
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.arc(0, 0, r * 0.3, 0, angleRad);
                ctx.closePath();
                ctx.fill();
                
                // Etiqueta del √°ngulo
                ctx.save();
                ctx.scale(1, -1);
                ctx.fillStyle = isDark ? '#e2e8f0' : '#1e293b';
                ctx.font = `bold ${16 / state.scale}px Inter`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                const labelAngle = angleRad / 2;
                const labelRadius = r * 0.45;
                ctx.fillText(`${state.angle}¬∞`, labelRadius * Math.cos(labelAngle), -labelRadius * Math.sin(labelAngle));
                ctx.restore();

                // Dibujar el punto principal m√°s grande
                ctx.fillStyle = isDark ? '#fbbf24' : '#1e293b';
                ctx.strokeStyle = isDark ? '#ffffff' : '#ffffff';
                ctx.lineWidth = 3 / state.scale;
                ctx.beginPath();
                ctx.arc(P.x, P.y, 8 / state.scale, 0, 2 * Math.PI);
                ctx.fill();
                ctx.stroke();
            }

            // --- FUNCIONES DE LEYENDA ---
            function drawLegendCanvases() {
                const canvases = [
                    { canvas: dom.legendSin, type: 'sin' },
                    { canvas: dom.legendCos, type: 'cos' },
                    { canvas: dom.legendTan, type: 'tan' },
                    { canvas: dom.legendCot, type: 'cot' },
                    { canvas: dom.legendSec, type: 'sec' },
                    { canvas: dom.legendCsc, type: 'csc' }
                ];

                canvases.forEach(({ canvas, type }) => {
                    const ctx = canvas.getContext('2d');
                    const rect = canvas.getBoundingClientRect();
                    canvas.width = rect.width;
                    canvas.height = rect.height;
                    
                    drawMiniTrigFunction(ctx, rect.width, rect.height, type);
                });
            }

            function drawMiniTrigFunction(ctx, width, height, type) {
                const isDark = document.documentElement.classList.contains('dark');
                const bgColor = isDark ? '#0f172a' : '#ffffff';
                const gridColor = isDark ? '#374151' : '#e5e7eb';
                const circleColor = isDark ? '#94a3b8' : '#64748b';
                
                // Limpiar y configurar
                ctx.fillStyle = bgColor;
                ctx.fillRect(0, 0, width, height);
                
                const centerX = width / 2;
                const centerY = height / 2;
                const scale = Math.min(width, height) * 0.35;
                
                ctx.save();
                ctx.translate(centerX, centerY);
                ctx.scale(scale, -scale);
                
                // Dibujar ejes
                ctx.strokeStyle = gridColor;
                ctx.lineWidth = 1 / scale;
                ctx.beginPath();
                ctx.moveTo(-1.5, 0);
                ctx.lineTo(1.5, 0);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(0, -1.5);
                ctx.lineTo(0, 1.5);
                ctx.stroke();
                
                // Dibujar c√≠rculo
                ctx.strokeStyle = circleColor;
                ctx.lineWidth = 2 / scale;
                ctx.beginPath();
                ctx.arc(0, 0, 1, 0, 2 * Math.PI);
                ctx.stroke();
                
                // √Ångulo de ejemplo (45¬∞)
                const angle = Math.PI / 4;
                const cos_a = Math.cos(angle);
                const sin_a = Math.sin(angle);
                const P = { x: cos_a, y: sin_a };
                
                // Dibujar la funci√≥n espec√≠fica
                ctx.lineWidth = 3 / scale;
                
                switch(type) {
                    case 'sin':
                        ctx.strokeStyle = colors.sin;
                        ctx.beginPath();
                        ctx.moveTo(P.x, 0);
                        ctx.lineTo(P.x, P.y);
                        ctx.stroke();
                        break;
                        
                    case 'cos':
                        ctx.strokeStyle = colors.cos;
                        ctx.beginPath();
                        ctx.moveTo(0, 0);
                        ctx.lineTo(P.x, 0);
                        ctx.stroke();
                        break;
                        
                    case 'tan':
                        ctx.strokeStyle = colors.tan;
                        const tan_y = Math.tan(angle);
                        ctx.beginPath();
                        ctx.moveTo(1, 0);
                        ctx.lineTo(1, tan_y);
                        ctx.stroke();
                        break;
                        
                    case 'cot':
                        ctx.strokeStyle = colors.cot;
                        const cot_x = 1 / Math.tan(angle);
                        ctx.beginPath();
                        ctx.moveTo(0, 1);
                        ctx.lineTo(cot_x, 1);
                        ctx.stroke();
                        break;
                        
                    case 'sec':
                        ctx.strokeStyle = colors.sec;
                        const sec_y = Math.tan(angle);
                        ctx.beginPath();
                        ctx.moveTo(0, 0);
                        ctx.lineTo(1, sec_y);
                        ctx.stroke();
                        break;
                        
                    case 'csc':
                        ctx.strokeStyle = colors.csc;
                        const csc_x = 1 / Math.tan(angle);
                        ctx.beginPath();
                        ctx.moveTo(0, 0);
                        ctx.lineTo(csc_x, 1);
                        ctx.stroke();
                        break;
                }
                
                // Radio
                ctx.strokeStyle = colors.radius;
                ctx.lineWidth = 1 / scale;
                ctx.setLineDash([3 / scale, 3 / scale]);
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.lineTo(P.x, P.y);
                ctx.stroke();
                
                // Punto
                ctx.fillStyle = colors.point;
                ctx.beginPath();
                ctx.arc(P.x, P.y, 4 / scale, 0, 2 * Math.PI);
                ctx.fill();
                
                ctx.restore();
            }

            // --- ANIMACI√ìN ---
            function toggleAnimation() {
                if (state.isAnimating) {
                    state.isAnimating = false;
                    if (state.animationId) {
                        cancelAnimationFrame(state.animationId);
                    }
                    dom.animateBtn.innerHTML = '<i data-lucide="play" class="w-5 h-5"></i>';
                } else {
                    state.isAnimating = true;
                    dom.animateBtn.innerHTML = '<i data-lucide="pause" class="w-5 h-5"></i>';
                    animate();
                }
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }

            function animate() {
                if (!state.isAnimating) return;
                
                state.angle = (state.angle + 1) % 360;
                dom.angleSlider.value = state.angle;
                updateValues();
                draw();
                
                state.animationId = requestAnimationFrame(animate);
            }

            // --- EVENT LISTENERS ---
            window.addEventListener('resize', adjustLayout);
            
            // Controles
            dom.angleSlider.addEventListener('input', (e) => {
                state.angle = parseInt(e.target.value);
                updateValues();
                draw();
            });
            
            dom.radiusSlider.addEventListener('input', (e) => {
                state.radius = parseFloat(e.target.value);
                updateValues();
                setupCanvas();
            });

            // Botones de √°ngulos especiales
            document.querySelectorAll('.angle-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    state.angle = parseInt(btn.dataset.angle);
                    dom.angleSlider.value = state.angle;
                    updateValues();
                    draw();
                });
            });

            // Botones de la barra de herramientas
            dom.homeBtn.addEventListener('click', () => {
                state.panOffset = { x: 0, y: 0 };
                state.scale = 140;
                state.angle = 45;
                state.radius = 1.0;
                dom.angleSlider.value = 45;
                dom.radiusSlider.value = 1.0;
                updateValues();
                draw();
            });

            dom.animateBtn.addEventListener('click', toggleAnimation);

            dom.legendBtn.addEventListener('click', () => openModal(dom.legendModal));
            dom.closeLegendBtn.addEventListener('click', () => closeModal(dom.legendModal));

            dom.helpModalBtn.addEventListener('click', () => openModal(dom.helpModal));
            dom.closeHelpBtn.addEventListener('click', () => closeModal(dom.helpModal));

            dom.themeToggleBtn.addEventListener('click', () => {
                const isDark = document.documentElement.classList.contains('dark');
                applyTheme(isDark ? 'light' : 'dark');
            });

            // Interacciones del canvas
            function addCanvasListeners(canvas) {
                function getEventPosition(e, touchIndex = 0) {
                    const rect = canvas.getBoundingClientRect();
                    return {
                        x: (e.touches ? e.touches[touchIndex].clientX : e.clientX) - rect.left,
                        y: (e.touches ? e.touches[touchIndex].clientY : e.clientY) - rect.top
                    };
                }

                // Clic en el c√≠rculo para ajustar √°ngulo
                canvas.addEventListener('click', (e) => {
                    if (!state.isPanning) {
                        const rect = canvas.getBoundingClientRect();
                        const pos = getEventPosition(e);
                        const centerX = rect.width / 2 + state.panOffset.x;
                        const centerY = rect.height / 2 + state.panOffset.y;
                        
                        const dx = pos.x - centerX;
                        const dy = centerY - pos.y; // Invertir Y
                        
                        let angle = Math.atan2(dy, dx) * 180 / Math.PI;
                        if (angle < 0) angle += 360;
                        
                        state.angle = Math.round(angle);
                        dom.angleSlider.value = state.angle;
                        updateValues();
                        draw();
                    }
                });

                // Zoom con rueda del mouse
                canvas.addEventListener('wheel', e => {
                    e.preventDefault();
                    const zoomFactor = e.deltaY < 0 ? 1.1 : 1 / 1.1;
                    const newScale = state.scale * zoomFactor;
                    
                    // Limitar el zoom
                    if (newScale >= 50 && newScale <= 500) {
                        state.scale = newScale;
                        draw();
                    }
                }, { passive: false });

                // Pan con mouse
                let mouseDownTime = 0;
                canvas.addEventListener('mousedown', e => {
                    mouseDownTime = Date.now();
                    state.isPanning = true;
                    const pos = getEventPosition(e);
                    state.panStart = { x: pos.x - state.panOffset.x, y: pos.y - state.panOffset.y };
                });

                canvas.addEventListener('mousemove', e => {
                    if (!state.isPanning) return;
                    const pos = getEventPosition(e);
                    state.panOffset = { x: pos.x - state.panStart.x, y: pos.y - state.panStart.y };
                    draw();
                });

                canvas.addEventListener('mouseup', () => {
                    // Solo considerar como paneo si el mouse estuvo presionado m√°s de 150ms
                    if (Date.now() - mouseDownTime < 150) {
                        state.isPanning = false;
                    }
                    setTimeout(() => {
                        state.isPanning = false;
                    }, 10);
                });

                canvas.addEventListener('mouseleave', () => {
                    state.isPanning = false;
                });

                // Touch support
                let lastPinchDistance = 0;

                canvas.addEventListener('touchstart', e => {
                    if (e.touches.length === 2) {
                        const pos1 = getEventPosition(e, 0);
                        const pos2 = getEventPosition(e, 1);
                        lastPinchDistance = Math.hypot(pos1.x - pos2.x, pos1.y - pos2.y);
                        state.isPanning = false;
                    } else if (e.touches.length === 1) {
                        state.isPanning = true;
                        const pos = getEventPosition(e);
                        state.panStart = { x: pos.x - state.panOffset.x, y: pos.y - state.panOffset.y };
                    }
                }, { passive: false });

                canvas.addEventListener('touchmove', e => {
                    e.preventDefault();
                    if (e.touches.length === 2) {
                        const pos1 = getEventPosition(e, 0);
                        const pos2 = getEventPosition(e, 1);
                        const currentDist = Math.hypot(pos1.x - pos2.x, pos1.y - pos2.y);
                        const zoomFactor = currentDist / lastPinchDistance;
                        const newScale = state.scale * zoomFactor;
                        
                        if (newScale >= 50 && newScale <= 500) {
                            state.scale = newScale;
                        }
                        lastPinchDistance = currentDist;
                        draw();
                    } else if (e.touches.length === 1 && state.isPanning) {
                        const pos = getEventPosition(e);
                        state.panOffset = { x: pos.x - state.panStart.x, y: pos.y - state.panStart.y };
                        draw();
                    }
                }, { passive: false });

                canvas.addEventListener('touchend', () => {
                    state.isPanning = false;
                    lastPinchDistance = 0;
                });
            }

            addCanvasListeners(dom.canvas);

            // --- INICIALIZACI√ìN ---
            // Cargar iconos inicialmente
            setTimeout(() => {
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }, 100);
            
            window.addEventListener('load', () => {
                const savedTheme = localStorage.getItem('theme') || 'light';
                applyTheme(savedTheme);
                adjustLayout();
                updateValues();
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            });
        });
    </script>
</body>
</html>