<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Círculo Trigonométrico Interactivo</title>
    
    <!-- Librerías y Fuentes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        // Cargar lucide de forma asíncrona
        (function() {
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/lucide@latest/dist/umd/lucide.js';
            script.onload = function() {
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            };
            document.head.appendChild(script);
        })();
    </script>

    <!-- Estilos CSS -->
    <style>
        :root {
            --background: 220 14.3% 95.9%;
            --foreground: 224 71.4% 4.1%;
            --card: 0 0% 100%;
            --card-foreground: 224 71.4% 4.1%;
            --primary: 220.9 39.3% 11%;
            --primary-foreground: 210 20% 98%;
            --secondary: 220 13% 91%;
            --secondary-foreground: 220.9 39.3% 11%;
            --muted: 220 13% 91%;
            --muted-foreground: 225 8.9% 46.1%;
            --accent: 48 96% 59%;
            --border: 220 13% 85%;
            --ring: 220.9 39.3% 11%;
            --radius: 0.75rem;
        }

        .dark {
            --background: 222 83.9% 4.9%;
            --foreground: 210 20% 98%;
            --card: 222 47.4% 11.2%;
            --card-foreground: 210 20% 98%;
            --primary: 210 20% 98%;
            --primary-foreground: 222 47.4% 11.2%;
            --secondary: 217 32.6% 17.5%;
            --secondary-foreground: 210 20% 98%;
            --muted: 217 32.6% 17.5%;
            --muted-foreground: 215 20.2% 65.1%;
            --border: 217 32.6% 17.5%;
            --ring: 215 20.2% 65.1%;
        }

        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
            transition: background-color 0.3s, color 0.3s;
        }
        .canvas-container {
            touch-action: manipulation;
            overflow: hidden;
            cursor: grab;
            position: relative;
        }
        .canvas-container:active { cursor: grabbing; }
        .modal { transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-content { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s ease; }
        
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: hsl(var(--secondary));
            border-radius: 9999px;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: hsl(var(--primary));
            cursor: pointer;
            border-radius: 50%;
            border: 3px solid hsl(var(--card));
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }
        input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.1); }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: hsl(var(--primary));
            cursor: pointer;
            border-radius: 50%;
            border: 3px solid hsl(var(--card));
        }
        .angle-button { transition: all 0.2s ease; }
        .angle-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .angle-button.active {
            background-color: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
        }
        .legend-canvas {
            border: 1px solid hsl(var(--border));
            border-radius: 8px;
        }
        /* UPDATED: Estilos para el canvas principal para garantizar que ocupe todo el contenedor */
        #trig-canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body class="antialiased">
    <div class="relative min-h-screen container mx-auto p-4 md:p-8 lg:p-12">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-slate-800 dark:text-slate-50 mb-2">
                Círculo Trigonométrico
            </h1>
            <p class="text-lg text-slate-500 dark:text-slate-400">Visualización interactiva de las funciones trigonométricas</p>
        </header>

        <!-- Barra de Herramientas Flotante -->
        <div class="absolute top-4 right-4 z-40 bg-white dark:bg-slate-800 p-2 rounded-full shadow-lg border border-slate-300 dark:border-slate-600 flex items-center gap-1">
            <button id="home-btn" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700" aria-label="Reiniciar"><i data-lucide="home" class="w-5 h-5"></i></button>
            <button id="animate-btn" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700" aria-label="Animar"><i data-lucide="play" class="w-5 h-5"></i></button>
            <button id="legend-btn" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700" aria-label="Mostrar Leyenda"><i data-lucide="book-image" class="w-5 h-5"></i></button>
            <button id="theme-toggle-btn" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700" aria-label="Cambiar Tema"><i data-lucide="sun" class="w-5 h-5 block dark:hidden"></i><i data-lucide="moon" class="w-5 h-5 hidden dark:block"></i></button>
            <button id="help-modal-btn" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700" aria-label="Mostrar ayuda"><i data-lucide="help-circle" class="w-5 h-5"></i></button>
        </div>

        <!-- Layout principal con Flexbox -->
        <div class="flex flex-col lg:flex-row gap-8 lg:gap-12">
            <!-- Columna de Controles y Datos (ocupa 1/3 del ancho en LG) -->
            <div class="w-full lg:w-1/3 space-y-6">
                <div id="parameters-panel" class="bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-2xl shadow-lg p-6">
                    <h2 class="text-2xl font-semibold mb-6 flex items-center gap-2"><i data-lucide="sliders-horizontal"></i> Controles</h2>
                    <div class="space-y-6">
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <label for="angle-slider" class="text-sm font-medium text-slate-500 dark:text-slate-400">Ángulo (θ)</label>
                                <div class="flex items-center gap-2">
                                    <span id="angle-value" class="px-2 py-1 text-sm font-semibold rounded-md bg-slate-100 dark:bg-slate-700">45°</span>
                                    <span id="angle-rad" class="px-2 py-1 text-sm font-medium rounded-md bg-slate-100 dark:bg-slate-700">π/4 rad</span>
                                </div>
                            </div>
                            <input type="range" id="angle-slider" min="0" max="360" value="45" step="1">
                            <div class="mt-3 grid grid-cols-4 sm:grid-cols-6 lg:grid-cols-4 gap-2">
                                <button class="angle-button px-2 py-1 text-sm font-medium rounded-md bg-slate-100 dark:bg-slate-700" data-angle="0">0°</button>
                                <button class="angle-button px-2 py-1 text-sm font-medium rounded-md bg-slate-100 dark:bg-slate-700" data-angle="30">30°</button>
                                <button class="angle-button px-2 py-1 text-sm font-medium rounded-md bg-slate-100 dark:bg-slate-700" data-angle="45">45°</button>
                                <button class="angle-button px-2 py-1 text-sm font-medium rounded-md bg-slate-100 dark:bg-slate-700" data-angle="60">60°</button>
                                <button class="angle-button px-2 py-1 text-sm font-medium rounded-md bg-slate-100 dark:bg-slate-700" data-angle="90">90°</button>
                                <button class="angle-button px-2 py-1 text-sm font-medium rounded-md bg-slate-100 dark:bg-slate-700" data-angle="180">180°</button>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <label for="radius-slider" class="text-sm font-medium text-slate-500 dark:text-slate-400">Radio (r)</label>
                                <span id="radius-value" class="px-2 py-1 text-sm font-semibold rounded-md bg-slate-100 dark:bg-slate-700">1.0</span>
                            </div>
                            <input type="range" id="radius-slider" min="0.5" max="2.5" value="1.0" step="0.1">
                        </div>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-2xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold mb-4 flex items-center gap-2"><i data-lucide="calculator"></i> Valores</h2>
                    <div id="values-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 xl:grid-cols-2 gap-4"></div>
                </div>

                <div class="bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-2xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold mb-4 flex items-center gap-2"><i data-lucide="compass"></i> Coordenadas</h2>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="flex justify-between items-center bg-slate-100 dark:bg-slate-700 p-2 rounded-lg"><span class="text-sm font-medium text-slate-600 dark:text-slate-300">X (cos θ)</span><span id="coord-x" class="font-bold text-base">0.71</span></div>
                        <div class="flex justify-between items-center bg-slate-100 dark:bg-slate-700 p-2 rounded-lg"><span class="text-sm font-medium text-slate-600 dark:text-slate-300">Y (sin θ)</span><span id="coord-y" class="font-bold text-base">0.71</span></div>
                    </div>
                    <div class="mt-3 flex justify-center"><div class="bg-slate-100 dark:bg-slate-700 px-3 py-1 rounded-lg"><span class="text-sm font-medium text-slate-600 dark:text-slate-300">Cuadrante: </span><span id="quadrant" class="font-bold text-base">I</span></div></div>
                </div>
            </div>
            
            <!-- Columna de Simulación (ocupa el espacio restante) -->
            <div class="w-full lg:flex-1">
                <!-- UPDATED: Se eliminó el estilo aspect-ratio para un diseño más flexible -->
                <div id="canvas-container" class="canvas-container bg-gradient-to-br from-white via-white to-slate-50 dark:from-slate-900 dark:via-slate-900 dark:to-slate-800 border border-slate-300 dark:border-slate-600 rounded-2xl shadow-xl w-full h-[500px] lg:h-[calc(100vh-12rem)]">
                    <canvas id="trig-canvas"></canvas>
                </div>
            </div>
        </div>
        
        <footer class="text-center mt-12 py-4 border-t border-slate-300 dark:border-slate-600"><p class="text-sm text-slate-500 dark:text-slate-400">Círculo Trigonométrico Interactivo por Gemini</p></footer>

        <!-- Modal de Leyenda (Diseño Mejorado) -->
        <div id="legend-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 opacity-0 pointer-events-none modal">
            <div class="modal-content bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col transform scale-95">
                <div class="flex items-center justify-between p-6 border-b border-slate-300 dark:border-slate-600">
                    <h2 class="text-xl font-bold flex items-center gap-2"><i data-lucide="palette"></i> Leyenda de Funciones</h2>
                    <button id="close-legend-btn" class="p-2 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700"><i data-lucide="x"></i></button>
                </div>
                <div class="p-6 overflow-y-auto">
                    <div class="space-y-6">
                        <div class="flex flex-col sm:flex-row items-center gap-4 p-4 bg-slate-50 dark:bg-slate-900/50 rounded-lg">
                            <div class="flex-1 space-y-2">
                                <div class="flex items-center gap-3"><div class="w-5 h-5 rounded" style="background-color: #ef4444;"></div><h3 class="font-bold text-lg">Seno (sin θ)</h3></div>
                                <p class="text-sm text-slate-600 dark:text-slate-400 ml-8">Es la <strong>proyección vertical</strong> (coordenada Y) del punto en el círculo. Representa la altura del punto desde el eje X.</p>
                            </div>
                            <div class="w-full sm:w-40 h-32 flex-shrink-0"><canvas id="legend-sin" class="legend-canvas w-full h-full bg-white dark:bg-slate-800"></canvas></div>
                        </div>
                        <div class="flex flex-col sm:flex-row items-center gap-4 p-4 bg-slate-50 dark:bg-slate-900/50 rounded-lg">
                            <div class="flex-1 space-y-2">
                                <div class="flex items-center gap-3"><div class="w-5 h-5 rounded" style="background-color: #3b82f6;"></div><h3 class="font-bold text-lg">Coseno (cos θ)</h3></div>
                                <p class="text-sm text-slate-600 dark:text-slate-400 ml-8">Es la <strong>proyección horizontal</strong> (coordenada X) del punto en el círculo. Representa la distancia horizontal desde el eje Y.</p>
                            </div>
                            <div class="w-full sm:w-40 h-32 flex-shrink-0"><canvas id="legend-cos" class="legend-canvas w-full h-full bg-white dark:bg-slate-800"></canvas></div>
                        </div>
                        <div class="flex flex-col sm:flex-row items-center gap-4 p-4 bg-slate-50 dark:bg-slate-900/50 rounded-lg">
                            <div class="flex-1 space-y-2">
                                <div class="flex items-center gap-3"><div class="w-5 h-5 rounded" style="background-color: #16a34a;"></div><h3 class="font-bold text-lg">Tangente (tan θ)</h3></div>
                                <p class="text-sm text-slate-600 dark:text-slate-400 ml-8">Segmento de la línea <strong>tangente vertical</strong> al círculo en (r, 0), desde el eje X hasta la prolongación del radio.</p>
                            </div>
                            <div class="w-full sm:w-40 h-32 flex-shrink-0"><canvas id="legend-tan" class="legend-canvas w-full h-full bg-white dark:bg-slate-800"></canvas></div>
                        </div>
                        <div class="flex flex-col sm:flex-row items-center gap-4 p-4 bg-slate-50 dark:bg-slate-900/50 rounded-lg">
                            <div class="flex-1 space-y-2">
                                <div class="flex items-center gap-3"><div class="w-5 h-5 rounded" style="background-color: #f97316;"></div><h3 class="font-bold text-lg">Cotangente (cot θ)</h3></div>
                                <p class="text-sm text-slate-600 dark:text-slate-400 ml-8">Segmento de la línea <strong>tangente horizontal</strong> al círculo en (0, r), desde el eje Y hasta la prolongación del radio.</p>
                            </div>
                            <div class="w-full sm:w-40 h-32 flex-shrink-0"><canvas id="legend-cot" class="legend-canvas w-full h-full bg-white dark:bg-slate-800"></canvas></div>
                        </div>
                        <div class="flex flex-col sm:flex-row items-center gap-4 p-4 bg-slate-50 dark:bg-slate-900/50 rounded-lg">
                            <div class="flex-1 space-y-2">
                                <div class="flex items-center gap-3"><div class="w-5 h-5 rounded" style="background-color: #a855f7;"></div><h3 class="font-bold text-lg">Secante (sec θ)</h3></div>
                                <p class="text-sm text-slate-600 dark:text-slate-400 ml-8">Línea que va desde el <strong>origen hasta el punto final</strong> de la línea de la tangente.</p>
                            </div>
                            <div class="w-full sm:w-40 h-32 flex-shrink-0"><canvas id="legend-sec" class="legend-canvas w-full h-full bg-white dark:bg-slate-800"></canvas></div>
                        </div>
                        <div class="flex flex-col sm:flex-row items-center gap-4 p-4 bg-slate-50 dark:bg-slate-900/50 rounded-lg">
                            <div class="flex-1 space-y-2">
                                <div class="flex items-center gap-3"><div class="w-5 h-5 rounded" style="background-color: #eab308;"></div><h3 class="font-bold text-lg">Cosecante (csc θ)</h3></div>
                                <p class="text-sm text-slate-600 dark:text-slate-400 ml-8">Línea que va desde el <strong>origen hasta el punto final</strong> de la línea de la cotangente.</p>
                            </div>
                            <div class="w-full sm:w-40 h-32 flex-shrink-0"><canvas id="legend-csc" class="legend-canvas w-full h-full bg-white dark:bg-slate-800"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de Ayuda -->
        <div id="help-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 opacity-0 pointer-events-none modal">
            <div class="modal-content bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col transform scale-95">
                <div class="flex items-center justify-between p-6 border-b border-slate-300 dark:border-slate-600">
                    <h2 class="text-xl font-bold flex items-center gap-2"><i data-lucide="book-open-check"></i> Guía de Uso</h2>
                    <button id="close-help-btn" class="p-2 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700"><i data-lucide="x"></i></button>
                </div>
                <div class="p-6 overflow-y-auto space-y-4">
                    <div class="bg-slate-100/50 dark:bg-slate-700/50 p-4 rounded-lg">
                        <h3 class="font-semibold text-lg mb-3">Cómo Interactuar</h3>
                        <ul class="list-disc list-inside ml-2 space-y-2 text-slate-600 dark:text-slate-300">
                            <li><strong>Zoom:</strong> Pellizca la pantalla o usa la rueda del mouse.</li>
                            <li><strong>Mover Vista (Pan):</strong> Arrastra con un dedo o con el mouse.</li>
                            <li><strong>Ajustar Ángulo:</strong> Usa el deslizador, los botones o toca/haz clic en el círculo.</li>
                            <li><strong>Leyenda:</strong> Presiona el ícono <i data-lucide="book-image" class="inline-block w-4 h-4"></i> para ver la guía de colores.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- REFERENCIAS AL DOM ---
            const dom = {
                canvas: document.getElementById('trig-canvas'),
                canvasContainer: document.getElementById('canvas-container'),
                angleSlider: document.getElementById('angle-slider'),
                angleValue: document.getElementById('angle-value'),
                angleRad: document.getElementById('angle-rad'),
                radiusSlider: document.getElementById('radius-slider'),
                radiusValue: document.getElementById('radius-value'),
                valuesGrid: document.getElementById('values-grid'),
                coordX: document.getElementById('coord-x'),
                coordY: document.getElementById('coord-y'),
                quadrant: document.getElementById('quadrant'),
                homeBtn: document.getElementById('home-btn'),
                animateBtn: document.getElementById('animate-btn'),
                legendBtn: document.getElementById('legend-btn'),
                themeToggleBtn: document.getElementById('theme-toggle-btn'),
                helpModalBtn: document.getElementById('help-modal-btn'),
                legendModal: document.getElementById('legend-modal'),
                closeLegendBtn: document.getElementById('close-legend-btn'),
                helpModal: document.getElementById('help-modal'),
                closeHelpBtn: document.getElementById('close-help-btn'),
                legendSin: document.getElementById('legend-sin'),
                legendCos: document.getElementById('legend-cos'),
                legendTan: document.getElementById('legend-tan'),
                legendCot: document.getElementById('legend-cot'),
                legendSec: document.getElementById('legend-sec'),
                legendCsc: document.getElementById('legend-csc'),
            };

            const ctx = dom.canvas.getContext('2d');
            
            // --- ESTADO Y COLORES ---
            // NEW: Función para obtener la escala inicial según el tamaño de la pantalla
            function getInitialScale() {
                // Usa una escala más pequeña para pantallas angostas (móviles)
                return window.innerWidth < 768 ? 90 : 140;
            }

            const state = { 
                angle: 45, 
                radius: 1.0, 
                scale: getInitialScale(), // UPDATED: Usa la función para la escala inicial
                panOffset: { x: 0, y: 0 }, 
                isDragging: false, 
                panStart: { x: 0, y: 0 }, 
                isAnimating: false, 
                animationId: null, 
                lastPinchDistance: 0, 
                width: 0, 
                height: 0 
            };
            const colors = { sin: '#ef4444', cos: '#3b82f6', tan: '#16a34a', cot: '#f97316', sec: '#a855f7', csc: '#eab308', radius: '#6b7280', point: '#1e293b' };

            // --- FUNCIONES UTILITARIAS Y DE UI ---
            const toRadians = (degrees) => degrees * Math.PI / 180;
            const formatRadians = (degrees) => ({ 0: '0', 30: 'π/6', 45: 'π/4', 60: 'π/3', 90: 'π/2', 120: '2π/3', 135: '3π/4', 150: '5π/6', 180: 'π', 210: '7π/6', 225: '5π/4', 240: '4π/3', 270: '3π/2', 300: '5π/3', 315: '7π/4', 330: '11π/6', 360: '2π' }[degrees] || (degrees * Math.PI / 180 / Math.PI).toFixed(2) + 'π');
            
            function openModal(modal) {
                modal.classList.remove('opacity-0', 'pointer-events-none');
                modal.querySelector('.modal-content').classList.remove('scale-95');
                if (modal === dom.legendModal) drawLegendCanvases();
            }
            function closeModal(modal) {
                modal.classList.add('opacity-0');
                modal.querySelector('.modal-content').classList.add('scale-95');
                setTimeout(() => modal.classList.add('pointer-events-none'), 300);
            }
            function applyTheme(theme) {
                document.documentElement.classList.toggle('dark', theme === 'dark');
                localStorage.setItem('theme', theme);
                draw();
                if (!dom.legendModal.classList.contains('opacity-0')) drawLegendCanvases();
            }

            function updateValues() {
                const angleRad = toRadians(state.angle);
                const f = { sin: Math.sin(angleRad), cos: Math.cos(angleRad), tan: Math.tan(angleRad), cot: 1 / Math.tan(angleRad), sec: 1 / Math.cos(angleRad), csc: 1 / Math.sin(angleRad) };
                dom.angleValue.textContent = `${state.angle}°`;
                dom.angleRad.textContent = formatRadians(state.angle);
                dom.radiusValue.textContent = state.radius.toFixed(1);
                dom.coordX.textContent = (state.radius * f.cos).toFixed(3);
                dom.coordY.textContent = (state.radius * f.sin).toFixed(3);
                dom.quadrant.textContent = (state.angle > 0 && state.angle < 90) ? 'I' : (state.angle > 90 && state.angle < 180) ? 'II' : (state.angle > 180 && state.angle < 270) ? 'III' : (state.angle > 270 && state.angle < 360) ? 'IV' : 'Eje';
                dom.valuesGrid.innerHTML = Object.entries(f).map(([key, value]) => `<div class="flex justify-between items-center bg-slate-100 dark:bg-slate-700 p-3 rounded-lg"><span class="text-sm font-medium" style="color: ${colors[key]}">${key} θ</span><strong class="text-base" style="color: ${colors[key]}">${isFinite(value) ? value.toFixed(4) : '∞'}</strong></div>`).join('');
                document.querySelectorAll('.angle-button').forEach(btn => btn.classList.toggle('active', parseInt(btn.dataset.angle) === state.angle));
            }

            // --- FUNCIONES DEL CANVAS PRINCIPAL ---
            function setupCanvas() {
                const dpr = window.devicePixelRatio || 1;
                const rect = dom.canvasContainer.getBoundingClientRect();
                state.width = rect.width;
                state.height = rect.height;
                
                dom.canvas.width = state.width * dpr;
                dom.canvas.height = state.height * dpr;
                ctx.scale(dpr, dpr);
                draw();
            }

            function draw() {
                const width = state.width;
                const height = state.height;
                if (width === 0 || height === 0) return;

                const isDark = document.documentElement.classList.contains('dark');
                const theme = { bg: isDark ? '#0f172a' : '#ffffff', grid: isDark ? '#374151' : '#e5e7eb', axis: isDark ? '#9ca3af' : '#4b5563', circle: isDark ? '#e2e8f0' : '#1e293b', text: isDark ? '#9ca3af' : '#6b7280', point: isDark ? '#fbbf24' : '#1e293b', pointBorder: '#ffffff' };
                ctx.fillStyle = theme.bg;
                ctx.fillRect(0, 0, width, height);
                const centerX = width / 2 + state.panOffset.x;
                const centerY = height / 2 + state.panOffset.y;
                ctx.save();
                ctx.translate(centerX, centerY);
                ctx.scale(state.scale, -state.scale);
                const maxUnits = Math.max(width, height) / state.scale + 2;
                
                // Grilla y Ejes (Líneas más finas)
                ctx.strokeStyle = theme.grid; ctx.lineWidth = 0.5 / state.scale;
                for (let i = -Math.ceil(maxUnits); i <= Math.ceil(maxUnits); i++) { ctx.beginPath(); ctx.moveTo(i, -maxUnits); ctx.lineTo(i, maxUnits); ctx.stroke(); ctx.beginPath(); ctx.moveTo(-maxUnits, i); ctx.lineTo(maxUnits, i); ctx.stroke(); }
                ctx.strokeStyle = theme.axis; ctx.lineWidth = 1.5 / state.scale;
                ctx.beginPath(); ctx.moveTo(-maxUnits, 0); ctx.lineTo(maxUnits, 0); ctx.stroke(); ctx.beginPath(); ctx.moveTo(0, -maxUnits); ctx.lineTo(0, maxUnits); ctx.stroke();
                
                // Etiquetas de Ejes
                ctx.fillStyle = theme.text; ctx.font = `${14 / state.scale}px Inter`;
                ctx.save(); ctx.scale(1, -1);
                const tickStep = state.scale > 70 ? 1 : 2;
                for (let i = -Math.floor(maxUnits); i <= Math.floor(maxUnits); i++) {
                    if (i !== 0 && i % tickStep === 0) {
                        ctx.textAlign = 'center'; ctx.textBaseline = 'top'; ctx.fillText(i.toString(), i, 0.1);
                        ctx.textAlign = 'right'; ctx.textBaseline = 'middle'; ctx.fillText(i.toString(), -0.1, -i);
                    }
                }
                ctx.restore();

                // Círculo y Funciones
                ctx.strokeStyle = theme.circle; ctx.lineWidth = 2 / state.scale;
                ctx.beginPath(); ctx.arc(0, 0, state.radius, 0, 2 * Math.PI); ctx.stroke();
                drawTrigFunctions(theme, maxUnits);
                ctx.restore();
            }
            
            function drawTrigFunctions(theme, maxUnits) {
                const r = state.radius, angleRad = toRadians(state.angle), cos_a = Math.cos(angleRad), sin_a = Math.sin(angleRad), P = { x: r * cos_a, y: r * sin_a };
                
                // Funciones principales (Líneas más finas)
                ctx.lineWidth = 2.5 / state.scale; 
                ctx.strokeStyle = colors.sin; ctx.beginPath(); ctx.moveTo(P.x, 0); ctx.lineTo(P.x, P.y); ctx.stroke();
                ctx.strokeStyle = colors.cos; ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(P.x, 0); ctx.stroke();
                
                // Radio y líneas secundarias
                ctx.lineWidth = 1.5 / state.scale;
                ctx.strokeStyle = colors.radius; ctx.setLineDash([4 / state.scale, 4 / state.scale]);
                ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(P.x, P.y); ctx.stroke();
                ctx.setLineDash([]);
                
                if (Math.abs(cos_a) > 1e-9) {
                    const T = { x: r, y: r * (sin_a / cos_a) };
                    if (Math.abs(T.y) < maxUnits * 1.5) {
                        ctx.strokeStyle = colors.tan; ctx.lineWidth = 2.5 / state.scale; ctx.beginPath(); ctx.moveTo(r, 0); ctx.lineTo(T.x, T.y); ctx.stroke();
                        ctx.strokeStyle = colors.sec; ctx.lineWidth = 1.5 / state.scale; ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(T.x, T.y); ctx.stroke();
                    }
                }
                if (Math.abs(sin_a) > 1e-9) {
                    const Q = { x: r * (cos_a / sin_a), y: r };
                     if (Math.abs(Q.x) < maxUnits * 1.5) {
                        ctx.strokeStyle = colors.cot; ctx.lineWidth = 2.5 / state.scale; ctx.beginPath(); ctx.moveTo(0, r); ctx.lineTo(Q.x, Q.y); ctx.stroke();
                        ctx.strokeStyle = colors.csc; ctx.lineWidth = 1.5 / state.scale; ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(Q.x, Q.y); ctx.stroke();
                    }
                }
                
                // Arco y Punto
                ctx.fillStyle = 'rgba(100, 116, 139, 0.25)'; ctx.beginPath(); ctx.moveTo(0, 0); ctx.arc(0, 0, r * 0.3, 0, angleRad); ctx.closePath(); ctx.fill();
                ctx.fillStyle = theme.point; ctx.strokeStyle = theme.pointBorder; ctx.lineWidth = 1.5 / state.scale;
                ctx.beginPath(); ctx.arc(P.x, P.y, 5 / state.scale, 0, 2 * Math.PI); ctx.fill(); ctx.stroke();
            }

            // --- FUNCIONES DE LEYENDA ---
            function drawLegendCanvases() {
                const legendCanvases = { sin: dom.legendSin, cos: dom.legendCos, tan: dom.legendTan, cot: dom.legendCot, sec: dom.legendSec, csc: dom.legendCsc };
                Object.entries(legendCanvases).forEach(([type, canvas]) => {
                    if(canvas) {
                        const ctx = canvas.getContext('2d');
                        const rect = canvas.getBoundingClientRect();
                        canvas.width = rect.width; canvas.height = rect.height;
                        drawMiniTrigFunction(ctx, rect.width, rect.height, type);
                    }
                });
            }

            function drawMiniTrigFunction(ctx, width, height, type) {
                const isDark = document.documentElement.classList.contains('dark');
                const theme = { bg: isDark ? '#1e293b' : '#ffffff', grid: isDark ? '#475569' : '#e2e8f0', circle: isDark ? '#94a3b8' : '#64748b' };
                ctx.fillStyle = theme.bg; ctx.fillRect(0, 0, width, height);
                const centerX = width / 2, centerY = height / 2, scale = Math.min(width, height) * 0.35;
                ctx.save(); ctx.translate(centerX, centerY); ctx.scale(scale, -scale);
                ctx.strokeStyle = theme.grid; ctx.lineWidth = 1 / scale;
                ctx.beginPath(); ctx.moveTo(-1.5, 0); ctx.lineTo(1.5, 0); ctx.stroke(); ctx.beginPath(); ctx.moveTo(0, -1.5); ctx.lineTo(0, 1.5); ctx.stroke();
                ctx.strokeStyle = theme.circle; ctx.lineWidth = 1.5 / scale; ctx.beginPath(); ctx.arc(0, 0, 1, 0, 2 * Math.PI); ctx.stroke();
                const angle = Math.PI / 4, cos_a = Math.cos(angle), sin_a = Math.sin(angle), P = { x: cos_a, y: sin_a };
                
                ctx.strokeStyle = colors[type]; ctx.lineWidth = 2.5 / scale;
                ctx.beginPath();
                switch(type) {
                    case 'sin': ctx.moveTo(P.x, 0); ctx.lineTo(P.x, P.y); break;
                    case 'cos': ctx.moveTo(0, 0); ctx.lineTo(P.x, 0); break;
                    case 'tan': ctx.moveTo(1, 0); ctx.lineTo(1, Math.tan(angle)); break;
                    case 'cot': ctx.moveTo(0, 1); ctx.lineTo(1 / Math.tan(angle), 1); break;
                    case 'sec': ctx.moveTo(0, 0); ctx.lineTo(1, Math.tan(angle)); break;
                    case 'csc': ctx.moveTo(0, 0); ctx.lineTo(1 / Math.tan(angle), 1); break;
                }
                ctx.stroke();
                
                ctx.strokeStyle = colors.radius; ctx.lineWidth = 1 / scale; ctx.setLineDash([3 / scale, 3 / scale]);
                ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(P.x, P.y); ctx.stroke();
                ctx.fillStyle = isDark ? '#f1f5f9' : '#1e293b'; ctx.beginPath(); ctx.arc(P.x, P.y, 4 / scale, 0, 2 * Math.PI); ctx.fill();
                ctx.restore();
            }

            // --- ANIMACIÓN Y EVENTOS ---
            function toggleAnimation() {
                state.isAnimating = !state.isAnimating;
                dom.animateBtn.innerHTML = `<i data-lucide="${state.isAnimating ? 'pause' : 'play'}" class="w-5 h-5"></i>`;
                loadIcons();
                if (state.isAnimating) animate(); else cancelAnimationFrame(state.animationId);
            }
            function animate() {
                if (!state.isAnimating) return;
                state.angle = (state.angle + 0.5) % 360;
                dom.angleSlider.value = state.angle; 
                updateValues();
                draw();
                state.animationId = requestAnimationFrame(animate);
            }

            function addCanvasListeners() {
                const getPos = (e, i=0) => ({ x: (e.touches ? e.touches[i].clientX : e.clientX) - dom.canvas.getBoundingClientRect().left, y: (e.touches ? e.touches[i].clientY : e.clientY) - dom.canvas.getBoundingClientRect().top });
                dom.canvas.addEventListener('mousedown', e => { state.isDragging = true; const pos = getPos(e); state.panStart = { x: pos.x - state.panOffset.x, y: pos.y - state.panOffset.y }; });
                dom.canvas.addEventListener('mousemove', e => { if (state.isDragging) { const pos = getPos(e); state.panOffset = { x: pos.x - state.panStart.x, y: pos.y - state.panStart.y }; draw(); } });
                dom.canvas.addEventListener('mouseup', () => state.isDragging = false);
                dom.canvas.addEventListener('mouseleave', () => state.isDragging = false);
                dom.canvas.addEventListener('wheel', e => { e.preventDefault(); const zoom = e.deltaY < 0 ? 1.1 : 1/1.1; state.scale = Math.max(40, Math.min(600, state.scale * zoom)); draw(); }, { passive: false });
                let touchStartPos = null, touchStartTime = 0, isPinch = false;
                dom.canvas.addEventListener('touchstart', e => {
                    if (e.touches.length === 1) { isPinch = false; state.isDragging = true; touchStartPos = getPos(e); touchStartTime = Date.now(); state.panStart = { x: touchStartPos.x - state.panOffset.x, y: touchStartPos.y - state.panOffset.y }; } 
                    else if (e.touches.length === 2) { isPinch = true; state.isDragging = false; const p1 = getPos(e,0), p2 = getPos(e,1); state.lastPinchDistance = Math.hypot(p1.x - p2.x, p1.y - p2.y); }
                }, { passive: true });
                dom.canvas.addEventListener('touchmove', e => {
                    if (isPinch && e.touches.length === 2) { const p1 = getPos(e,0), p2 = getPos(e,1); const dist = Math.hypot(p1.x - p2.x, p1.y - p2.y); if (state.lastPinchDistance > 0) { const zoom = dist / state.lastPinchDistance; state.scale = Math.max(40, Math.min(600, state.scale * zoom)); } state.lastPinchDistance = dist; draw(); } 
                    else if (state.isDragging && e.touches.length === 1) { const pos = getPos(e); state.panOffset = { x: pos.x - state.panStart.x, y: pos.y - state.panStart.y }; draw(); }
                }, { passive: true });
                dom.canvas.addEventListener('touchend', e => {
                    if (!isPinch && (Date.now() - touchStartTime < 250) && (Math.hypot(getPos(e.changedTouches[0]).x - touchStartPos.x, getPos(e.changedTouches[0]).y - touchStartPos.y) < 10)) {
                        const rect = dom.canvas.getBoundingClientRect(), centerX = rect.width / 2 + state.panOffset.x, centerY = rect.height / 2 + state.panOffset.y;
                        let angle = Math.atan2(centerY - touchStartPos.y, touchStartPos.x - centerX) * 180 / Math.PI;
                        if (angle < 0) angle += 360;
                        state.angle = Math.round(angle); dom.angleSlider.value = state.angle; updateValues(); draw();
                    }
                    if (e.touches.length < 2) isPinch = false;
                    if (e.touches.length < 1) state.isDragging = false;
                });
            }

            // --- INICIALIZACIÓN ---
            function loadIcons() { if (typeof lucide !== 'undefined') lucide.createIcons(); else setTimeout(loadIcons, 100); }
            window.addEventListener('resize', setupCanvas);
            dom.angleSlider.addEventListener('input', e => { state.angle = parseInt(e.target.value); updateValues(); draw(); });
            dom.radiusSlider.addEventListener('input', e => { state.radius = parseFloat(e.target.value); updateValues(); draw(); });
            document.querySelectorAll('.angle-button').forEach(btn => btn.addEventListener('click', () => { state.angle = parseInt(btn.dataset.angle); dom.angleSlider.value = state.angle; updateValues(); draw(); }));
            
            // UPDATED: El botón de inicio ahora usa la escala adaptable
            dom.homeBtn.addEventListener('click', () => { 
                Object.assign(state, { 
                    panOffset: { x: 0, y: 0 }, 
                    scale: getInitialScale(), 
                    angle: 45, 
                    radius: 1.0 
                }); 
                dom.angleSlider.value = 45; 
                dom.radiusSlider.value = 1.0; 
                updateValues(); 
                draw(); 
            });

            dom.animateBtn.addEventListener('click', toggleAnimation);
            dom.legendBtn.addEventListener('click', () => openModal(dom.legendModal));
            dom.closeLegendBtn.addEventListener('click', () => closeModal(dom.legendModal));
            dom.helpModalBtn.addEventListener('click', () => openModal(dom.helpModal));
            dom.closeHelpBtn.addEventListener('click', () => closeModal(dom.helpModal));
            dom.themeToggleBtn.addEventListener('click', () => applyTheme(document.documentElement.classList.contains('dark') ? 'light' : 'dark'));
            addCanvasListeners();
            window.addEventListener('load', () => { applyTheme(localStorage.getItem('theme') || 'light'); setupCanvas(); updateValues(); loadIcons(); });
        });
    </script>
</body>
</html>
