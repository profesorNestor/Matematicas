<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Series de Taylor y Maclaurin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/12.4.1/math.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" id="MathJax-script" async></script>
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/nerdamer.core.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/Calculus.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap');
        
        :root {
            --bg-dark: #020617;
            --bg-panel: rgba(15, 23, 42, 0.6);
            --glass-border: rgba(56, 189, 248, 0.2);
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --accent-primary: #22d3ee;
            --accent-glow: rgba(34, 211, 238, 0.5);
            --shadow-color: rgba(0, 0, 0, 0.5);
        }

        html, body {
            height: 100%;
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            overflow: hidden;
        }

        #particle-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            opacity: 0.3;
        }

        .app-container {
            position: relative;
            z-index: 1;
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 1.5rem;
            height: 100vh;
            padding: 1.5rem;
        }

        .glass-panel {
            background: var(--bg-panel);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: 0 8px 32px var(--shadow-color);
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding: 1.5rem;
            overflow-y: auto;
        }

        .main-content {
            display: flex;
            flex-direction: column;
        }

        .panel-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            text-shadow: 0 0 10px var(--accent-glow);
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .modern-input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
            outline: none;
        }

        .modern-input:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 15px var(--accent-glow);
        }

        .action-button {
            background: linear-gradient(135deg, var(--accent-primary) 0%, #0ea5e9 100%);
            color: var(--bg-dark);
            font-weight: 700;
            padding: 14px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(34, 211, 238, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .action-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px var(--accent-glow);
        }
        
        .slider-group {
            padding: 1rem 0.5rem;
        }
        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 4px;
            background: var(--glass-border);
            outline: none;
            border-radius: 2px;
            transition: opacity .2s;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--accent-primary);
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 0 10px var(--accent-glow);
        }
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--accent-primary);
            cursor: pointer;
            border-radius: 50%;
        }

        .graph-container {
            flex-grow: 1;
            position: relative;
            background: rgba(0,0,0,0.3);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid var(--glass-border);
        }
        #canvas {
            width: 100%;
            height: 100%;
            cursor: grab;
        }
        #canvas:active { cursor: grabbing; }

        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(2, 6, 23, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center; justify-content: center;
            z-index: 1000; padding: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.active { display: flex; opacity: 1; }
        
        .modal-content {
            background: var(--bg-panel);
            padding: 2rem;
            border-radius: 24px;
            border: 1px solid var(--glass-border);
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            box-shadow: 0 10px 40px var(--shadow-color);
            display: flex;
            flex-direction: column;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        #formulas-content {
            font-size: 1.1rem;
            line-height: 2.5;
            overflow: auto;
            padding-right: 1rem;
        }
        #formulas-content h3 {
            font-size: 1.5rem;
            color: var(--accent-primary);
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 0.5rem;
        }
        
        .loading-spinner {
            width: 50px; height: 50px;
            border: 4px solid var(--glass-border);
            border-top: 4px solid var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 0.75rem;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            transition: background 0.2s ease;
        }
        .collapsible-header:hover {
            background: rgba(0,0,0,0.4);
        }
        .collapsible-title {
            font-weight: 600;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .collapsible-icon {
            transition: transform 0.3s ease-out;
            font-style: normal;
        }
        .collapsible-content {
            padding: 1rem 0.5rem 0.5rem;
            display: none;
        }
        .color-control {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .modern-color-picker {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 32px;
            height: 32px;
            background-color: transparent;
            border: none;
            cursor: pointer;
        }
        .modern-color-picker::-webkit-color-swatch {
            border-radius: 50%;
            border: 2px solid var(--glass-border);
        }
        .modern-color-picker::-moz-color-swatch {
            border-radius: 50%;
            border: 2px solid var(--glass-border);
        }

        @media (max-width: 1024px) {
            .app-container {
                grid-template-columns: 1fr;
                height: auto;
                padding: 1rem;
            }
            html, body { overflow: auto; }
            .control-panel { order: 2; }
            .main-content { order: 1; min-height: 60vh; }
        }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--glass-border); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-primary); }
    </style>
</head>
<body>
    <canvas id="particle-canvas"></canvas>

    <div class="app-container">
        <!-- Panel de Control (Izquierda) -->
        <aside class="glass-panel control-panel">
            <h1 class="panel-title text-2xl">Series de Taylor</h1>
            
            <div class="input-group">
                <div class="collapsible-header">
                    <span class="collapsible-title"> Paleta de Colores</span>
                    <i class="collapsible-icon">+</i>
                </div>
                <div class="collapsible-content">
                    <div class="color-control">
                        <label>Funci贸n Original</label>
                        <input type="color" id="original-color-picker" class="modern-color-picker" value="#ffc700">
                    </div>
                    <div class="color-control">
                        <label>Polinomio de Taylor</label>
                        <input type="color" id="series-color-picker" class="modern-color-picker" value="#22d3ee">
                    </div>
                </div>
            </div>
            
            <div id="normal-input-container">
                <div class="input-group">
                    <label for="function-input" class="input-label">Funci贸n f(x)</label>
                    <input type="text" class="modern-input" id="function-input" placeholder="Ej: sin(x), exp(x), log(x+1)" value="sin(x)">
                </div>
                 <div class="input-group">
                    <label for="expansion-point" class="input-label">Punto de Expansi贸n (a)</label>
                    <input type="number" class="modern-input" id="expansion-point" value="0" step="0.1">
                </div>
            </div>

            <div class="input-group slider-group">
                <div class="flex justify-between items-center mb-2">
                    <label for="terms-slider" class="input-label mb-0">N煤mero de T茅rminos (N)</label>
                    <span id="terms-value" class="font-bold text-lg text-accent-primary">5</span>
                </div>
                <input type="range" min="0" max="20" value="5" class="slider" id="terms-slider">
            </div>

            <div class="flex gap-4 mt-2">
                <button id="calculate-button" class="action-button w-full">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>
                    <span>Calcular</span>
                </button>
                <button id="show-formulas-btn" class="action-button w-full" style="background: var(--bg-panel); color: var(--text-primary); display:none;">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="8" y2="9"></line></svg>
                    <span>F贸rmulas</span>
                </button>
            </div>
            
            <div id="status-container" class="text-center text-sm text-text-secondary mt-4 h-5"></div>

            <div class="mt-auto pt-4 border-t border-glass-border">
                <h3 class="panel-title text-lg">Coeficientes Calculados</h3>
                <div class="h-48 overflow-y-auto pr-2" id="coefficients-container">
                    <p class="text-center text-text-secondary text-sm">Los coeficientes aparecer谩n aqu铆...</p>
                </div>
            </div>
        </aside>

        <!-- Panel Principal (Derecha) -->
        <main class="main-content">
            <div class="graph-container">
                <canvas id="canvas"></canvas>
            </div>
        </main>
    </div>
    
    <!-- Modal para F贸rmulas -->
    <div id="formulas-modal" class="modal-overlay">
        <div class="modal-content">
            <div id="formulas-content"></div>
            <button id="close-formulas-modal" class="action-button mt-6 self-center">Cerrar</button>
        </div>
    </div>
    
    <!-- Modal para Carga -->
    <div id="loading-modal" class="modal-overlay">
        <div class="loading-spinner"></div>
    </div>

    <script>
    // --- PARTICLE ANIMATION ---
    const particleCanvas = document.getElementById('particle-canvas');
    const particleCtx = particleCanvas.getContext('2d');
    let particles = [];
    
    function setupParticleCanvas() {
        particleCanvas.width = window.innerWidth;
        particleCanvas.height = window.innerHeight;
    }
    setupParticleCanvas();

    class Particle {
        constructor(x, y, dirX, dirY, size, color) {
            this.x = x; this.y = y; this.dirX = dirX; this.dirY = dirY;
            this.size = size; this.color = color;
        }
        draw() {
            particleCtx.beginPath();
            particleCtx.arc(this.x, this.y, this.size, 0, Math.PI * 2, false);
            particleCtx.fillStyle = this.color;
            particleCtx.fill();
        }
        update() {
            if (this.x > particleCanvas.width || this.x < 0) this.dirX = -this.dirX;
            if (this.y > particleCanvas.height || this.y < 0) this.dirY = -this.dirY;
            this.x += this.dirX; this.y += this.dirY;
            this.draw();
        }
    }

    function initParticles() {
        particles = [];
        let numParticles = (particleCanvas.height * particleCanvas.width) / 30000;
        for (let i = 0; i < numParticles; i++) {
            let size = Math.random() * 2 + 1;
            let x = Math.random() * (innerWidth - size * 2) + size * 2;
            let y = Math.random() * (innerHeight - size * 2) + size * 2;
            let dirX = (Math.random() * 0.4) - 0.2;
            let dirY = (Math.random() * 0.4) - 0.2;
            let color = 'rgba(34, 211, 238, ' + (Math.random() * 0.5) + ')';
            particles.push(new Particle(x, y, dirX, dirY, size, color));
        }
    }

    function animateParticles() {
        requestAnimationFrame(animateParticles);
        particleCtx.clearRect(0, 0, innerWidth, innerHeight);
        particles.forEach(p => p.update());
    }
    initParticles();
    animateParticles();
    window.addEventListener('resize', () => {
        setupParticleCanvas();
        initParticles();
    });

    // --- TAYLOR SERIES SCRIPT ---
    document.addEventListener('DOMContentLoaded', () => {
        const dom = {
            canvas: document.getElementById('canvas'),
            functionInput: document.getElementById('function-input'),
            expansionPointInput: document.getElementById('expansion-point'),
            termsSlider: document.getElementById('terms-slider'),
            termsValue: document.getElementById('terms-value'),
            calculateButton: document.getElementById('calculate-button'),
            showFormulasBtn: document.getElementById('show-formulas-btn'),
            closeFormulasModal: document.getElementById('close-formulas-modal'),
            formulasModal: document.getElementById('formulas-modal'),
            formulasContent: document.getElementById('formulas-content'),
            loadingModal: document.getElementById('loading-modal'),
            statusContainer: document.getElementById('status-container'),
            coefficientsContainer: document.getElementById('coefficients-container'),
            originalColorPicker: document.getElementById('original-color-picker'),
            seriesColorPicker: document.getElementById('series-color-picker'),
        };

        const ctx = dom.canvas.getContext('2d');
        let taylorData = []; // Almacenar谩 { derivative: string, value: number, coeff: number }
        
        let view = {
            zoomX: 50, zoomY: 50, offsetX: 0, offsetY: 0,
            isDragging: false, isScaling: false, scalingAxis: 'none',
            hoveringAxis: 'none', lastX: 0, lastY: 0
        };

        let redrawQueued = false;
        let originalFunctionColor = dom.originalColorPicker.value;
        let seriesColor = dom.seriesColorPicker.value;

        // --- Initialization ---
        function initialize() {
            setupMainCanvas();
            addEventListeners();
            dom.calculateButton.click(); // Initial calculation
        }

        function setupMainCanvas() {
            const dpr = window.devicePixelRatio || 1;
            const rect = dom.canvas.parentElement.getBoundingClientRect();
            dom.canvas.width = rect.width * dpr;
            dom.canvas.height = rect.height * dpr;
            dom.canvas.style.width = `${rect.width}px`;
            dom.canvas.style.height = `${rect.height}px`;
        }

        function addEventListeners() {
            window.addEventListener('resize', () => {
                setupMainCanvas();
                requestRedraw();
            });
            
            dom.calculateButton.addEventListener('click', handleCalculation);
            dom.termsSlider.addEventListener('input', () => {
                dom.termsValue.textContent = dom.termsSlider.value;
                requestRedraw();
            });

            document.querySelectorAll('.collapsible-header').forEach(header => {
                header.addEventListener('click', () => {
                    const content = header.nextElementSibling;
                    const icon = header.querySelector('.collapsible-icon');
                    const isHidden = content.style.display === 'none' || content.style.display === '';
                    content.style.display = isHidden ? 'block' : 'none';
                    icon.style.transform = isHidden ? 'rotate(45deg)' : 'rotate(0deg)';
                });
            });

            dom.originalColorPicker.addEventListener('input', (e) => {
                originalFunctionColor = e.target.value;
                requestRedraw();
            });
            dom.seriesColorPicker.addEventListener('input', (e) => {
                seriesColor = e.target.value;
                requestRedraw();
            });

            // Eventos del Canvas para interactividad
            dom.canvas.addEventListener('mousedown', e => {
                if (view.hoveringAxis !== 'none') {
                    view.isScaling = true;
                    view.scalingAxis = view.hoveringAxis;
                    view.isDragging = false;
                } else {
                    view.isDragging = true;
                    view.isScaling = false;
                }
                view.lastX = e.offsetX;
                view.lastY = e.offsetY;
            });

            dom.canvas.addEventListener('mousemove', e => {
                const AXIS_HOVER_THRESHOLD = 10;
                const logicalMouseX = e.offsetX;
                const logicalMouseY = e.offsetY;

                if (view.isScaling) {
                    const worldCoords = screenToWorld(logicalMouseX, logicalMouseY);
                    const dx = logicalMouseX - view.lastX;
                    const dy = logicalMouseY - view.lastY;

                    if (view.scalingAxis === 'x') {
                        const scaleFactor = 1 - (dx * 0.01);
                        view.zoomX *= scaleFactor;
                        dom.canvas.style.cursor = 'ew-resize';
                    } else if (view.scalingAxis === 'y') {
                        const scaleFactor = 1 - (dy * 0.01);
                        view.zoomY *= scaleFactor;
                        dom.canvas.style.cursor = 'ns-resize';
                    }
                    
                    const newWorldCoords = screenToWorld(logicalMouseX, logicalMouseY);
                    view.offsetX += worldCoords.x - newWorldCoords.x;
                    view.offsetY += worldCoords.y - newWorldCoords.y;

                    view.lastX = logicalMouseX;
                    view.lastY = logicalMouseY;
                    requestRedraw();

                } else if (view.isDragging) {
                    const dx = logicalMouseX - view.lastX;
                    const dy = logicalMouseY - view.lastY;
                    view.offsetX += dx / view.zoomX;
                    view.offsetY -= dy / view.zoomY;
                    view.lastX = logicalMouseX;
                    view.lastY = logicalMouseY;
                    dom.canvas.style.cursor = 'grabbing';
                    requestRedraw();
                } else {
                    const origin = worldToScreen(0, 0);
                    if (Math.abs(logicalMouseY - origin.y) < AXIS_HOVER_THRESHOLD) {
                        view.hoveringAxis = 'x';
                        dom.canvas.style.cursor = 'ew-resize';
                    } else if (Math.abs(logicalMouseX - origin.x) < AXIS_HOVER_THRESHOLD) {
                        view.hoveringAxis = 'y';
                        dom.canvas.style.cursor = 'ns-resize';
                    } else {
                        view.hoveringAxis = 'none';
                        dom.canvas.style.cursor = 'grab';
                    }
                }
            });
            
            dom.canvas.addEventListener('mouseup', () => { view.isDragging = false; view.isScaling = false; });
            dom.canvas.addEventListener('mouseleave', () => { view.isDragging = false; view.isScaling = false; dom.canvas.style.cursor = 'grab'; });

            dom.canvas.addEventListener('wheel', e => {
                e.preventDefault();
                const worldCoords = screenToWorld(e.offsetX, e.offsetY);
                const zoomFactor = e.deltaY < 0 ? 1.1 : 0.9;
                view.zoomX *= zoomFactor;
                view.zoomY *= zoomFactor;
                const newWorldCoords = screenToWorld(e.offsetX, e.offsetY);
                view.offsetX += worldCoords.x - newWorldCoords.x;
                view.offsetY += worldCoords.y - newWorldCoords.y;
                requestRedraw();
            });
            
            dom.showFormulasBtn.addEventListener('click', () => dom.formulasModal.classList.add('active'));
            dom.closeFormulasModal.addEventListener('click', () => dom.formulasModal.classList.remove('active'));
            dom.formulasModal.addEventListener('click', e => {
                if (e.target === dom.formulasModal) dom.formulasModal.classList.remove('active');
            });
        }
        
        function factorial(n) {
            if (n === 0 || n === 1) return 1;
            let result = 1;
            for (let i = 2; i <= n; i++) {
                result *= i;
            }
            return result;
        }

        async function handleCalculation() {
            dom.loadingModal.classList.add('active');
            dom.statusContainer.textContent = "Calculando derivadas...";
            await new Promise(resolve => setTimeout(resolve, 50));

            try {
                const funcStr = dom.functionInput.value;
                const a = parseFloat(dom.expansionPointInput.value);
                const maxTerms = 20;
                
                taylorData = [];
                let currentDerivative = funcStr;

                for (let n = 0; n <= maxTerms; n++) {
                    // Evaluar la derivada en el punto 'a'
                    const derivativeValue = math.evaluate(currentDerivative.toString(), {x: a, pi: Math.PI, e: Math.E});
                    
                    // Calcular el coeficiente de Taylor
                    const coeff = derivativeValue / factorial(n);
                    
                    taylorData.push({
                        derivative: nerdamer(currentDerivative).toTeX(),
                        value: derivativeValue,
                        coeff: coeff
                    });

                    // Calcular la siguiente derivada para la pr贸xima iteraci贸n
                    if (n < maxTerms) {
                       currentDerivative = nerdamer.diff(currentDerivative, 'x').toString();
                    }
                }
                
                displayCoefficients();
                updateFormulasDisplay(funcStr, a);
                dom.showFormulasBtn.style.display = 'flex';
                dom.statusContainer.textContent = "C谩lculo completado.";
                requestRedraw();

            } catch (error) {
                console.error("Calculation Error:", error);
                dom.statusContainer.textContent = "Error en la funci贸n o el punto.";
                taylorData = [];
                requestRedraw();
            } finally {
                dom.loadingModal.classList.remove('active');
            }
        }
        
        function requestRedraw() {
            if (!redrawQueued) {
                redrawQueued = true;
                requestAnimationFrame(() => {
                    drawScene();
                    redrawQueued = false;
                });
            }
        }

        function drawScene() {
            const dpr = window.devicePixelRatio || 1;
            const { width, height } = dom.canvas;

            ctx.save();
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.clearRect(0, 0, width, height);
            ctx.scale(dpr, dpr);

            drawGrid();

            if (taylorData.length > 0) {
                const funcStr = dom.functionInput.value;
                const evalFunc = (x) => math.evaluate(funcStr, { x, pi: Math.PI, e: Math.E });
                drawFunction(evalFunc, originalFunctionColor, 3.5);
                drawFunction(taylorPolynomial, seriesColor, 2.5);
            }

            ctx.restore();
        }

        function drawGrid() {
            const { width, height } = dom.canvas;
            const dpr = window.devicePixelRatio || 1;
            const w = width / dpr;
            const h = height / dpr;

            const { x: xMin, y: yMax } = screenToWorld(0, 0);
            const { x: xMax, y: yMin } = screenToWorld(w, h);

            ctx.strokeStyle = "rgba(56, 189, 248, 0.15)";
            ctx.lineWidth = 1;
            
            const xStep = Math.pow(10, Math.floor(Math.log10(w / view.zoomX)) - 1) * 5;
            const yStep = Math.pow(10, Math.floor(Math.log10(h / view.zoomY)) - 1) * 5;

            for (let i = Math.floor(xMin / xStep) * xStep; i <= xMax; i += xStep) {
                const sx = worldToScreen(i, 0).x;
                ctx.beginPath(); ctx.moveTo(sx, 0); ctx.lineTo(sx, h); ctx.stroke();
            }
            for (let i = Math.floor(yMin / yStep) * yStep; i <= yMax; i += yStep) {
                const sy = worldToScreen(0, i).y;
                ctx.beginPath(); ctx.moveTo(0, sy); ctx.lineTo(w, sy); ctx.stroke();
            }

            ctx.strokeStyle = "rgba(226, 232, 240, 0.8)";
            ctx.lineWidth = 2;
            const origin = worldToScreen(0, 0);
            ctx.beginPath();
            ctx.moveTo(0, origin.y); ctx.lineTo(w, origin.y);
            ctx.moveTo(origin.x, 0); ctx.lineTo(origin.x, h);
            ctx.stroke();
            
            ctx.fillStyle = "rgba(226, 232, 240, 0.9)";
            ctx.font = `${12}px Inter`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            for (let i = Math.floor(xMin / xStep) * xStep; i <= xMax; i += xStep) {
                if (Math.abs(i) < 1e-9) continue;
                ctx.fillText(i.toPrecision(2), worldToScreen(i, 0).x, origin.y + 5);
            }
            
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';
            for (let i = Math.floor(yMin / yStep) * yStep; i <= yMax; i += yStep) {
                if (Math.abs(i) < 1e-9) continue;
                const sy = worldToScreen(0, i).y;
                if (sy > 0 && sy < h) {
                    ctx.fillText(i.toPrecision(2), origin.x - 5, sy);
                }
            }
        }

        function drawFunction(evalFunc, color, lineWidth) {
            const { width } = dom.canvas;
            const dpr = window.devicePixelRatio || 1;
            const w = width / dpr;
            
            ctx.strokeStyle = color;
            ctx.lineWidth = lineWidth;
            ctx.shadowColor = color;
            ctx.shadowBlur = 10;
            ctx.beginPath();
            
            let firstPoint = true;
            for (let sx = 0; sx <= w; sx += 1) {
                const worldX = screenToWorld(sx, 0).x;
                try {
                    const worldY = evalFunc(worldX);
                    if (isFinite(worldY)) {
                        const { x, y } = worldToScreen(worldX, worldY);
                        if (firstPoint) {
                            ctx.moveTo(x, y);
                            firstPoint = false;
                        } else {
                            ctx.lineTo(x, y);
                        }
                    } else { firstPoint = true; }
                } catch (e) { firstPoint = true; }
            }
            ctx.stroke();
            ctx.shadowBlur = 0;
        }
        
        function taylorPolynomial(x) {
            const a = parseFloat(dom.expansionPointInput.value);
            const N = parseInt(dom.termsSlider.value);
            let sum = 0;
            for (let n = 0; n <= N; n++) {
                if(taylorData[n] && isFinite(taylorData[n].coeff)) {
                    sum += taylorData[n].coeff * Math.pow(x - a, n);
                }
            }
            return sum;
        }

        function displayCoefficients() {
            let html = '';
            const a = parseFloat(dom.expansionPointInput.value);
            for (let i = 0; i < 10; i++) {
                if (!taylorData[i]) break;
                const data = taylorData[i];
                let derivativeSymbol = i === 0 ? `f(${a})` : `f^{(${i})}(${a})`;
                html += `<div class="p-2 mt-2 rounded-lg bg-black/20">
                            <div><strong>${derivativeSymbol} =</strong> <span class="font-mono text-accent-primary">${data.value.toFixed(4)}</span></div>
                            <div><strong>c<sub>${i}</sub> =</strong> <span class="font-mono text-accent-primary">${data.coeff.toFixed(4)}</span></div>
                         </div>`;
            }
            dom.coefficientsContainer.innerHTML = html;
        }
        
        function updateFormulasDisplay(funcStr, a) {
            const seriesType = a === 0 ? "Maclaurin" : "Taylor";
            const a_str = a.toString();

            dom.formulasContent.innerHTML = `
                <h3>Definici贸n General (Serie de ${seriesType})</h3>
                <p>\\[ P(x) = \\sum_{n=0}^{\\infty} \\frac{f^{(n)}(a)}{n!}(x-a)^n \\]</p>
                <p>\\[ P(x) = f(a) + f'(a)(x-a) + \\frac{f''(a)}{2!}(x-a)^2 + \\dots \\]</p>
                
                <h3>C谩lculo para <span class="text-accent-primary">f(x) = ${funcStr}</span> en <span class="text-accent-primary">a = ${a_str}</span></h3>
                <div id="derivative-calcs"></div>

                <h3>Polinomio Resultante (N = ${dom.termsSlider.value})</h3>
                <p>\\[ P_{${dom.termsSlider.value}}(x) \\approx ${generateSeriesString(a_str)} \\]</p>
            `;

            let derivativeCalcsHTML = '';
            for(let n=0; n<=3; n++) {
                if(!taylorData[n]) break;
                let derivSymbol = n === 0 ? `f(x)` : `f^{(${n})}(x)`;
                let evalSymbol = n === 0 ? `f(${a_str})` : `f^{(${n})}(${a_str})`;
                derivativeCalcsHTML += `<p>\\[ ${derivSymbol} = ${taylorData[n].derivative} \\quad \\Rightarrow \\quad ${evalSymbol} = ${taylorData[n].value.toFixed(5)} \\]</p>`;
            }
            document.getElementById('derivative-calcs').innerHTML = derivativeCalcsHTML;

            if (window.MathJax) {
                MathJax.typesetPromise([dom.formulasContent]).catch(err => console.error('MathJax Error:', err));
            }
        }
        
        function generateSeriesString(a_str) {
            let str = '';
            const N = parseInt(dom.termsSlider.value);
            for (let n = 0; n <= N; n++) {
                if (!taylorData[n]) break;
                const coeff = taylorData[n].coeff;

                if (Math.abs(coeff) > 1e-6) {
                    let termStr = '';
                    // Signo
                    if (n > 0) {
                        termStr += coeff > 0 ? ' + ' : ' - ';
                    } else if (coeff < 0) {
                        termStr += ' - ';
                    }
                    
                    // Coeficiente
                    const absCoeff = Math.abs(coeff);
                    if (n === 0 || Math.abs(absCoeff - 1) > 1e-6) {
                        termStr += absCoeff.toFixed(4);
                    }
                    
                    // Parte (x-a)^n
                    if (n > 0) {
                        if (a_str === '0') {
                             termStr += `x`;
                        } else {
                             termStr += `(x - ${a_str})`;
                        }
                       
                        if (n > 1) {
                            termStr += `^${n}`;
                        }
                    }
                    str += termStr;
                }
            }
            return str.length > 0 ? str : "0";
        }

        function worldToScreen(x, y) {
            const { width, height } = dom.canvas;
            const dpr = window.devicePixelRatio || 1;
            return { 
                x: (width / dpr / 2) + (x + view.offsetX) * view.zoomX, 
                y: (height / dpr / 2) - (y - view.offsetY) * view.zoomY 
            };
        }
        function screenToWorld(sx, sy) {
            const { width, height } = dom.canvas;
            const dpr = window.devicePixelRatio || 1;
            return { 
                x: (sx - width / dpr / 2) / view.zoomX - view.offsetX,
                y: (height / dpr / 2 - sy) / view.zoomY + view.offsetY
            };
        }

        initialize();
    });
    </script>
</body>
</html>
