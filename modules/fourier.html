<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fourier Series - Ultra Modern Visualizer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" id="MathJax-script" async></script>
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/nerdamer.core.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/Algebra.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/Calculus.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@1.1.13/Solve.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --accent-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --dark-bg: #0a0a0f;
            --card-bg: rgba(15, 15, 30, 0.85);
            --glass-bg: rgba(255, 255, 255, 0.08);
            --border-color: rgba(255, 255, 255, 0.12);
            --text-primary: #e0e0e0;
            --text-secondary: #9ca3af;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--dark-bg);
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(102, 126, 234, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(245, 87, 108, 0.1) 0%, transparent 50%);
            color: var(--text-primary);
            overflow-y: auto;
        }

        .app-container {
            display: grid;
            width: 100%;
            max-width: 1800px;
            margin: 0 auto;
            grid-template-columns: 380px 1fr;
            grid-template-rows: auto 1fr;
            grid-template-areas: 
                "header header"
                "sidebar main";
            min-height: 100vh;
            gap: 20px;
            padding: 20px;
        }

        .header {
            grid-area: header;
            text-align: center;
            padding: 20px 0;
        }

        .main-title {
            font-size: 3.5rem;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            text-shadow: 0 0 40px rgba(102, 126, 234, 0.5);
            animation: titleGlow 3s ease-in-out infinite alternate;
        }

        @keyframes titleGlow {
            from { filter: brightness(1) drop-shadow(0 0 20px rgba(102, 126, 234, 0.3)); }
            to { filter: brightness(1.2) drop-shadow(0 0 30px rgba(102, 126, 234, 0.6)); }
        }

        .subtitle {
            font-size: 1.2rem;
            color: var(--text-secondary);
            font-weight: 400;
        }

        .sidebar {
            grid-area: sidebar;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            padding: 30px;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .main-content {
            grid-area: main;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .section {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .section:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.2);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .graph-container {
            flex: 1;
            position: relative;
            min-height: 500px;
            background: rgba(10, 10, 15, 0.8);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        #canvas {
            width: 100%;
            height: 100%;
            cursor: grab;
            touch-action: none; 
        }

        #canvas:active {
            cursor: grabbing;
        }

        .controls-overlay {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            font-size: 0.9rem;
            z-index: 10;
            pointer-events: none;
        }

        .function-type-selector {
            display: flex;
            gap: 12px;
            margin-bottom: 30px;
        }

        .type-btn {
            flex: 1;
            padding: 14px 18px;
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .type-btn:hover {
            background: rgba(102, 126, 234, 0.2);
            border-color: #667eea;
        }

        .type-btn.active {
            background: var(--primary-gradient);
            border-color: transparent;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .input-group {
            margin-bottom: 25px;
        }

        .input-label {
            display: block;
            margin-bottom: 10px;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.95rem;
        }

        .modern-input {
            width: 100%;
            padding: 16px 18px;
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
            outline: none;
        }

        .modern-input:focus, .modern-input.active-input-glow {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.2);
        }

        .piecewise-container {
            display: none;
            margin-top: 10px;
        }

        .piece-group {
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .piece-title {
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .piece-inputs {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }

        .piece-inputs input {
            flex: 1;
        }

        .harmonics-widget {
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .harmonics-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        .harmonics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
            min-height: 120px;
        }

        .harmonic-btn {
            width: 50px;
            height: 50px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background: var(--glass-bg);
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .harmonic-btn:hover {
            border-color: #667eea;
            color: var(--text-primary);
        }

        .harmonic-btn.active {
            background: var(--primary-gradient);
            border-color: transparent;
            color: white;
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .harmonics-controls {
            display: flex;
            gap: 12px;
        }

        .control-btn {
            flex: 1;
            padding: 10px 14px;
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: rgba(102, 126, 234, 0.2);
            border-color: #667eea;
        }

        .modern-btn {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .modern-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.4);
        }

        .modern-btn:active {
            transform: translateY(0);
        }

        .modern-btn.secondary {
            background: var(--secondary-gradient);
        }

        .coefficients-display {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .coefficient-item {
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 12px 16px;
            margin-bottom: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            transition: all 0.3s ease;
        }

        .coefficient-item:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: rgba(102, 126, 234, 0.5);
        }

        .coefficient-value {
            color: #4facfe;
            font-weight: 600;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-ready { background: var(--success-color); }
        .status-calculating { background: var(--warning-color); animation: pulse 1s infinite; }
        .status-error { background: var(--error-color); }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading-overlay, .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .loading-overlay.active, .modal-overlay.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 24px;
            border: 1px solid var(--border-color);
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        
        #formulas-content {
            font-family: 'Inter', sans-serif;
            font-size: 1.2rem;
            line-height: 2.5;
            color: var(--text-primary);
            overflow: auto;
            max-height: calc(90vh - 150px);
        }
        
        #formulas-content h3 {
            font-size: 1.5rem;
            color: var(--text-primary);
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-top: 25px;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        
        .mjx-container {
            overflow-x: auto;
            overflow-y: hidden;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--border-color);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .zoom-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 10;
        }

        .zoom-btn {
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .zoom-btn:hover {
            background: rgba(102, 126, 234, 0.3);
            border-color: #667eea;
        }
        
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 10px;
            background: var(--glass-bg);
            border-radius: 12px;
            margin-bottom: 10px;
        }
        
        .collapsible-header .section-title {
            margin: 0;
            font-size: 1.1rem;
        }
        
        .collapsible-icon {
            font-size: 1.5rem;
            transition: transform 0.3s ease;
        }
        
        .collapsible-content {
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-top: -10px;
        }
        
        .keyboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
            gap: 8px;
        }
        
        .key-btn {
            padding: 10px;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .color-control {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .color-control label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .modern-color-picker {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 40px;
            height: 40px;
            background-color: transparent;
            border: none;
            cursor: pointer;
        }
        .modern-color-picker::-webkit-color-swatch {
            border-radius: 50%;
            border: 2px solid var(--border-color);
        }
        .modern-color-picker::-moz-color-swatch {
            border-radius: 50%;
            border: 2px solid var(--border-color);
        }

        @media (max-width: 1200px) {
            .app-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr;
                grid-template-areas: 
                    "header"
                    "sidebar"
                    "main";
                padding: 10px;
                height: auto;
            }
            
            .sidebar {
                max-height: none;
                padding: 15px;
            }

            .main-title {
                font-size: 2.2rem;
            }

            .subtitle {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1 class="main-title">Fourier Series</h1>
            <p class="subtitle">Ultra Modern Interactive Visualizer & Calculator</p>
        </div>

        <div class="sidebar">
            <div class="section-title">
                <span class="status-indicator status-ready"></span>
                Configuraci√≥n de Funci√≥n
            </div>

            <div class="function-type-selector">
                <div class="type-btn active" data-type="normal">Normal</div>
                <div class="type-btn" data-type="piecewise">A Trozos</div>
            </div>

            <div class="input-group">
                <div class="collapsible-header" id="color-picker-toggle">
                    <span class="section-title">Paleta de Colores</span>
                    <span class="collapsible-icon" id="color-picker-icon">+</span>
                </div>
                <div class="collapsible-content" id="color-picker" style="display: none;">
                    <div class="color-control">
                        <label for="original-color">Funci√≥n Original</label>
                        <input type="color" id="original-color" class="modern-color-picker" value="#ff6b6b">
                    </div>
                    <div class="color-control">
                        <label for="fourier-color">Serie de Fourier</label>
                        <input type="color" id="fourier-color" class="modern-color-picker" value="#4ecdc4">
                    </div>
                </div>
            </div>

            <div class="input-group">
                <div class="collapsible-header" id="math-keyboard-toggle">
                    <span class="section-title">Teclado Matem√°tico</span>
                    <span class="collapsible-icon" id="keyboard-icon">+</span>
                </div>
                <div class="collapsible-content" id="math-keyboard" style="display: none;">
                    <div class="keyboard-grid">
                        <button class="control-btn key-btn" data-symbol="(">(</button>
                        <button class="control-btn key-btn" data-symbol=")">)</button>
                        <button class="control-btn key-btn" data-symbol="^">x ∏</button>
                        <button class="control-btn key-btn" data-symbol="sqrt()">‚àö</button>
                        <button class="control-btn key-btn" data-symbol="sin()">sin</button>
                        <button class="control-btn key-btn" data-symbol="cos()">cos</button>
                        <button class="control-btn key-btn" data-symbol="tan()">tan</button>
                        <button class="control-btn key-btn" data-symbol="pi">œÄ</button>
                        <button class="control-btn key-btn" data-symbol="e">e</button>
                    </div>
                </div>
            </div>

            <div id="normal-inputs">
                <div class="input-group">
                    <label class="input-label">Funci√≥n f(x)</label>
                    <input type="text" class="modern-input" id="function-input" placeholder="sin(x), x^2, cos(2*x)" value="x">
                </div>
            </div>

            <div id="piecewise-inputs" class="piecewise-container">
                <div class="piece-group">
                    <div class="piece-title">Trozo 1</div>
                    <input type="text" class="modern-input" id="piece1-func" placeholder="Funci√≥n" value="x">
                    <div class="piece-inputs">
                        <input type="number" class="modern-input" id="piece1-start" placeholder="Inicio" value="-3.14159">
                        <input type="number" class="modern-input" id="piece1-end" placeholder="Fin" value="0">
                    </div>
                </div>
                <div class="piece-group">
                    <div class="piece-title">Trozo 2</div>
                    <input type="text" class="modern-input" id="piece2-func" placeholder="Funci√≥n" value="-x">
                    <div class="piece-inputs">
                        <input type="number" class="modern-input" id="piece2-start" placeholder="Inicio" value="0">
                        <input type="number" class="modern-input" id="piece2-end" placeholder="Fin" value="3.14159">
                    </div>
                </div>
            </div>

            <div class="input-group">
                <label class="input-label">Per√≠odo (T)</label>
                <input type="number" class="modern-input" id="period-input" value="6.28318" step="0.1">
            </div>

            <div class="input-group">
                <label class="input-label">N√∫mero m√°ximo de t√©rminos</label>
                <input type="number" class="modern-input" id="max-terms" value="20" min="1" max="50">
            </div>

            <div class="harmonics-widget">
                <div class="harmonics-title">Arm√≥nicos a mostrar</div>
                <div class="harmonics-grid" id="harmonics-grid">
                </div>
                <div class="harmonics-controls">
                    <div class="control-btn" onclick="selectAllHarmonics()">Todos</div>
                    <div class="control-btn" onclick="clearHarmonics()">Ninguno</div>
                    <div class="control-btn" onclick="selectOddHarmonics()">Impares</div>
                </div>
            </div>

            <div style="margin-top: auto;">
                <button class="modern-btn" onclick="calculateFourier()">Calcular Serie</button>
                <button class="modern-btn secondary" onclick="resetAll()">Reiniciar</button>
                <button class="modern-btn" id="show-formulas-btn" style="display: none;">Mostrar F√≥rmulas</button>

                <div class="section-title" style="margin-top: 15px; margin-bottom: 8px;">Coeficientes de Fourier</div>
                <div class="coefficients-display" id="coefficients-container">
                    <p style="color: var(--text-secondary); text-align: center; margin: 20px 0; font-size: 0.8rem;">
                        Los coeficientes aparecer√°n aqu√≠ despu√©s del c√°lculo...
                    </p>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="section">
                <div class="section-title">Visualizaci√≥n Interactiva 2D</div>
                <div class="graph-container">
                    <canvas id="canvas"></canvas>
                    <div class="loading-overlay" id="loading-overlay">
                        <div>
                            <div class="spinner"></div>
                            <p style="margin-top: 15px; text-align: center;">Calculando...</p>
                        </div>
                    </div>
                    <div class="controls-overlay">
                        <p>üñ±Ô∏è Arrastra para mover</p>
                        <p>üîç Scroll/Pellizca para zoom</p>
                        <p>üì± Doble click/toque para centrar</p>
                    </div>
                    <div class="zoom-controls">
                        <div class="zoom-btn" onclick="zoomIn()">+</div>
                        <div class="zoom-btn" onclick="zoomOut()">‚àí</div>
                        <div class="zoom-btn" onclick="resetView()">‚åÇ</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Formulas Modal -->
    <div id="formulas-modal" class="modal-overlay">
        <div class="modal-content">
            <div id="formulas-content">
                <!-- Content is injected here by JavaScript -->
            </div>
            <button id="close-formulas-modal" class="modern-btn" style="margin-top: 20px;">Cerrar</button>
        </div>
    </div>

    <script>
        // Global variables
        let canvas, ctx;
        let currentFunction = 'normal';
        let coefficients = { a0: 0, an: [], bn: [], an_symbolic: [], bn_symbolic: [] };
        let selectedHarmonics = new Set([1, 2, 3, 4, 5]);
        let originalFunctionColor = '#ff6b6b';
        let fourierSeriesColor = '#4ecdc4';
        
        // View and gesture variables
        let zoom = 50;
        let offsetX = 0;
        let offsetY = 0;
        let isDragging = false;
        let lastDragX = 0;
        let initialPinchDistance = null;
        let redrawQueued = false;

        // DOM Elements
        let formulasModal, showFormulasBtn, closeFormulasModal, formulasContent;
        let activeInput = null;

        // Initialization
        document.addEventListener('DOMContentLoaded', function() {
            formulasModal = document.getElementById('formulas-modal');
            showFormulasBtn = document.getElementById('show-formulas-btn');
            closeFormulasModal = document.getElementById('close-formulas-modal');
            formulasContent = document.getElementById('formulas-content');

            initializeCanvas();
            initializeEventListeners();
            generateHarmonicsGrid();
        });
        
        function requestRedraw() {
            if (redrawQueued) return;
            redrawQueued = true;
            requestAnimationFrame(() => {
                drawScene();
                redrawQueued = false;
            });
        }
        
        function drawScene() {
            const dpr = window.devicePixelRatio || 1;
            
            ctx.save();
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.restore();
            
            drawGrid();
            drawFunctions();
        }

        function resizeCanvas() {
            const container = canvas.parentElement;
            const dpr = window.devicePixelRatio || 1;
            const rect = container.getBoundingClientRect();
            
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            
            canvas.style.width = `${rect.width}px`;
            canvas.style.height = `${rect.height}px`;

            ctx.scale(dpr, dpr);
            requestRedraw();
        }

        function initializeCanvas() {
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            resizeCanvas();
        }

        function initializeEventListeners() {
            window.addEventListener('resize', resizeCanvas);

            document.querySelectorAll('.type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFunction = this.dataset.type;
                    
                    document.getElementById('normal-inputs').style.display = currentFunction === 'normal' ? 'block' : 'none';
                    document.getElementById('piecewise-inputs').style.display = currentFunction === 'piecewise' ? 'block' : 'none';
                });
            });

            canvas.addEventListener('mousedown', handleDragStart);
            canvas.addEventListener('mousemove', handleDragMove);
            canvas.addEventListener('mouseup', handleDragEnd);
            canvas.addEventListener('mouseleave', handleDragEnd);
            canvas.addEventListener('wheel', handleZoom, { passive: false });
            canvas.addEventListener('dblclick', resetView);
            
            canvas.addEventListener('touchstart', handleDragStart, { passive: false });
            canvas.addEventListener('touchmove', handleDragMove, { passive: false });
            canvas.addEventListener('touchend', handleDragEnd);

            // Modal Listeners
            showFormulasBtn.addEventListener('click', () => formulasModal.classList.add('active'));
            closeFormulasModal.addEventListener('click', () => formulasModal.classList.remove('active'));
            formulasModal.addEventListener('click', (e) => {
                if (e.target === formulasModal) {
                    formulasModal.classList.remove('active');
                }
            });

            // Collapsible Panels
            document.querySelectorAll('.collapsible-header').forEach(header => {
                header.addEventListener('click', () => {
                    const content = header.nextElementSibling;
                    const icon = header.querySelector('.collapsible-icon');
                    const isHidden = content.style.display === 'none';
                    content.style.display = isHidden ? 'block' : 'none';
                    icon.style.transform = isHidden ? 'rotate(45deg)' : 'rotate(0deg)';
                });
            });

            document.querySelectorAll('.key-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (activeInput) {
                        const symbol = btn.dataset.symbol;
                        const start = activeInput.selectionStart;
                        const end = activeInput.selectionEnd;
                        const text = activeInput.value;
                        
                        let newText;
                        let newPos;

                        if (symbol.endsWith('()')) {
                            const funcName = symbol.slice(0, -2);
                            newText = text.substring(0, start) + funcName + '()' + text.substring(end);
                            newPos = start + funcName.length + 1;
                        } else {
                            newText = text.substring(0, start) + symbol + text.substring(end);
                            newPos = start + symbol.length;
                        }
                        
                        activeInput.value = newText;
                        activeInput.focus();
                        activeInput.setSelectionRange(newPos, newPos);
                    }
                });
            });

            document.querySelectorAll('.modern-input[type="text"]').forEach(input => {
                input.addEventListener('focus', (e) => {
                    activeInput = e.target;
                    document.querySelectorAll('.modern-input[type="text"]').forEach(i => i.classList.remove('active-input-glow'));
                    activeInput.classList.add('active-input-glow');
                });
            });
            
            // Color Pickers
            document.getElementById('original-color').addEventListener('input', (e) => {
                originalFunctionColor = e.target.value;
                requestRedraw();
            });
            document.getElementById('fourier-color').addEventListener('input', (e) => {
                fourierSeriesColor = e.target.value;
                requestRedraw();
            });
        }
        
        // --- Interaction Event Handlers ---

        function handleDragStart(e) {
            isDragging = true;
            canvas.style.cursor = 'grabbing';
            
            if (e.touches) {
                if (e.touches.length === 1) {
                    lastDragX = e.touches[0].clientX;
                } else if (e.touches.length === 2) {
                    initialPinchDistance = getPinchDistance(e);
                }
            } else {
                lastDragX = e.clientX;
            }
        }

        function handleDragMove(e) {
            if (!isDragging) return;
            e.preventDefault();

            if (e.touches) {
                if (e.touches.length === 1) {
                    handlePan(e.touches[0].clientX);
                } else if (e.touches.length === 2) {
                    handlePinch(e);
                }
            } else {
                handlePan(e.clientX);
            }
            
            requestRedraw();
        }

        function handleDragEnd() {
            isDragging = false;
            canvas.style.cursor = 'grab';
            initialPinchDistance = null;
        }

        function handlePan(currentX) {
            const deltaX = currentX - lastDragX;
            offsetX += deltaX / zoom;
            lastDragX = currentX;
        }
        
        function handlePinch(e) {
            const newPinchDistance = getPinchDistance(e);
            if (initialPinchDistance === null) {
                initialPinchDistance = newPinchDistance;
                return;
            }
            const zoomFactor = newPinchDistance / initialPinchDistance;
            zoom *= zoomFactor;
            zoom = Math.max(10, Math.min(500, zoom));
            initialPinchDistance = newPinchDistance;
        }

        function getPinchDistance(e) {
            const t1 = e.touches[0];
            const t2 = e.touches[1];
            return Math.sqrt(Math.pow(t1.clientX - t2.clientX, 2) + Math.pow(t1.clientY - t2.clientY, 2));
        }

        function handleZoom(e) {
            e.preventDefault();
            const zoomFactor = e.deltaY > 0 ? 0.9 : 1.1;
            zoom *= zoomFactor;
            zoom = Math.max(10, Math.min(500, zoom));
            
            requestRedraw();
        }

        function zoomIn() {
            zoom *= 1.2;
            zoom = Math.min(500, zoom);
            requestRedraw();
        }

        function zoomOut() {
            zoom *= 0.8;
            zoom = Math.max(10, zoom);
            requestRedraw();
        }

        function resetView() {
            zoom = 50;
            offsetX = 0;
            offsetY = 0;
            requestRedraw();
        }

        // --- Drawing Logic ---

        function drawGrid() {
            const dpr = window.devicePixelRatio || 1;
            const scaledWidth = canvas.width / dpr;
            const scaledHeight = canvas.height / dpr;
            
            const axisCenter = worldToScreen(0, 0);

            ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
            ctx.lineWidth = 1 / dpr;
            
            const { x: startWorldX } = screenToWorld(0, 0);
            const { x: endWorldX } = screenToWorld(scaledWidth, 0);
            const { y: startWorldY } = screenToWorld(0, scaledHeight);
            const { y: endWorldY } = screenToWorld(0, 0);
            
            const step = Math.pow(10, Math.floor(Math.log10(scaledWidth / zoom)) - 1) * 5;

            for (let i = Math.floor(startWorldX / step) * step; i <= endWorldX; i += step) {
                const sx = worldToScreen(i, 0).x;
                ctx.beginPath();
                ctx.moveTo(sx, 0);
                ctx.lineTo(sx, scaledHeight);
                ctx.stroke();
            }
            for (let i = Math.floor(startWorldY / step) * step; i <= endWorldY; i += step) {
                const sy = worldToScreen(0, i).y;
                ctx.beginPath();
                ctx.moveTo(0, sy);
                ctx.lineTo(scaledWidth, sy);
                ctx.stroke();
            }
            
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.6)';
            ctx.lineWidth = 2 / dpr;
            
            if (axisCenter.y >= 0 && axisCenter.y <= scaledHeight) {
                ctx.beginPath();
                ctx.moveTo(0, axisCenter.y);
                ctx.lineTo(scaledWidth, axisCenter.y);
                ctx.stroke();
            }
            if (axisCenter.x >= 0 && axisCenter.x <= scaledWidth) {
                ctx.beginPath();
                ctx.moveTo(axisCenter.x, 0);
                ctx.lineTo(axisCenter.x, scaledHeight);
                ctx.stroke();
            }

            ctx.fillStyle = 'rgba(255, 255, 255, 0.85)';
            ctx.font = `${12 / dpr}px Inter`;
            
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            for (let i = Math.floor(startWorldX / step) * step; i <= endWorldX; i += step) {
                if (Math.abs(i) < 1e-9) continue;
                const sx = worldToScreen(i, 0).x;
                ctx.fillText(i.toPrecision(2), sx, axisCenter.y + 5 / dpr);
            }
            
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';
            for (let i = Math.floor(startWorldY / step) * step; i <= endWorldY; i += step) {
                if (Math.abs(i) < 1e-9) continue;
                const sy = worldToScreen(0, i).y;
                if (sy > 0 && sy < scaledHeight) {
                    ctx.fillText(i.toPrecision(2), axisCenter.x - 5 / dpr, sy);
                }
            }
        }

        function worldToScreen(x, y) {
            const dpr = window.devicePixelRatio || 1;
            const scaledWidth = canvas.width / dpr;
            const scaledHeight = canvas.height / dpr;
            return { 
                x: (scaledWidth / 2) + (x + offsetX) * zoom, 
                y: (scaledHeight / 2) - (y - offsetY) * zoom 
            };
        }
        
        function screenToWorld(sx, sy) {
            const dpr = window.devicePixelRatio || 1;
            const scaledWidth = canvas.width / dpr;
            const scaledHeight = canvas.height / dpr;
            return { 
                x: (sx - scaledWidth / 2) / zoom - offsetX,
                y: (scaledHeight / 2 - sy) / zoom + offsetY
            };
        }

        function drawFunction(evalFunc, color, lineWidth = 2) {
            const dpr = window.devicePixelRatio || 1;
            const scaledWidth = canvas.width / dpr;

            ctx.strokeStyle = color;
            ctx.lineWidth = lineWidth / dpr;
            ctx.beginPath();
            
            let firstPoint = true;
            for (let sx = 0; sx <= scaledWidth; sx += 1) {
                const worldX = screenToWorld(sx, 0).x;
                const worldY = evalFunc(worldX);
                const screenPoint = worldToScreen(worldX, worldY);

                if (firstPoint) {
                    ctx.moveTo(screenPoint.x, screenPoint.y);
                    firstPoint = false;
                } else {
                    ctx.lineTo(screenPoint.x, screenPoint.y);
                }
            }
            ctx.stroke();
        }
        
        // --- UI and Calculation Logic ---
        
        function generateHarmonicsGrid() {
            const grid = document.getElementById('harmonics-grid');
            const maxTerms = parseInt(document.getElementById('max-terms').value);
            grid.innerHTML = '';
            for (let i = 1; i <= maxTerms; i++) {
                const btn = document.createElement('div');
                btn.className = 'harmonic-btn';
                btn.textContent = i;
                btn.dataset.harmonic = i;
                if (selectedHarmonics.has(i)) btn.classList.add('active');
                btn.addEventListener('click', function() {
                    const harmonic = parseInt(this.dataset.harmonic);
                    if (selectedHarmonics.has(harmonic)) {
                        selectedHarmonics.delete(harmonic);
                        this.classList.remove('active');
                    } else {
                        selectedHarmonics.add(harmonic);
                        this.classList.add('active');
                    }
                    requestRedraw();
                });
                grid.appendChild(btn);
            }
        }

        function selectAllHarmonics() {
            const maxTerms = parseInt(document.getElementById('max-terms').value);
            selectedHarmonics.clear();
            for (let i = 1; i <= maxTerms; i++) selectedHarmonics.add(i);
            updateHarmonicsUI();
            requestRedraw();
        }

        function clearHarmonics() {
            selectedHarmonics.clear();
            updateHarmonicsUI();
            requestRedraw();
        }

        function selectOddHarmonics() {
            const maxTerms = parseInt(document.getElementById('max-terms').value);
            selectedHarmonics.clear();
            for (let i = 1; i <= maxTerms; i += 2) selectedHarmonics.add(i);
            updateHarmonicsUI();
            requestRedraw();
        }

        function updateHarmonicsUI() {
            document.querySelectorAll('.harmonic-btn').forEach(btn => {
                const harmonic = parseInt(btn.dataset.harmonic);
                btn.classList.toggle('active', selectedHarmonics.has(harmonic));
            });
        }

        function evaluateFunction(func, x) {
            try {
                return math.evaluate(func, { x: x, pi: Math.PI });
            } catch (e) {
                console.error('Error evaluating function:', e);
                return 0;
            }
        }

        function evaluatePiecewiseFunction(x) {
            const piece1Start = parseFloat(document.getElementById('piece1-start').value);
            const piece1End = parseFloat(document.getElementById('piece1-end').value);
            const piece2Start = parseFloat(document.getElementById('piece2-start').value);
            const piece2End = parseFloat(document.getElementById('piece2-end').value);
            
            if (x >= piece1Start && x < piece1End) {
                return evaluateFunction(document.getElementById('piece1-func').value, x);
            } else if (x >= piece2Start && x < piece2End) {
                return evaluateFunction(document.getElementById('piece2-func').value, x);
            }
            return 0;
        }

        function fourierSeries(x) {
            if (!coefficients.an.length) return 0;
            const T = parseFloat(document.getElementById('period-input').value);
            let result = coefficients.a0 / 2;

            for (let n of selectedHarmonics) {
                if (n <= coefficients.an.length) {
                    result += coefficients.an[n-1] * Math.cos(n * 2 * Math.PI * x / T);
                    result += coefficients.bn[n-1] * Math.sin(n * 2 * Math.PI * x / T);
                }
            }
            return result;
        }

        function drawFunctions() {
            if (!coefficients.an.length) return;
            
            let originalFunc = currentFunction === 'normal' 
                ? (x) => evaluateFunction(document.getElementById('function-input').value, x)
                : evaluatePiecewiseFunction;
            
            drawFunction(originalFunc, originalFunctionColor, 3);
            drawFunction(fourierSeries, fourierSeriesColor, 2);
        }

        function calculateFourierCoefficients() {
            nerdamer.set('integration_depth', 50);
            const T = parseFloat(document.getElementById('period-input').value);
            const nTerms = parseInt(document.getElementById('max-terms').value);
            
            let evalFunc;
            let funcStr;
            if (currentFunction === 'normal') {
                funcStr = document.getElementById('function-input').value;
                evalFunc = (x) => evaluateFunction(funcStr, x);
            } else {
                funcStr = 'Funci√≥n a trozos';
                evalFunc = evaluatePiecewiseFunction;
            }

            coefficients.a0 = simpson_integration(evalFunc, T, 0, 'a0');
            
            coefficients.an = [];
            coefficients.bn = [];
            coefficients.an_symbolic = [];
            coefficients.bn_symbolic = [];

            for (let n = 1; n <= nTerms; n++) {
                let an_val, bn_val;
                let an_sym = 'C√°lculo num√©rico', bn_sym = 'C√°lculo num√©rico';

                if (currentFunction === 'normal') {
                    try {
                        const an_integrand = `(2/${T}) * (${funcStr}) * cos(n*2*pi*x/${T})`;
                        const bn_integrand = `(2/${T}) * (${funcStr}) * sin(n*2*pi*x/${T})`;
                        
                        const an_symbolic_expr = nerdamer.defint(an_integrand, 'x', -T/2, T/2);
                        an_sym = an_symbolic_expr.toTeX();
                        
                        const bn_symbolic_expr = nerdamer.defint(bn_integrand, 'x', -T/2, T/2);
                        bn_sym = bn_symbolic_expr.toTeX();

                        an_val = parseFloat(nerdamer(an_symbolic_expr).evaluate({n: n}).text());
                        bn_val = parseFloat(nerdamer(bn_symbolic_expr).evaluate({n: n}).text());

                        if(isNaN(an_val) || isNaN(bn_val)) throw new Error("Symbolic integration resulted in NaN");

                    } catch (e) {
                       console.warn(`Symbolic integration failed for n=${n}. Falling back to numeric.`, e);
                       an_val = simpson_integration(evalFunc, T, n, 'cos');
                       bn_val = simpson_integration(evalFunc, T, n, 'sin');
                       an_sym = 'C√°lculo num√©rico';
                       bn_sym = 'C√°lculo num√©rico';
                    }
                } else {
                    an_val = simpson_integration(evalFunc, T, n, 'cos');
                    bn_val = simpson_integration(evalFunc, T, n, 'sin');
                }
                
                coefficients.an.push(an_val);
                coefficients.bn.push(bn_val);
                coefficients.an_symbolic.push(an_sym);
                coefficients.bn_symbolic.push(bn_sym);
            }
        }

        function simpson_integration(fn, T, n, type) {
            const N = 1000; // Number of intervals (must be even)
            const a = -T / 2;
            const b = T / 2;
            const h = (b - a) / N;
            let sum = 0;

            for (let i = 0; i <= N; i++) {
                const x = a + i * h;
                let y;
                if (type === 'a0') {
                    y = fn(x);
                } else if (type === 'cos') {
                    y = fn(x) * Math.cos(n * 2 * Math.PI * x / T);
                } else { // sin
                    y = fn(x) * Math.sin(n * 2 * Math.PI * x / T);
                }

                if (i === 0 || i === N) {
                    sum += y;
                } else if (i % 2 !== 0) {
                    sum += 4 * y;
                } else {
                    sum += 2 * y;
                }
            }
            const integral = (h / 3) * sum;
            return type === 'a0' ? (2 / T) * integral : (2 / T) * integral;
        }

        function displayCoefficients() {
            const container = document.getElementById('coefficients-container');
            let html = `<div class="coefficient-item"><strong>a‚ÇÄ =</strong> <span class="coefficient-value">${coefficients.a0.toFixed(6)}</span></div>`;
            for (let i = 0; i < coefficients.an.length; i++) {
                html += `<div class="coefficient-item">
                            <strong>a‚Çç${i+1}‚Çé =</strong> <span class="coefficient-value">${coefficients.an[i].toFixed(6)}</span><br>
                            <strong>b‚Çç${i+1}‚Çé =</strong> <span class="coefficient-value">${coefficients.bn[i].toFixed(6)}</span>
                         </div>`;
            }
            container.innerHTML = html;
        }
        
        function updateFormulasDisplay() {
            const T_val = parseFloat(document.getElementById('period-input').value);
            const T_str = T_val.toFixed(2);
            let funcStr = document.getElementById('function-input').value;
             if (currentFunction !== 'normal') {
                funcStr = "f(x)"; // Placeholder for piecewise
            }


            let resultHTML = `
                <h3>Resultados Espec√≠ficos</h3>
                <p>\\[ a_0 = \\frac{2}{${T_str}} \\int_{-${T_str}/2}^{${T_str}/2} (${funcStr}) \\,dx = ${coefficients.a0.toFixed(4)} \\]</p>
                <p>\\[ a_n = \\frac{2}{${T_str}} \\int_{-${T_str}/2}^{${T_str}/2} (${funcStr}) \\cos\\left(\\frac{2\\pi nx}{${T_str}}\\right) \\,dx \\]</p>
                <p>Resultado para \\(a_n\\): \\( ${coefficients.an_symbolic[0] || '...'} \\) </p>
                <p>\\[ b_n = \\frac{2}{${T_str}} \\int_{-${T_str}/2}^{${T_str}/2} (${funcStr}) \\sin\\left(\\frac{2\\pi nx}{${T_str}}\\right) \\,dx \\]</p>
                 <p>Resultado para \\(b_n\\): \\( ${coefficients.bn_symbolic[0] || '...'} \\) </p>
                
                <h3>Serie Resultante para f(x)</h3>`;

            let seriesString = `f(x) \\approx ${ (coefficients.a0 / 2).toFixed(4)}`;
            for (let n = 1; n <= Math.min(coefficients.an.length, 3); n++) {
                const an = coefficients.an[n-1];
                const bn = coefficients.bn[n-1];
                
                if (Math.abs(an) > 1e-4) {
                    seriesString += ` ${an > 0 ? '+' : ''} \\left(${an.toFixed(4)}\\right) \\cos\\left(\\frac{${2*n}\\pi x}{${T_str}}\\right)`;
                }
                if (Math.abs(bn) > 1e-4) {
                    seriesString += ` ${bn > 0 ? '+' : ''} \\left(${bn.toFixed(4)}\\right) \\sin\\left(\\frac{${2*n}\\pi x}{${T_str}}\\right)`;
                }
            }
            
            if (coefficients.an.length > 3) {
                seriesString += " + \\dots";
            }
            
            resultHTML += `<p>\\[ ${seriesString} \\]</p>`;
            formulasContent.innerHTML = resultHTML;
            
            if (window.MathJax) {
                MathJax.typesetPromise([formulasContent]).catch((err) => console.log('MathJax error: ', err));
            }

            showFormulasBtn.style.display = 'inline-block';
        }

        function calculateFourier() {
            document.getElementById('loading-overlay').classList.add('active');
            document.querySelector('.status-indicator').className = 'status-indicator status-calculating';
            
            setTimeout(() => {
                try {
                    calculateFourierCoefficients();
                    displayCoefficients();
                    updateFormulasDisplay();
                    requestRedraw();
                    document.querySelector('.status-indicator').className = 'status-indicator status-ready';
                } catch (error) {
                    console.error('Error calculating Fourier series:', error);
                    document.querySelector('.status-indicator').className = 'status-indicator status-error';
                } finally {
                    document.getElementById('loading-overlay').classList.remove('active');
                }
            }, 100);
        }

        function resetAll() {
            coefficients = { a0: 0, an: [], bn: [] };
            selectedHarmonics = new Set([1, 2, 3, 4, 5]);
            document.getElementById('coefficients-container').innerHTML = 
                '<p style="color: var(--text-secondary); text-align: center; margin: 20px 0;">Los coeficientes aparecer√°n aqu√≠ despu√©s del c√°lculo...</p>';
            showFormulasBtn.style.display = 'none';
            formulasContent.innerHTML = '';
            generateHarmonicsGrid();
            resetView();
            document.querySelector('.status-indicator').className = 'status-indicator status-ready';
        }

        document.getElementById('max-terms').addEventListener('change', generateHarmonicsGrid);
    </script>
</body>
</html>
